<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng kê công nợ phải trả</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/css/toast@1.0.1/fuiToast.min.css">
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/js/toast@1.0.1/fuiToast.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.4s ease-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                    },
                },
            },
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Choices.js Customization */
        .choices__list--multiple .choices__item {
            background-color: #0ea5e9;
            border: 1px solid #0ea5e9;
        }

        .choices__list--multiple .choices__item.is-highlighted {
            background-color: #0284c7;
            border: 1px solid #0284c7;
        }

        .choices__inner {
            min-height: 44px;
            background-color: #fff;
            border-radius: 0.375rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .is-focused .choices__inner,
        .is-open .choices__inner {
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
        }

        .choices__input {
            background-color: transparent;
        }

        /* Card hover effect */
        .hover-card {
            transition: all 0.3s ease;
        }

        .hover-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Table styles */
        .table-container {
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .data-table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }

        .data-table th {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th:first-child {
            position: sticky;
            left: 0;
            z-index: 20;
        }

        .data-table td:first-child {
            position: sticky;
            left: 0;
            background-color: #f8fafc;
            z-index: 5;
        }

        /* Input focus */
        .custom-input:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
        }

        .animate-fade-out {
            animation: fadeOut 0.3s ease-out;
            opacity: 0;
        }

        #loadingOverlay {
            z-index: 9999;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <div id="fui-toast"></div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay"
        class="fixed inset-0 bg-gray-800/70 backdrop-blur-sm z-50 flex justify-center items-center hidden transition-opacity duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl flex flex-col items-center animate-slide-up">
            <div class="animate-spin text-primary-600 mb-4">
                <i class="fas fa-circle-notch text-5xl"></i>
            </div>
            <p class="text-gray-700 font-medium text-lg" id="loadingText">Đang xử lý...</p>
        </div>
    </div>

    <!-- Page Container -->
    <div class="mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                <div class="flex items-center space-x-4">
                    <div class="bg-primary-600 text-white p-3 rounded-lg shadow-lg">
                        <i class="fas fa-file-invoice-dollar text-xl"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-gray-800">Bảng kê công nợ phải trả</h1>
                </div>
            </div>

            <!-- Progress Steps -->
            <div class="mt-8 mb-4">
                <div class="flex items-center justify-between w-full max-w-4xl mx-auto">
                    <div class="flex flex-col items-center">
                        <div class="w-10 h-10 bg-primary-600 text-white flex items-center justify-center rounded-full">
                            <i class="fas fa-edit"></i>
                        </div>
                        <span class="mt-2 text-sm font-medium text-gray-700">Khai báo</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-200 mx-2">
                        <div class="h-1 bg-primary-500" style="width: 0%;" id="progress1"></div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-10 h-10 bg-gray-300 text-gray-600 flex items-center justify-center rounded-full"
                            id="step2">
                            <i class="fas fa-table"></i>
                        </div>
                        <span class="mt-2 text-sm font-medium text-gray-500">Chi phí</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-200 mx-2">
                        <div class="h-1 bg-primary-500" style="width: 0%;" id="progress2"></div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div class="w-10 h-10 bg-gray-300 text-gray-600 flex items-center justify-center rounded-full"
                            id="step3">
                            <i class="fas fa-save"></i>
                        </div>
                        <span class="mt-2 text-sm font-medium text-gray-500">Lưu trữ</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Form nhập liệu thông tin bảng kê công nợ phải trả -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8 hover-card animate-fade-in">
                <div class="flex items-center border-b border-gray-200 pb-4 mb-5">
                    <div class="bg-primary-100 text-primary-700 p-2 rounded-lg mr-3">
                        <i class="fas fa-file-invoice text-xl"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-800">Thông tin bảng kê công nợ</h2>
                </div>

                <form id="bangKeForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Mã bảng kê công nợ phải
                            trả</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i class="fas fa-barcode text-gray-400"></i>
                            </div>
                            <div class="flex">
                                <input type="text" id="maBangKe"
                                    class="custom-input w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-l-lg shadow-sm bg-white"
                                    placeholder="Nhập hoặc chọn mã bảng kê">
                                <div class="inline-block relative">
                                    <button type="button" id="bangKeDropdownBtn"
                                        class="h-full px-3 py-2.5 bg-gray-100 text-gray-700 border border-l-0 border-gray-300 rounded-r-lg hover:bg-gray-200 transition duration-200 flex items-center">
                                        <i class="fas fa-chevron-down"></i>
                                    </button>
                                    <div id="bangKeDropdown"
                                        class="hidden absolute right-0 mt-1 w-72 max-h-60 overflow-y-auto bg-white border border-gray-300 rounded-lg shadow-lg z-50">
                                        <input type="text" id="bangKeSearch"
                                            class="w-full p-2 border-b border-gray-300 rounded-t-lg"
                                            placeholder="Tìm kiếm...">
                                        <ul id="bangKeList" class="py-1">
                                            <!-- Các mã bảng kê sẽ được thêm vào đây bởi JavaScript -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Nhà cung cấp -->
                    <!-- Thay đổi trong phần HTML - Loại bỏ dấu * bên cạnh "Nhà cung cấp" -->
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Nhà cung cấp</label>
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <select id="nhaCungCap" class="choices-select">
                                    <option value="">-- Chọn nhà cung cấp --</option>
                                </select>
                            </div>
                            <button type="button" id="btnThemNhaCungCap"
                                class="px-3 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Trạng thái duyệt</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i class="fas fa-check-circle text-gray-400"></i>
                            </div>
                            <select id="trangThaiDuyet"
                                class="custom-input w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg shadow-sm bg-white appearance-none">
                                <option value="Chưa duyệt">Chưa duyệt</option>
                                <option value="Đã duyệt">Đã duyệt</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Người duyệt</label>
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <select id="nguoiDuyet" class="choices-select">
                                    <option value="">-- Chọn người duyệt --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Ngày chi</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i class="fas fa-calendar-alt text-gray-400"></i>
                            </div>
                            <input type="date" id="ngayChi"
                                class="custom-input w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg shadow-sm bg-white">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Người chi</label>
                        <div class="flex gap-2">
                            <div class="relative flex-1">
                                <select id="nguoiChi" class="choices-select">
                                    <option value="">-- Chọn người chi --</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Ngày tạo <span
                                class="text-red-500">*</span></label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i class="fas fa-calendar-check text-gray-400"></i>
                            </div>
                            <input type="date" id="ngayTao"
                                class="custom-input w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg shadow-sm bg-white"
                                required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1.5">Tổng chi phí</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i class="fas fa-money-bill-wave text-gray-400"></i>
                            </div>
                            <input type="text" id="tongChiPhi"
                                class="custom-input w-full pl-10 pr-3 py-2.5 border border-gray-300 rounded-lg shadow-sm bg-white"
                                readonly>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="text-gray-500 text-sm">VNĐ</span>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-4 flex justify-end mt-4 space-x-3">
                        <button type="button" id="resetFormBtn"
                            class="px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-200 flex items-center">
                            <i class="fas fa-redo-alt mr-2"></i> Làm mới
                        </button>
                        <button type="button" id="importBtn"
                            class="px-4 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center">
                            <i class="fas fa-file-import mr-2"></i> Nhập dữ liệu
                        </button>
                        <button type="button" id="btnTaoChiTiet"
                            class="px-4 py-2.5 bg-gradient-to-r from-amber-500 to-yellow-600 text-white rounded-lg hover:from-amber-600 hover:to-yellow-700 shadow-md hover:shadow-lg transition duration-200 flex items-center">
                            <i class="fas fa-table mr-2"></i> Tạo chi phí
                        </button>
                    </div>
                </form>
            </div>

            <!-- Bảng chi tiết chi phí sản xuất -->
            <div id="chiTietSection" class="bg-white p-6 rounded-xl shadow-md mb-8 hidden animate-fade-in">
                <div class="flex items-center justify-between border-b border-gray-200 pb-4 mb-5">
                    <div class="flex items-center">
                        <div class="bg-primary-100 text-primary-700 p-2 rounded-lg mr-3">
                            <i class="fas fa-table-list text-xl"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800">Chi tiết chi phí sản xuất</h2>
                    </div>
                </div>

                <div class="table-container rounded-lg border border-gray-200 mb-5">
                    <table id="chiTietTable" class="data-table min-w-full bg-white">
                        <thead id="chiTietTableHead">
                            <tr>
                                <th
                                    class="py-3 px-4 border-b border-gray-300 bg-gradient-to-r from-blue-50 to-blue-100 font-medium text-gray-700 sticky top-0 w-10">
                                    <i class="fas fa-edit text-gray-400"></i>
                                </th>
                                <th
                                    class="py-3 px-4 border-b border-gray-300 bg-gradient-to-r from-blue-50 to-blue-100 font-medium text-gray-700 sticky top-0">
                                    Mã đơn hàng</th>
                                <th
                                    class="py-3 px-4 border-b border-gray-300 bg-gradient-to-r from-blue-50 to-blue-100 font-medium text-gray-700 sticky top-0">
                                    Tên hàng hóa</th>
                                <th
                                    class="py-3 px-4 border-b border-gray-300 bg-gradient-to-r from-blue-50 to-blue-100 font-medium text-gray-700 sticky top-0">
                                    Hình thức chi</th>
                                <th
                                    class="py-3 px-4 border-b border-gray-300 bg-gradient-to-r from-blue-50 to-blue-100 font-medium text-gray-700 sticky top-0">
                                    Loại chi phí</th>
                                <th
                                    class="py-3 px-4 border-b border-gray-300 bg-gradient-to-r from-blue-50 to-blue-100 font-medium text-gray-700 sticky top-0">
                                    Phương thức thanh toán</th>
                                <th
                                    class="py-3 px-4 border-b border-gray-300 bg-gradient-to-r from-blue-50 to-blue-100 font-medium text-gray-700 sticky top-0">
                                    Người đề xuất chi</th>
                                <th
                                    class="py-3 px-4 border-b border-gray-300 bg-gradient-to-r from-blue-50 to-blue-100 font-medium text-gray-700 sticky top-0">
                                    Ngày chi</th>
                                <th
                                    class="py-3 px-4 border-b border-gray-300 bg-gradient-to-r from-blue-50 to-blue-100 font-medium text-gray-700 sticky top-0">
                                    Số tiền chi</th>
                                <th
                                    class="py-3 px-4 border-b border-gray-300 bg-gradient-to-r from-blue-50 to-blue-100 font-medium text-gray-700 sticky top-0 w-10">
                                    <i class="fas fa-trash text-gray-400"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="chiTietTableBody">
                            <!-- Rows will be added here -->
                        </tbody>
                    </table>
                </div>

                <div class="flex justify-end space-x-3">
                    <span id="dataStatusText" class="text-sm text-gray-500 self-center mr-auto"></span>
                    <button type="button" id="cancelBtn"
                        class="px-4 py-2.5 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-200 flex items-center">
                        <i class="fas fa-times mr-2"></i> Hủy
                    </button>
                    <button type="button" id="saveAll"
                        class="px-5 py-2.5 bg-gradient-to-r from-blue-500 to-blue-700 text-white rounded-lg hover:from-blue-600 hover:to-blue-800 shadow-md hover:shadow-lg transition duration-200 flex items-center">
                        <i class="fas fa-save mr-2"></i> Lưu tất cả
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Thêm Nhà Cung Cấp -->
    <div id="nhaCungCapModal" class="fixed inset-0 bg-gray-800/70 backdrop-blur-sm z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 sm:p-0">
            <div class="relative w-full max-w-4xl p-6 mx-auto my-8 bg-white rounded-2xl shadow-xl">
                <div class="flex items-center justify-between border-b border-gray-200 pb-4 mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Thêm nhà cung cấp mới</h3>
                    <button type="button" class="text-gray-400 hover:text-gray-500" onclick="closeNhaCungCapModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="nhaCungCapForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mã nhà cung cấp</label>
                        <input type="text" id="maNhaCungCap" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tên nhà cung cấp<span
                                class="text-red-500">*</span></label>
                        <input type="text" id="tenNhaCungCapDayDu" class="w-full p-2 border border-gray-300 rounded-lg"
                            required>
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Loại dịch vụ</label>
                        <select id="loaiNhaCungCap" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">Chọn dịch vụ</option>
                            <option value="Giấy">Giấy</option>
                            <option value="In offset">In offset</option>
                            <option value="Hộp cứng">Hộp cứng</option>
                            <option value="Vận chuyển">Vận chuyển</option>
                            <option value="Gia công">Gia công</option>
                            <option value="In nhanh">In nhanh</option>
                            <option value="Carton sóng">Carton sóng</option>
                            <option value="Khuôn bế">Khuôn bế</option>
                            <option value="Ép nhũ">Ép nhũ</option>
                            <option value="In QC">In QC</option>
                            <option value="Giấy mỹ thuật">Giấy mỹ thuật</option>
                            <option value="Vật tư QC">Vật tư QC</option>
                            <option value="túi vải">túi vải</option>
                            <option value="Thiết kế">Thiết kế</option>
                            <option value="Khác">Khác</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Người liên hệ</label>
                        <input type="text" id="nguoiLienhe" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Số điện thoại <span
                                class="text-red-500">*</span></label>
                        <input type="tel" id="soDienThoai" class="w-full p-2 border border-gray-300 rounded-lg"
                            required>
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="email" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div class="form-group md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Địa chỉ</label>
                        <textarea id="diaChi" class="w-full p-2 border border-gray-300 rounded-lg" rows="2"></textarea>
                    </div>

                    <div class="md:col-span-2 flex justify-end space-x-3 pt-4">
                        <button type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                            onclick="closeNhaCungCapModal()">
                            Huỷ bỏ
                        </button>
                        <button type="submit"
                            class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                            Lưu nhà cung cấp
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Chi Tiết Chi Phí Sản Xuất -->
    <div id="chiPhiDetailModal" class="fixed inset-0 bg-gray-800/70 backdrop-blur-sm z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 sm:p-0">
            <div class="relative w-full max-w-4xl p-6 mx-auto my-8 bg-white rounded-2xl shadow-xl">
                <div class="flex items-center justify-between border-b border-gray-200 pb-4 mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Chi tiết chi phí sản xuất</h3>
                    <button type="button" class="text-gray-400 hover:text-gray-500" onclick="closeChiPhiDetailModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <form id="chiPhiDetailForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- ID đơn hàng (New) -->
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Mã đơn hàng</label>
                        <input type="text" id="modalIdDonHang" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>

                    <!-- ID hàng hoá (New) -->
                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tên hàng hoá</label>
                        <input type="text" id="modalIdHangHoa" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Hình thức chi <span
                                class="text-red-500">*</span></label>
                        <select id="modalHinhThucChi" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="">-- Chọn --</option>
                            <option value="Chi trực tiếp">Chi trực tiếp</option>
                            <option value="Chi theo bảng kê">Chi theo bảng kê</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Loại chi phí <span
                                class="text-red-500">*</span></label>
                        <select id="modalLoaiChiPhi" class="w-full p-2 border border-gray-300 rounded-lg" required>
                            <option value="">-- Chọn --</option>
                            <option value="Vật tư">Vật tư</option>
                            <option value="Gia công">Gia công</option>
                            <option value="Vận chuyển">Vận chuyển</option>
                            <option value="In ấn">In ấn</option>
                            <option value="Làm khuôn">Làm khuôn</option>
                            <option value="In nhanh">In nhanh</option>
                            <option value="Thiết kế">Thiết kế</option>
                            <option value="Khác">Khác</option>
                            <option value="custom">Khác...</option>
                        </select>
                        <input type="text" id="modalLoaiChiPhiCustom"
                            class="w-full p-2 border border-gray-300 rounded-lg mt-1 hidden"
                            placeholder="Nhập loại chi phí">
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Phương thức thanh toán</label>
                        <select id="modalPhuongThucThanhToan" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">-- Chọn --</option>
                            <option value="MB">MB Bank - CN Gia Lâm. STK: 6666.939.8888 - Đỗ Trọng Nghĩa</option>
                            <option value="VP">VPBank - CN Thăng Long. STK: 156939258 - DUC THANH SERPRO</option>
                            <option value="Grab">Grab</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Người đề xuất chi</label>
                        <select id="modalNguoiDeXuatChi" class="w-full p-2 border border-gray-300 rounded-lg">
                            <option value="">-- Chọn --</option>
                            <!-- Sẽ được điền bởi JavaScript -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ngày chi</label>
                        <input type="date" id="modalNgayChi" class="w-full p-2 border border-gray-300 rounded-lg">
                    </div>

                    <div class="form-group">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Số tiền chi <span
                                class="text-red-500">*</span></label>
                        <input type="number" id="modalSoTienChi" class="w-full p-2 border border-gray-300 rounded-lg"
                            required>
                    </div>

                    <div class="form-group lg:col-span-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ghi chú</label>
                        <textarea id="modalGhiChu" class="w-full p-2 border border-gray-300 rounded-lg"
                            rows="3"></textarea>
                    </div>

                    <div class="lg:col-span-3 flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                            onclick="closeChiPhiDetailModal()">
                            Huỷ bỏ
                        </button>
                        <button type="submit"
                            class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700">
                            Cập nhật
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nhập Dữ Liệu -->
    <div id="importModal" class="fixed inset-0 bg-gray-800/70 backdrop-blur-sm z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 sm:p-0">
            <div class="relative w-full max-w-5xl p-6 mx-auto my-8 bg-white rounded-2xl shadow-xl">
                <div class="flex items-center justify-between border-b border-gray-200 pb-4 mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Nhập chi tiết chi phí từ Excel</h3>
                    <button type="button" class="text-gray-400 hover:text-gray-500" onclick="closeImportModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-3">
                        Tải lên file Excel (.xlsx, .xls) có chứa dữ liệu chi phí. File cần có các cột: MÃ ĐƠN HÀNG, TÊN
                        HÀNG HÓA, HÌNH THỨC CHI, LOẠI CHI PHÍ, SỐ TIỀN CHI.
                    </p>

                    <div class="flex gap-3 mb-4">
                        <button id="btnChonFile"
                            class="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            <i class="fas fa-file-upload"></i>
                            Chọn file
                        </button>

                        <button id="btnTaiMauNhap"
                            class="flex items-center gap-2 px-4 py-2 text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-50">
                            <i class="fas fa-download"></i>
                            Tải mẫu nhập
                        </button>

                        <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden" />
                    </div>

                    <div id="selectedFileInfo" class="text-sm text-gray-600 mb-3 hidden"></div>
                </div>

                <div id="previewContainer" class="hidden">
                    <h4 class="font-medium text-gray-800 mb-2">Xem trước dữ liệu (5 dòng đầu tiên):</h4>
                    <div class="overflow-x-auto border border-gray-200 rounded-lg">
                        <table id="previewTable" class="min-w-full bg-white">
                            <thead id="previewTableHead">
                                <!-- Headers will be inserted here -->
                            </thead>
                            <tbody id="previewTableBody">
                                <!-- Data will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
                    <button type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300"
                        onclick="closeImportModal()">
                        Hủy
                    </button>
                    <button type="button" id="btnNhapDuLieu"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" disabled>
                        Nhập dữ liệu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Thêm thư viện SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://hoangmv.github.io/ducthanh/key.js"></script>

    <script>
        // Class chính quản lý bảng kê công nợ
        class BangKeCongNoManager {
            // Hàm lấy tham số từ URL
            getUrlParameter(name) {
                name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
                const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
                const results = regex.exec(location.search);
                return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
            }

            // Thêm đoạn này vào constructor của BangKeCongNoManager
            constructor(appId, accessKey) {
                this.appId = appId;
                this.accessKey = accessKey;
                this.bangKeCongNoData = null;
                this.chiPhiList = [];
                this.nhaCungCapList = [];
                this.nhanVienList = [];
                this.currentEditingRow = null;
                this.selectedBangKeId = null;

                // Lấy tên nhân viên từ URL
                this.employeeName = this.getUrlParameter('nhanvien');

                // Thêm modals vào DOM
                document.body.insertAdjacentHTML('beforeend', this.importModalHTML);

                this.init();
            }

            // Thêm getter này vào class BangKeCongNoManager
            get importModalHTML() {
                return `
    <div id="importModal" class="fixed inset-0 bg-gray-800/70 backdrop-blur-sm z-50 hidden overflow-y-auto">
      <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 sm:p-0">
        <div class="relative w-full max-w-5xl p-6 mx-auto my-8 bg-white rounded-2xl shadow-xl">
          <div class="flex items-center justify-between border-b border-gray-200 pb-4 mb-4">
            <h3 class="text-lg font-medium text-gray-900">Nhập chi tiết chi phí từ Excel</h3>
            <button type="button" class="text-gray-400 hover:text-gray-500" onclick="closeImportModal()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div class="mb-4">
            <p class="text-sm text-gray-600 mb-3">
              Tải lên file Excel (.xlsx, .xls) có chứa dữ liệu chi phí. File cần có các cột: MÃ ĐƠN HÀNG, TÊN HÀNG HÓA, HÌNH THỨC CHI, LOẠI CHI PHÍ, SỐ TIỀN CHI.
            </p>
            
            <div class="flex gap-3 mb-4">
              <button id="btnChonFile" class="flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                <i class="fas fa-file-upload"></i>
                Chọn file
              </button>
              
              <button id="btnTaiMauNhap" class="flex items-center gap-2 px-4 py-2 text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-50">
                <i class="fas fa-download"></i>
                Tải mẫu nhập
              </button>
              
              <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden" />
            </div>
            
            <div id="selectedFileInfo" class="text-sm text-gray-600 mb-3 hidden"></div>
          </div>
          
          <div id="previewContainer" class="hidden">
            <h4 class="font-medium text-gray-800 mb-2">Xem trước dữ liệu (5 dòng đầu tiên):</h4>
            <div class="overflow-x-auto border border-gray-200 rounded-lg">
              <table id="previewTable" class="min-w-full bg-white">
                <thead id="previewTableHead">
                  <!-- Headers will be inserted here -->
                </thead>
                <tbody id="previewTableBody">
                  <!-- Data will be inserted here -->
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="flex justify-end space-x-3 mt-6 pt-4 border-t border-gray-200">
            <button type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300" onclick="closeImportModal()">
              Hủy
            </button>
            <button type="button" id="btnNhapDuLieu" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700" disabled>
              Nhập dữ liệu
            </button>
          </div>
        </div>
      </div>
    </div>
    `;
            }

            // Mở modal import Excel
            openImportModal() {
                document.getElementById('importModal').classList.remove('hidden');
                document.getElementById('selectedFileInfo').classList.add('hidden');
                document.getElementById('previewContainer').classList.add('hidden');
                document.getElementById('btnNhapDuLieu').disabled = true;
            }

            // Đóng modal import Excel
            closeImportModal() {
                document.getElementById('importModal').classList.add('hidden');
                document.getElementById('fileInput').value = '';
            }

            // Xử lý khi chọn file Excel
            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const fileInfo = document.getElementById('selectedFileInfo');
                fileInfo.innerHTML = `Đã chọn: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                fileInfo.classList.remove('hidden');

                // Preview file contents
                await this.previewExcelFile(file);
            }

            // Tải thư viện SheetJS
            async loadSheetJS() {
                return new Promise((resolve, reject) => {
                    if (window.XLSX) {
                        resolve();
                        return;
                    }

                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                    script.onload = resolve;
                    script.onerror = () => reject(new Error('Không thể tải thư viện SheetJS.'));
                    document.head.appendChild(script);
                });
            }

            // Xem trước nội dung file Excel
            async previewExcelFile(file) {
                try {
                    this.showLoading('Đang đọc file...');

                    // Load SheetJS if not already loaded
                    await this.loadSheetJS();

                    const reader = new FileReader();

                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });

                            // Assume the first sheet contains our data
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                            if (jsonData.length < 2) { // At least headers and one data row
                                throw new Error('File không chứa đủ dữ liệu. Vui lòng kiểm tra lại.');
                            }

                            // Get headers (first row)
                            const headers = jsonData[0];

                            // Generate preview table
                            this.generatePreviewTable(headers, jsonData.slice(1, 6)); // Show up to 5 rows

                            // Store the full data for later import
                            document.getElementById('importModal').dataset.jsonData = JSON.stringify(jsonData);

                            // Enable import button
                            document.getElementById('btnNhapDuLieu').disabled = false;

                            this.hideLoading();
                        } catch (error) {
                            this.hideLoading();
                            console.error('Lỗi xử lý file Excel:', error);
                            this.showAlert('error', 'Lỗi', error.message || 'Không thể đọc dữ liệu từ file. Vui lòng kiểm tra định dạng file.');
                        }
                    };

                    reader.onerror = () => {
                        this.hideLoading();
                        this.showAlert('error', 'Lỗi', 'Không thể đọc file. Vui lòng thử lại.');
                    };

                    reader.readAsArrayBuffer(file);

                } catch (error) {
                    this.hideLoading();
                    console.error('Lỗi đọc file:', error);
                    this.showAlert('error', 'Lỗi', error.message || 'Có lỗi xảy ra khi đọc file.');
                }
            }

            // Tạo bảng xem trước dữ liệu Excel
            generatePreviewTable(headers, dataRows) {
                const thead = document.getElementById('previewTableHead');
                const tbody = document.getElementById('previewTableBody');

                // Clear previous content
                thead.innerHTML = '';
                tbody.innerHTML = '';

                // Generate header row
                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.className = 'py-2 px-4 border-b border-gray-300 bg-gray-100 font-medium text-gray-700 text-center';
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);

                // Generate data rows
                dataRows.forEach(row => {
                    const tr = document.createElement('tr');
                    row.forEach((cell, index) => {
                        const td = document.createElement('td');
                        td.className = 'py-2 px-4 border-b border-gray-200';

                        // Format numbers properly
                        if (typeof cell === 'number') {
                            // Check if this column likely contains currency values (based on header name)
                            const headerText = headers[index]?.toLowerCase() || '';
                            if (headerText.includes('tiền') || headerText.includes('phí') || headerText.includes('chi')) {
                                td.textContent = this.formatCurrency(cell);
                                td.className += ' text-right';
                            } else {
                                td.textContent = cell;
                                td.className += ' text-center';
                            }
                        } else {
                            td.textContent = cell || '';
                        }

                        tr.appendChild(td);
                    });
                    tbody.appendChild(tr);
                });

                // Show preview container
                document.getElementById('previewContainer').classList.remove('hidden');
            }

            // Tải mẫu nhập Excel
            async downloadImportTemplate() {
                try {
                    await this.loadSheetJS().then(() => {
                        // Create workbook with template headers and example data
                        const wb = XLSX.utils.book_new();

                        // Define headers and sample data
                        const headers = ['Mã đơn hàng', 'Tên hàng hoá', 'Hình thức chi', 'Loại chi phí',
                            'Phương thức thanh toán', 'Người đề xuất chi', 'Ngày chi', 'Số tiền chi', 'Ghi chú'];

                        const exampleData = [
                            ['250404TESTLUNGTUNG', 'TEST TEST HÀNG VÍ DỤ', 'Chi trực tiếp', 'Vật tư', 'MB', '', '2023-05-01', 1500000, 'Thanh toán tiền mua vật tư'],
                            ['250404TESTLUNGTUNG', 'TEST TEST HÀNG', 'Chi theo bảng kê', 'Gia công', 'VP', '', '2023-05-02', 800000, 'Thanh toán tiền gia công']
                        ];

                        // Create worksheet
                        const wsData = [headers, ...exampleData];
                        const ws = XLSX.utils.aoa_to_sheet(wsData);

                        // Add column widths
                        const colWidths = [
                            { wch: 15 }, // ID đơn hàng
                            { wch: 20 }, // ID hàng hoá
                            { wch: 15 }, // Hình thức chi
                            { wch: 15 }, // Loại chi phí
                            { wch: 20 }, // Phương thức thanh toán
                            { wch: 20 }, // Người đề xuất chi
                            { wch: 12 }, // Ngày chi
                            { wch: 15 }, // Số tiền chi
                            { wch: 30 }  // Ghi chú
                        ];
                        ws['!cols'] = colWidths;

                        // Add worksheet to workbook
                        XLSX.utils.book_append_sheet(wb, ws, 'Mẫu nhập chi phí');

                        // Write to file and trigger download
                        XLSX.writeFile(wb, 'mau_nhap_chi_phi.xlsx');
                    });
                } catch (error) {
                    console.error('Lỗi khi tải mẫu nhập:', error);
                    this.showAlert('error', 'Lỗi', 'Không thể tạo mẫu nhập. Vui lòng thử lại sau.');
                }
            }

            // Nhập dữ liệu từ Excel
            // Nhập dữ liệu từ Excel
            importDataFromExcel() {
                try {
                    const jsonDataStr = document.getElementById('importModal').dataset.jsonData;
                    if (!jsonDataStr) {
                        throw new Error('Không có dữ liệu để nhập. Vui lòng chọn file lại.');
                    }

                    this.showLoading('Đang nhập dữ liệu...');

                    const jsonData = JSON.parse(jsonDataStr);

                    // Headers are in the first row
                    const headers = jsonData[0];
                    const dataRows = jsonData.slice(1);

                    // In ra console để debug
                    console.log("Headers từ Excel:", headers);

                    // Find column indexes based on headers with improved regex patterns
                    const colIndexes = {
                        // Sử dụng nhiều mẫu regex để tìm kiếm linh hoạt hơn
                        idDonHang: headers.findIndex(h => /id.*đơn|đơn.*hàng|mã.*đơn|mã.*hàng/i.test(h)),
                        idHangHoa: headers.findIndex(h => /id.*hàng|hàng.*hóa|hàng.*hoá|tên.*hàng/i.test(h)),
                        hinhThucChi: headers.findIndex(h => /hình.*thức|chi.*trả/i.test(h)),
                        loaiChiPhi: headers.findIndex(h => /loại.*chi/i.test(h)),
                        phuongThucTT: headers.findIndex(h => /phương.*thức|thanh.*toán/i.test(h)),
                        nguoiDeXuat: headers.findIndex(h => /người.*xuất|đề.*xuất/i.test(h)),
                        ngayChi: headers.findIndex(h => /ngày.*chi/i.test(h)),
                        soTienChi: headers.findIndex(h => /số.*tiền|tiền.*chi/i.test(h)),
                        ghiChu: headers.findIndex(h => /ghi.*chú/i.test(h))
                    };

                    // In ra console để debug
                    console.log("Đã tìm thấy các vị trí cột:", colIndexes);

                    // Kiểm tra các cột bắt buộc
                    if (colIndexes.idDonHang === -1 || colIndexes.hinhThucChi === -1 ||
                        colIndexes.loaiChiPhi === -1 || colIndexes.soTienChi === -1) {
                        console.log("Không tìm thấy một hoặc nhiều cột bắt buộc, tiến hành tìm kiếm bổ sung");

                        // Nếu không tìm được cột đơn hàng, thử lại một lần nữa
                        if (colIndexes.idDonHang === -1) {
                            colIndexes.idDonHang = headers.findIndex(h =>
                                h && h.toLowerCase().includes('đơn') || h && h.toLowerCase().includes('hàng') || h && h.toLowerCase().includes('mã')
                            );
                            console.log("Tìm lại cột đơn hàng:", colIndexes.idDonHang);
                        }

                        // Nếu không tìm được cột hàng hóa, thử lại một lần nữa
                        if (colIndexes.idHangHoa === -1) {
                            colIndexes.idHangHoa = headers.findIndex(h =>
                                h && h.toLowerCase().includes('hàng') || h && h.toLowerCase().includes('tên')
                            );
                            console.log("Tìm lại cột hàng hóa:", colIndexes.idHangHoa);
                        }

                        // Nếu vẫn không tìm thấy các cột bắt buộc, thông báo lỗi
                        if (colIndexes.idDonHang === -1 || colIndexes.hinhThucChi === -1 ||
                            colIndexes.loaiChiPhi === -1 || colIndexes.soTienChi === -1) {
                            throw new Error('File thiếu các cột bắt buộc (Mã đơn hàng/ID đơn hàng, Hình thức chi, Loại chi phí hoặc Số tiền chi).');
                        }
                    }

                    // Check if the chiTietSection is hidden and show it
                    document.getElementById('chiTietSection').classList.remove('hidden');

                    // For statistics
                    let importCount = 0;
                    let errorCount = 0;

                    // Add each row to the chi phí table
                    dataRows.forEach(row => {
                        try {
                            // Skip empty rows (check if essential fields are empty)
                            if (!row[colIndexes.idDonHang] || !row[colIndexes.hinhThucChi] ||
                                !row[colIndexes.loaiChiPhi] || !row[colIndexes.soTienChi]) {
                                return;
                            }

                            // Get values from row based on column indexes
                            const getValue = (index, defaultValue) => {
                                return index !== -1 && row[index] !== undefined ? row[index] : defaultValue;
                            };

                            const idDonHang = getValue(colIndexes.idDonHang, '');
                            const idHangHoa = getValue(colIndexes.idHangHoa, '');
                            const hinhThucChi = getValue(colIndexes.hinhThucChi, '');
                            const loaiChiPhi = getValue(colIndexes.loaiChiPhi, '');
                            const phuongThucTT = getValue(colIndexes.phuongThucTT, '');
                            const nguoiDeXuat = getValue(colIndexes.nguoiDeXuat, '');
                            const ngayChi = getValue(colIndexes.ngayChi, this.formatDate(new Date()));
                            const soTienChi = parseFloat(getValue(colIndexes.soTienChi, 0)) || 0;
                            const ghiChu = getValue(colIndexes.ghiChu, '');

                            // Format the date if needed
                            let formattedNgayChi = ngayChi;
                            if (typeof ngayChi === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(ngayChi)) {
                                const parts = ngayChi.split('/');
                                formattedNgayChi = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                            } else if (ngayChi instanceof Date) {
                                formattedNgayChi = this.formatDate(ngayChi);
                            }

                            // Create a new row
                            const tableBody = document.getElementById('chiTietTableBody');
                            const newRow = document.createElement('tr');
                            newRow.classList.add('animate-fade-in');

                            // Set data attributes
                            newRow.dataset.idDonHang = idDonHang;
                            newRow.dataset.idHangHoa = idHangHoa;
                            newRow.dataset.loaiChiPhi = loaiChiPhi;
                            newRow.dataset.hinhThucChi = hinhThucChi;
                            newRow.dataset.phuongThucTT = phuongThucTT;
                            newRow.dataset.nguoiDeXuat = nguoiDeXuat;
                            newRow.dataset.ngayChi = formattedNgayChi;
                            newRow.dataset.soTienChi = soTienChi;
                            newRow.dataset.ghiChu = ghiChu;
                            newRow.dataset.lichSuCapNhat = this.formatDate(new Date()) + ' - Tạo mới (nhập)';

                            // Tìm tên đơn hàng để hiển thị
                            let displayIdDonHang = idDonHang;
                            if (this.donHangList && idDonHang) {
                                const donHang = this.donHangList.find(dh =>
                                    (dh['ID đơn hàng'] || dh.ID) === idDonHang);
                                if (donHang && donHang['Mã đơn hàng']) {
                                    displayIdDonHang = donHang['Mã đơn hàng'];
                                    // if (donHang['Tên đơn hàng']) {
                                    //     displayIdDonHang += ` || ${donHang['Tên đơn hàng']}`;
                                    // }
                                }
                            }

                            // Tìm tên hàng hóa để hiển thị
                            let displayIdHangHoa = idHangHoa;
                            if (this.allHangHoaList && idHangHoa) {
                                const hangHoa = this.allHangHoaList.find(hh =>
                                    (hh['ID hàng hoá'] || hh.ID) === idHangHoa);
                                if (hangHoa && hangHoa['Tên hàng hoá']) {
                                    displayIdHangHoa = hangHoa['Tên hàng hoá'];
                                }
                            }

                            // Create HTML content for the row
                            newRow.innerHTML = `
<td class="py-3 px-4 border-b border-gray-200">
  <button type="button" class="text-blue-600 hover:text-blue-800" onclick="openChiPhiDetail(this)">
    <i class="fas fa-edit"></i>
  </button>
</td>
<td class="py-3 px-4 border-b border-gray-200">${displayIdDonHang}</td>
<td class="py-3 px-4 border-b border-gray-200">${displayIdHangHoa}</td>
<td class="py-3 px-4 border-b border-gray-200">
  <select class="w-full p-2 border border-gray-300 rounded-lg hinh-thuc-chi">
    <option value="">-- Chọn --</option>
    <option value="Chi trực tiếp" ${hinhThucChi === 'Chi trực tiếp' ? 'selected' : ''}>Chi trực tiếp</option>
    <option value="Chi theo bảng kê" ${hinhThucChi === 'Chi theo bảng kê' ? 'selected' : ''}>Chi theo bảng kê</option>
    ${hinhThucChi && !['Chi trực tiếp', 'Chi theo bảng kê'].includes(hinhThucChi) ?
                                    `<option value="${hinhThucChi}" selected>${hinhThucChi}</option>` : ''}
  </select>
</td>
<td class="py-3 px-4 border-b border-gray-200">
  <select class="w-full p-2 border border-gray-300 rounded-lg loai-chi-phi">
    <option value="">-- Chọn --</option>
    <option value="Vật tư" ${loaiChiPhi === 'Vật tư' ? 'selected' : ''}>Vật tư</option>
    <option value="Gia công" ${loaiChiPhi === 'Gia công' ? 'selected' : ''}>Gia công</option>
    <option value="Vận chuyển" ${loaiChiPhi === 'Vận chuyển' ? 'selected' : ''}>Vận chuyển</option>
    <option value="In ấn" ${loaiChiPhi === 'In ấn' ? 'selected' : ''}>In ấn</option>
    <option value="Làm khuôn" ${loaiChiPhi === 'Làm khuôn' ? 'selected' : ''}>Làm khuôn</option>
    <option value="In nhanh" ${loaiChiPhi === 'In nhanh' ? 'selected' : ''}>In nhanh</option>
    <option value="Thiết kế" ${loaiChiPhi === 'Thiết kế' ? 'selected' : ''}>Thiết kế</option>
    <option value="Khác" ${loaiChiPhi === 'Khác' ? 'selected' : ''}>Khác</option>
    ${loaiChiPhi && !['Vật tư', 'Gia công', 'Vận chuyển', 'In ấn', 'Làm khuôn', 'In nhanh', 'Thiết kế', 'Khác'].includes(loaiChiPhi) ?
                                    `<option value="${loaiChiPhi}" selected>${loaiChiPhi}</option>` : ''}
  </select>
</td>
<td class="py-3 px-4 border-b border-gray-200">
  <select class="w-full p-2 border border-gray-300 rounded-lg phuong-thuc-tt">
    <option value="">-- Chọn --</option>
    <option value="MB" ${phuongThucTT === 'MB' ? 'selected' : ''}>MB Ngân hàng Quân Đội (MB Bank)</option>
    <option value="VP" ${phuongThucTT === 'VP' ? 'selected' : ''}>VP Ngân hàng VPBank</option>
    <option value="Grab" ${phuongThucTT === 'Grab' ? 'selected' : ''}>Grab</option>
    ${phuongThucTT && !['MB', 'VP', 'Grab', ''].includes(phuongThucTT) ?
                                    `<option value="${phuongThucTT}" selected>${phuongThucTT}</option>
    ` : ''}
</select>
</td>
<td class="py-3 px-4 border-b border-gray-200">
  <select class="w-full p-2 border border-gray-300 rounded-lg nguoi-de-xuat">
    <option value="">-- Chọn --</option>
    <!-- Sẽ được điền bởi JavaScript -->
  </select>
</td>
<td class="py-3 px-4 border-b border-gray-200">
  <input type="date" class="w-full p-2 border border-gray-300 rounded-lg ngay-chi" 
      value="${formattedNgayChi}">
</td>
<td class="py-3 px-4 border-b border-gray-200">
  <input type="number" class="w-full p-2 border border-gray-300 rounded-lg so-tien-chi" 
      min="0" step="1000" value="${soTienChi}">
</td>
<td class="py-3 px-4 border-b border-gray-200">
  <div class="flex space-x-2">
    <button type="button" class="text-green-500 hover:text-green-700" onclick="copyRow(this)">
      <i class="fas fa-copy"></i>
    </button>
    <button type="button" class="text-red-500 hover:text-red-700" onclick="deleteRow(this)">
      <i class="fas fa-trash"></i>
    </button>
  </div>
</td>
`;
                            tableBody.appendChild(newRow);

                            // Fill employee dropdown
                            const nguoiDeXuatSelect = newRow.querySelector('.nguoi-de-xuat');
                            if (nguoiDeXuatSelect && this.nhanVienList) {
                                this.nhanVienList.forEach(nhanVien => {
                                    if (nhanVien['Tên nhân viên']) {
                                        const option = document.createElement('option');
                                        option.value = nhanVien['ID nhân viên'] || nhanVien.ID;
                                        let displayName = nhanVien['Tên nhân viên'];
                                        if (nhanVien['Mã nhân viên']) {
                                            displayName = `${nhanVien['Mã nhân viên']} - ${displayName}`;
                                        }
                                        option.textContent = displayName;
                                        nguoiDeXuatSelect.appendChild(option);
                                    }
                                });

                                // Set employee from data or default to current user
                                if (nguoiDeXuat) {
                                    // Try to find by ID first
                                    nguoiDeXuatSelect.value = nguoiDeXuat;

                                    // If not found by ID, try to find by name
                                    if (nguoiDeXuatSelect.value === '') {
                                        const foundEmployee = this.nhanVienList.find(nv =>
                                            nv['Tên nhân viên'] === nguoiDeXuat ||
                                            `${nv['Mã nhân viên']} - ${nv['Tên nhân viên']}` === nguoiDeXuat
                                        );

                                        if (foundEmployee) {
                                            nguoiDeXuatSelect.value = foundEmployee['ID nhân viên'] || foundEmployee.ID;
                                        }
                                    }
                                } else if (this.employeeName) {
                                    // Use current user if no employee specified
                                    const foundEmployee = this.nhanVienList.find(nv =>
                                        nv['Tên nhân viên'] === this.employeeName ||
                                        (nv['Mã nhân viên'] && nv['Mã nhân viên'] + ' - ' + nv['Tên nhân viên'] === this.employeeName)
                                    );

                                    if (foundEmployee) {
                                        nguoiDeXuatSelect.value = foundEmployee['ID nhân viên'] || foundEmployee.ID;
                                    }
                                }
                            }

                            // Add event listeners to row elements
                            this.attachRowEventListeners(newRow);
                            this.calculateRowValues(newRow);
                            importCount++;
                        } catch (rowError) {
                            console.error('Lỗi nhập dòng:', rowError, row);
                            errorCount++;
                        }
                    });

                    // Update totals and progress
                    this.updateOrderTotals();
                    this.updateProgressSteps(2);

                    // Close modal
                    this.closeImportModal();

                    this.hideLoading();

                    // Show result message
                    let resultMessage = `Đã nhập ${importCount} chi phí từ Excel.`;
                    if (errorCount > 0) {
                        resultMessage += ` Bỏ qua ${errorCount} dòng không hợp lệ.`;
                    }

                    this.showAlert('success', 'Nhập dữ liệu thành công', resultMessage);

                } catch (error) {
                    this.hideLoading();
                    console.error('Lỗi nhập dữ liệu:', error);
                    this.showAlert('error', 'Lỗi nhập dữ liệu', error.message || 'Có lỗi xảy ra khi nhập dữ liệu từ Excel.');
                }
            }

            // Add this to BangKeCongNoManager class
            async loadAllHangHoaList() {
                try {
                    this.showLoading('Đang tải danh sách tất cả hàng hóa...');

                    const response = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${this.appId}/tables/Hàng hoá/Action`,
                        headers: {
                            'ApplicationAccessKey': this.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Find",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh",
                                "Selector": "Filter(Hàng hoá, true)" // Load all products
                            }
                        }
                    });

                    if (response.data && response.data.Rows) {
                        this.allHangHoaList = response.data.Rows;
                    } else if (Array.isArray(response.data)) {
                        this.allHangHoaList = response.data;
                    } else {
                        console.error('Cấu trúc dữ liệu hàng hóa không đúng:', response.data);
                        this.allHangHoaList = [];
                    }

                    console.log(`Đã tải ${this.allHangHoaList.length} hàng hóa`);
                    this.hideLoading();
                } catch (error) {
                    console.error('Lỗi khi tải danh sách tất cả hàng hóa:', error);
                    if (error.response) {
                        console.error('Error response:', error.response.status, error.response.data);
                    }
                    this.hideLoading();
                }
            }

            // Thêm phương thức này vào class BangKeCongNoManager
            // Cập nhật phương thức importDataFromExcel trong class BangKeCongNoManager
            async importDataFromExcel() {
                try {
                    const jsonDataStr = document.getElementById('importModal').dataset.jsonData;
                    if (!jsonDataStr) {
                        throw new Error('Không có dữ liệu để nhập. Vui lòng chọn file lại.');
                    }

                    this.showLoading('Đang nhập dữ liệu...');

                    const jsonData = JSON.parse(jsonDataStr);

                    // Headers nằm ở dòng đầu tiên
                    const headers = jsonData[0];
                    const dataRows = jsonData.slice(1);

                    // Tìm vị trí cột
                    const colIndexes = {
                        idDonHang: headers.findIndex(h => /id.*đơn|đơn.*hàng|mã.*đơn|mã.*hàng/i.test(h)),
                        idHangHoa: headers.findIndex(h => /id.*hàng|hàng.*hóa|hàng.*hoá|tên.*hàng/i.test(h)),
                        hinhThucChi: headers.findIndex(h => /hình.*thức|chi.*trả/i.test(h)),
                        loaiChiPhi: headers.findIndex(h => /loại.*chi/i.test(h)),
                        phuongThucTT: headers.findIndex(h => /phương.*thức|thanh.*toán/i.test(h)),
                        nguoiDeXuat: headers.findIndex(h => /người.*xuất|đề.*xuất/i.test(h)),
                        ngayChi: headers.findIndex(h => /ngày.*chi/i.test(h)),
                        soTienChi: headers.findIndex(h => /số.*tiền|tiền.*chi/i.test(h)),
                        ghiChu: headers.findIndex(h => /ghi.*chú/i.test(h))
                    };

                    // Kiểm tra cột bắt buộc
                    if (colIndexes.idDonHang === -1 || colIndexes.hinhThucChi === -1 ||
                        colIndexes.loaiChiPhi === -1 || colIndexes.soTienChi === -1) {
                        throw new Error('File thiếu các cột bắt buộc (Mã đơn hàng, Hình thức chi, Loại chi phí hoặc Số tiền chi).');
                    }

                    // Hiển thị phần chi tiết
                    document.getElementById('chiTietSection').classList.remove('hidden');

                    let importCount = 0;
                    let errorCount = 0;
                    const errorDetails = []; // Lưu chi tiết lỗi

                    // Tạo mapping
                    const donHangMap = new Map();
                    if (this.donHangList && this.donHangList.length > 0) {
                        this.donHangList.forEach(donHang => {
                            if (donHang['Mã đơn hàng'] && donHang['ID đơn hàng']) {
                                donHangMap.set(donHang['Mã đơn hàng'].toLowerCase(), donHang['ID đơn hàng']);
                            } else if (donHang['Mã đơn hàng'] && donHang.ID) {
                                donHangMap.set(donHang['Mã đơn hàng'].toLowerCase(), donHang.ID);
                            }
                        });
                    }

                    const hangHoaMap = new Map();
                    if (this.allHangHoaList && this.allHangHoaList.length > 0) {
                        this.allHangHoaList.forEach(hangHoa => {
                            if (hangHoa['Tên hàng hoá'] && hangHoa['ID hàng hoá']) {
                                hangHoaMap.set(hangHoa['Tên hàng hoá'].toLowerCase(), hangHoa['ID hàng hoá']);
                            } else if (hangHoa['Tên hàng hoá'] && hangHoa.ID) {
                                hangHoaMap.set(hangHoa['Tên hàng hoá'].toLowerCase(), hangHoa.ID);
                            }
                        });
                    }

                    // Xử lý từng dòng
                    dataRows.forEach((row, rowIndex) => {
                        try {
                            const getValue = (index, defaultValue) => {
                                return index !== -1 && row[index] !== undefined ? row[index] : defaultValue;
                            };

                            const maDonHang = getValue(colIndexes.idDonHang, '');
                            const tenHangHoa = getValue(colIndexes.idHangHoa, '');
                            const hinhThucChi = getValue(colIndexes.hinhThucChi, '');
                            const loaiChiPhi = getValue(colIndexes.loaiChiPhi, '');
                            const phuongThucTT = getValue(colIndexes.phuongThucTT, '');
                            const nguoiDeXuat = getValue(colIndexes.nguoiDeXuat, '');
                            const ngayChi = getValue(colIndexes.ngayChi, this.formatDate(new Date()));
                            const soTienChi = parseFloat(getValue(colIndexes.soTienChi, 0)) || 0;
                            const ghiChu = getValue(colIndexes.ghiChu, '');

                            // Bỏ qua dòng trống
                            if (!maDonHang || !hinhThucChi || !loaiChiPhi || !soTienChi) {
                                return;
                            }

                            // Kiểm tra và chuyển đổi ID với thông báo lỗi chi tiết
                            let idDonHang = maDonHang;
                            let idHangHoa = tenHangHoa;
                            let hasError = false;
                            let errorMessages = [];

                            // Kiểm tra Mã đơn hàng
                            if (maDonHang && !donHangMap.has(maDonHang.toLowerCase())) {
                                hasError = true;
                                errorMessages.push(`Mã đơn hàng "${maDonHang}" không tồn tại trong hệ thống`);
                            } else if (maDonHang) {
                                idDonHang = donHangMap.get(maDonHang.toLowerCase());
                            }

                            // Kiểm tra Tên hàng hóa
                            if (tenHangHoa && !hangHoaMap.has(tenHangHoa.toLowerCase())) {
                                hasError = true;
                                errorMessages.push(`Tên hàng hóa "${tenHangHoa}" không tồn tại trong hệ thống`);
                            } else if (tenHangHoa) {
                                idHangHoa = hangHoaMap.get(tenHangHoa.toLowerCase());
                            }

                            // Format ngày
                            let formattedNgayChi = ngayChi;
                            if (typeof ngayChi === 'string' && /^\d{1,2}\/\d{1,2}\/\d{4}$/.test(ngayChi)) {
                                const parts = ngayChi.split('/');
                                formattedNgayChi = `${parts[2]}-${parts[0].padStart(2, '0')}-${parts[1].padStart(2, '0')}`;
                            } else if (ngayChi instanceof Date) {
                                formattedNgayChi = this.formatDate(ngayChi);
                            }

                            // Tạo hàng
                            const tableBody = document.getElementById('chiTietTableBody');
                            const newRow = document.createElement('tr');
                            newRow.classList.add('animate-fade-in');

                            // Nếu có lỗi, thêm class đánh dấu
                            if (hasError) {
                                newRow.classList.add('bg-red-50', 'border-red-300');
                                errorDetails.push({
                                    row: rowIndex + 2, // +2 vì header là dòng 1
                                    errors: errorMessages,
                                    maDonHang: maDonHang,
                                    tenHangHoa: tenHangHoa
                                });
                            }

                            // Lưu data attributes
                            newRow.dataset.idDonHang = idDonHang;
                            newRow.dataset.idHangHoa = idHangHoa;
                            newRow.dataset.loaiChiPhi = loaiChiPhi;
                            newRow.dataset.hinhThucChi = hinhThucChi;
                            newRow.dataset.phuongThucTT = phuongThucTT;
                            newRow.dataset.nguoiDeXuat = nguoiDeXuat;
                            newRow.dataset.ngayChi = formattedNgayChi;
                            newRow.dataset.soTienChi = soTienChi;
                            newRow.dataset.ghiChu = ghiChu;
                            newRow.dataset.lichSuCapNhat = this.formatDate(new Date()) + ' - Tạo mới (nhập)';
                            newRow.dataset.hasError = hasError;
                            newRow.dataset.errorMessages = JSON.stringify(errorMessages);

                            // Tạo HTML với thông báo lỗi nếu có
                            newRow.innerHTML = `
<td class="py-3 px-4 border-b border-gray-200">
  <button type="button" class="text-blue-600 hover:text-blue-800" onclick="openChiPhiDetail(this)">
    <i class="fas fa-edit"></i>
  </button>
  ${hasError ? `
  <button type="button" class="text-red-600 hover:text-red-800 ml-2" onclick="showRowError(this)" title="Xem lỗi">
    <i class="fas fa-exclamation-triangle"></i>
  </button>` : ''}
</td>
<td class="py-3 px-4 border-b border-gray-200 ${hasError && errorMessages.some(msg => msg.includes('Mã đơn hàng')) ? 'text-red-600 font-semibold' : ''}">
    ${maDonHang}
    ${hasError && errorMessages.some(msg => msg.includes('Mã đơn hàng')) ?
                                    '<br><span class="text-xs text-red-500">⚠ Không tìm thấy</span>' : ''}
</td>
<td class="py-3 px-4 border-b border-gray-200 ${hasError && errorMessages.some(msg => msg.includes('Tên hàng hóa')) ? 'text-red-600 font-semibold' : ''}">
    ${tenHangHoa}
    ${hasError && errorMessages.some(msg => msg.includes('Tên hàng hóa')) ?
                                    '<br><span class="text-xs text-red-500">⚠ Không tìm thấy</span>' : ''}
</td>
<td class="py-3 px-4 border-b border-gray-200">
  <select class="w-full p-2 border border-gray-300 rounded-lg hinh-thuc-chi">
    <option value="">-- Chọn --</option>
    <option value="Chi trực tiếp" ${hinhThucChi === 'Chi trực tiếp' ? 'selected' : ''}>Chi trực tiếp</option>
    <option value="Chi theo bảng kê" ${hinhThucChi === 'Chi theo bảng kê' ? 'selected' : ''}>Chi theo bảng kê</option>
    ${hinhThucChi && !['Chi trực tiếp', 'Chi theo bảng kê'].includes(hinhThucChi) ?
                                    `<option value="${hinhThucChi}" selected>${hinhThucChi}</option>` : ''}
  </select>
</td>
<td class="py-3 px-4 border-b border-gray-200">
  <select class="w-full p-2 border border-gray-300 rounded-lg loai-chi-phi">
    <option value="">-- Chọn --</option>
    <option value="Vật tư" ${loaiChiPhi === 'Vật tư' ? 'selected' : ''}>Vật tư</option>
    <option value="Gia công" ${loaiChiPhi === 'Gia công' ? 'selected' : ''}>Gia công</option>
    <option value="Vận chuyển" ${loaiChiPhi === 'Vận chuyển' ? 'selected' : ''}>Vận chuyển</option>
    <option value="In ấn" ${loaiChiPhi === 'In ấn' ? 'selected' : ''}>In ấn</option>
    <option value="Làm khuôn" ${loaiChiPhi === 'Làm khuôn' ? 'selected' : ''}>Làm khuôn</option>
    <option value="In nhanh" ${loaiChiPhi === 'In nhanh' ? 'selected' : ''}>In nhanh</option>
    <option value="Thiết kế" ${loaiChiPhi === 'Thiết kế' ? 'selected' : ''}>Thiết kế</option>
    <option value="Khác" ${loaiChiPhi === 'Khác' ? 'selected' : ''}>Khác</option>
    ${loaiChiPhi && !['Vật tư', 'Gia công', 'Vận chuyển', 'In ấn', 'Làm khuôn', 'In nhanh', 'Thiết kế', 'Khác'].includes(loaiChiPhi) ?
                                    `<option value="${loaiChiPhi}" selected>${loaiChiPhi}</option>` : ''}
  </select>
</td>
<td class="py-3 px-4 border-b border-gray-200">
  <select class="w-full p-2 border border-gray-300 rounded-lg phuong-thuc-tt">
    <option value="">-- Chọn --</option>
    <option value="MB" ${phuongThucTT === 'MB' ? 'selected' : ''}>MB Bank - CN Gia Lâm. STK: 6666.939.8888 - Đỗ Trọng Nghĩa</option>
    <option value="VP" ${phuongThucTT === 'VP' ? 'selected' : ''}>VPBank - CN Thăng Long. STK: 156939258 - DUC THANH SERPRO</option>
    <option value="Grab" ${phuongThucTT === 'Grab' ? 'selected' : ''}>Grab</option>
    ${phuongThucTT && !['MB', 'VP', 'Grab', ''].includes(phuongThucTT) ?
                                    `<option value="${phuongThucTT}" selected>${phuongThucTT}</option>` : ''}
  </select>
</td>
<td class="py-3 px-4 border-b border-gray-200">
  <select class="w-full p-2 border border-gray-300 rounded-lg nguoi-de-xuat">
    <option value="">-- Chọn --</option>
  </select>
</td>
<td class="py-3 px-4 border-b border-gray-200">
  <input type="date" class="w-full p-2 border border-gray-300 rounded-lg ngay-chi" 
      value="${formattedNgayChi}">
</td>
<td class="py-3 px-4 border-b border-gray-200">
  <input type="number" class="w-full p-2 border border-gray-300 rounded-lg so-tien-chi" 
      min="0" step="1000" value="${soTienChi}">
</td>
<td class="py-3 px-4 border-b border-gray-200">
  <div class="flex space-x-2">
    <button type="button" class="text-green-500 hover:text-green-700" onclick="copyRow(this)">
      <i class="fas fa-copy"></i>
    </button>
    <button type="button" class="text-red-500 hover:text-red-700" onclick="deleteRow(this)">
      <i class="fas fa-trash"></i>
    </button>
  </div>
</td>
`;
                            tableBody.appendChild(newRow);

                            // Điền dropdown nhân viên
                            const nguoiDeXuatSelect = newRow.querySelector('.nguoi-de-xuat');
                            if (nguoiDeXuatSelect && this.nhanVienList) {
                                this.nhanVienList.forEach(nhanVien => {
                                    if (nhanVien['Tên nhân viên']) {
                                        const option = document.createElement('option');
                                        option.value = nhanVien['ID nhân viên'] || nhanVien.ID;
                                        let displayName = nhanVien['Tên nhân viên'];
                                        if (nhanVien['Mã nhân viên']) {
                                            displayName = `${nhanVien['Mã nhân viên']} - ${displayName}`;
                                        }
                                        option.textContent = displayName;
                                        nguoiDeXuatSelect.appendChild(option);
                                    }
                                });

                                // Set nhân viên
                                if (nguoiDeXuat) {
                                    nguoiDeXuatSelect.value = nguoiDeXuat;
                                } else if (this.employeeName) {
                                    const foundEmployee = this.nhanVienList.find(nv =>
                                        nv['Tên nhân viên'] === this.employeeName
                                    );
                                    if (foundEmployee) {
                                        nguoiDeXuatSelect.value = foundEmployee['ID nhân viên'] || foundEmployee.ID;
                                    }
                                }
                            }

                            // Event listeners
                            this.attachRowEventListeners(newRow);
                            this.calculateRowValues(newRow);
                            importCount++;

                            if (hasError) {
                                errorCount++;
                            }
                        } catch (rowError) {
                            console.error('Lỗi nhập dòng:', rowError, row);
                            errorCount++;
                        }
                    });

                    // Cập nhật totals
                    this.updateOrderTotals();
                    this.updateProgressSteps(2);

                    // Đóng modal
                    this.closeImportModal();
                    this.hideLoading();

                    // Hiển thị kết quả với chi tiết lỗi
                    let resultMessage = `Đã nhập ${importCount} chi phí từ Excel.`;

                    if (errorDetails.length > 0) {
                        resultMessage += `\n\n⚠ Phát hiện ${errorDetails.length} dòng có lỗi:`;

                        // Hiển thị chi tiết lỗi
                        const errorDetailHtml = errorDetails.map(error => `
                <div class="mb-2 p-2 bg-red-50 rounded">
                    <div class="font-semibold text-red-700">Dòng ${error.row}:</div>
                    <ul class="list-disc list-inside ml-4">
                        ${error.errors.map(msg => `<li class="text-red-600">${msg}</li>`).join('')}
                    </ul>
                    <div class="text-sm text-gray-600 mt-1">
                        Mã đơn hàng: ${error.maDonHang} | Tên hàng hóa: ${error.tenHangHoa}
                    </div>
                </div>
            `).join('');

                        Swal.fire({
                            icon: 'warning',
                            title: 'Nhập dữ liệu với cảnh báo',
                            html: `
                    <div class="text-left">
                        <p class="mb-4">${resultMessage}</p>
                        <div class="max-h-64 overflow-y-auto">
                            ${errorDetailHtml}
                        </div>
                        <p class="mt-4 text-sm text-gray-500">
                            Các dòng có lỗi đã được đánh dấu màu đỏ trong bảng. 
                            Vui lòng kiểm tra và sửa lại thông tin.
                        </p>
                    </div>
                `,
                            confirmButtonText: 'Đã hiểu',
                            confirmButtonColor: '#0ea5e9',
                            width: '600px'
                        });
                    } else {
                        this.showAlert('success', 'Nhập dữ liệu thành công', resultMessage);
                    }

                } catch (error) {
                    this.hideLoading();
                    console.error('Lỗi nhập dữ liệu:', error);
                    this.showAlert('error', 'Lỗi nhập dữ liệu', error.message || 'Có lỗi xảy ra khi nhập dữ liệu từ Excel.');
                }
            }

            async init() {
                try {
                    this.showLoading('Đang khởi tạo...');

                    // Kiểm tra kết nối API
                    const isConnected = await this.testAppSheetConnection();
                    if (!isConnected) {
                        throw new Error('Không thể kết nối đến AppSheet API');
                    }

                    // Hiển thị tên nhân viên nếu có
                    if (this.employeeName) {
                        const headerDiv = document.querySelector('header div.flex.items-center.space-x-4');
                        if (headerDiv) {
                            const userInfoElement = document.createElement('div');
                            userInfoElement.className = 'ml-auto text-sm text-gray-600';
                            userInfoElement.innerHTML = `<i class="fas fa-user mr-1"></i> ${this.employeeName}`;
                            headerDiv.appendChild(userInfoElement);
                        }
                    }

                    // Thiết lập các giá trị ban đầu
                    this.setupEventListeners();
                    this.generateNewBangKeCode();
                    this.setupBangKeDropdown();
                    this.setDefaultDate();

                    // Tải dữ liệu song song
                    await Promise.all([
                        this.loadNhaCungCapList(),
                        this.loadNhanVienList(),
                        this.loadExistingBangKeList(),
                        this.loadDonHangList(), // Add this new method call
                        this.loadAllHangHoaList() // Added this new method call
                    ]);

                    console.log(`Đã tải ${this.donHangList?.length || 0} đơn hàng và ${this.allHangHoaList?.length || 0} hàng hóa để mapping`);

                    // Đặt nhân viên từ tham số URL làm giá trị được chọn trong dropdown
                    this.setEmployeeFromUrl();

                    this.updateProgressSteps(1);

                    this.hideLoading();
                } catch (error) {
                    console.error('Lỗi khởi tạo:', error);
                    this.hideLoading();
                    this.showAlert('error', 'Lỗi khởi tạo', 'Đã xảy ra lỗi khi khởi tạo ứng dụng. Vui lòng thử lại sau.');
                }
            }

            // Thiết lập nhân viên từ URL
            setEmployeeFromUrl() {
                if (this.employeeName && this.nhanVienChoices) {
                    // Tìm ID nhân viên khớp với tên từ URL
                    const foundEmployee = this.nhanVienList.find(nv =>
                        nv['Tên nhân viên'] === this.employeeName ||
                        (nv['Mã nhân viên'] && nv['Mã nhân viên'] + ' - ' + nv['Tên nhân viên'] === this.employeeName)
                    );

                    if (foundEmployee) {
                        const employeeId = foundEmployee['ID nhân viên'] || foundEmployee.ID;
                        // Đặt giá trị cho dropdown
                        this.nhanVienChoices.setChoiceByValue(employeeId);
                        console.log('Set employee from URL:', this.employeeName, 'ID:', employeeId);
                    } else {
                        console.log('Employee not found in list:', this.employeeName);
                    }
                }
            }

            // Kiểm tra kết nối API
            async testAppSheetConnection() {
                try {
                    this.showLoading('Đang kết nối...');

                    const response = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${this.appId}/tables/Nhà cung cấp/Action`,
                        headers: {
                            'ApplicationAccessKey': this.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Find",
                            "Properties": {
                                "Selector": "Select(Nhà cung cấp)"
                            }
                        }
                    });

                    this.hideLoading();

                    if (response.status === 200) {
                        console.log('Kết nối API thành công:', response);
                        return true;
                    } else {
                        throw new Error('Phản hồi không thành công');
                    }
                } catch (error) {
                    this.hideLoading();
                    console.error('Lỗi kết nối API:', error);

                    let errorMessage = 'Không thể kết nối đến AppSheet API.';
                    if (error.response) {
                        errorMessage += ` Status: ${error.response.status}. ${error.response.data?.error || ''}`;
                    }

                    this.showAlert('error', 'Lỗi kết nối!', errorMessage);
                    return false;
                }
            }

            // Sao chép hàng - cập nhật để giữ giá trị đúng
            copyRow(button) {
                const row = button.closest('tr');
                if (!row) return;

                // Sao chép toàn bộ hàng
                const newRow = row.cloneNode(true);
                newRow.classList.add('animate-fade-in');

                // Sao chép tất cả data attributes
                Object.keys(row.dataset).forEach(key => {
                    newRow.dataset[key] = row.dataset[key];
                });

                // Xóa ID nếu có để tạo bản ghi mới
                delete newRow.dataset.idChiPhi;

                // Cập nhật lịch sử
                newRow.dataset.lichSuCapNhat = this.formatDate(new Date()) + ' - Tạo mới (sao chép)';

                // Chèn sau hàng hiện tại
                row.parentNode.insertBefore(newRow, row.nextSibling);

                // Gắn lại event listeners cho hàng mới
                this.attachRowEventListeners(newRow);

                // Cập nhật tính toán
                this.calculateRowValues(newRow);
                this.updateOrderTotals();

                // Làm nổi bật hàng mới trong thời gian ngắn
                newRow.style.backgroundColor = '#e6f7ff';
                setTimeout(() => {
                    newRow.style.backgroundColor = '';
                }, 1000);

                // Cuộn đến hàng mới
                newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Phương thức mới để gắn sự kiện cho các phần tử trong hàng
            attachRowEventListeners(row) {
                // Thêm sự kiện cho nút chỉnh sửa
                const editButton = row.querySelector('button[onclick="openChiPhiDetail(this)"]');
                if (editButton) {
                    editButton.onclick = () => this.openChiPhiDetail(editButton);
                }

                // Thêm sự kiện cho nút sao chép
                const copyButton = row.querySelector('button[onclick="copyRow(this)"]');
                if (copyButton) {
                    copyButton.onclick = () => this.copyRow(copyButton);
                }

                // Thêm sự kiện cho nút xóa
                const deleteButton = row.querySelector('button[onclick="deleteRow(this)"]');
                if (deleteButton) {
                    deleteButton.onclick = () => this.deleteRow(deleteButton);
                }

                // Thêm sự kiện cho input số tiền
                const soTienChiInput = row.querySelector('.so-tien-chi');
                if (soTienChiInput) {
                    soTienChiInput.addEventListener('input', () => this.calculateRowValues(row));
                    soTienChiInput.addEventListener('input', () => this.updateOrderTotals());
                }

                // Thêm sự kiện cho trường ngày
                const ngayChiInput = row.querySelector('.ngay-chi');
                if (ngayChiInput) {
                    ngayChiInput.addEventListener('change', (e) => {
                        row.dataset.ngayChi = e.target.value;
                    });
                }

                // Thêm sự kiện cho các trường select
                const hinhThucChiSelect = row.querySelector('.hinh-thuc-chi');
                if (hinhThucChiSelect) {
                    hinhThucChiSelect.addEventListener('change', (e) => {
                        row.dataset.hinhThucChi = e.target.value;
                    });
                }

                const loaiChiPhiSelect = row.querySelector('.loai-chi-phi');
                if (loaiChiPhiSelect) {
                    loaiChiPhiSelect.addEventListener('change', (e) => {
                        row.dataset.loaiChiPhi = e.target.value;
                    });
                }

                const phuongThucTTSelect = row.querySelector('.phuong-thuc-tt');
                if (phuongThucTTSelect) {
                    phuongThucTTSelect.addEventListener('change', (e) => {
                        row.dataset.phuongThucTT = e.target.value;
                    });
                }

                const nguoiDeXuatSelect = row.querySelector('.nguoi-de-xuat');
                if (nguoiDeXuatSelect) {
                    nguoiDeXuatSelect.addEventListener('change', (e) => {
                        row.dataset.nguoiDeXuat = e.target.value;
                    });
                }
            }

            // // Cập nhật phương thức loadChiPhiForBangKe
            // async loadChiPhiForBangKe(bangKeId) {
            //     try {
            //         this.showLoading('Đang tải chi tiết chi phí...');

            //         const response = await axios({
            //             method: 'POST',
            //             url: `https://www.appsheet.com/api/v2/apps/${this.appId}/tables/Chi phí sản xuất/Action`,
            //             headers: {
            //                 'ApplicationAccessKey': this.accessKey,
            //                 'Content-Type': 'application/json'
            //             },
            //             data: {
            //                 "Action": "Find",
            //                 "Properties": {
            //                     "Locale": "vi-VN",
            //                     "Timezone": "Asia/Ho_Chi_Minh",
            //                     "Selector": `Filter(Chi phí sản xuất, [ID bảng kê công nợ phải trả] = "${bangKeId}")`
            //                 }
            //             }
            //         });

            //         let chiPhiList = [];
            //         if (response.data && response.data.Rows) {
            //             chiPhiList = response.data.Rows;
            //         } else if (Array.isArray(response.data)) {
            //             chiPhiList = response.data;
            //         }

            //         // Xóa các hàng hiện tại
            //         document.getElementById('chiTietTableBody').innerHTML = '';

            //         // Hiển thị phần chi tiết nếu có dữ liệu
            //         if (chiPhiList.length > 0) {
            //             document.getElementById('chiTietSection').classList.remove('hidden');

            //             // Tải thông tin đơn hàng trước khi thêm chi phí
            //             await this.preloadOrdersAndProducts(chiPhiList);

            //             // Thêm từng chi phí vào bảng
            //             chiPhiList.forEach(chiPhi => {
            //                 this.addExistingChiPhiRow(chiPhi);
            //             });

            //             // Cập nhật tổng tiền
            //             this.updateOrderTotals();
            //         }

            //         this.hideLoading();
            //     } catch (error) {
            //         console.error('Lỗi khi tải chi tiết chi phí:', error);
            //         this.hideLoading();
            //     }
            // }

            // Phương thức mới để tải trước thông tin đơn hàng và hàng hóa
            async preloadOrdersAndProducts(chiPhiList) {
                try {
                    // Tạo danh sách các ID đơn hàng độc nhất cần tải
                    const orderIds = [...new Set(chiPhiList.map(cp => cp['ID đơn hàng']).filter(id => id))];

                    if (orderIds.length === 0) return;

                    // Nếu chưa có danh sách đơn hàng, tải chúng trước
                    if (!this.donHangList || this.donHangList.length === 0) {
                        await this.loadDonHangList();
                    }

                    // Với mỗi đơn hàng, tải danh sách hàng hóa
                    for (const orderId of orderIds) {
                        if (orderId) {
                            await this.loadHangHoaForDonHang(orderId);
                        }
                    }
                } catch (error) {
                    console.error('Lỗi khi tải trước thông tin đơn hàng và hàng hoá:', error);
                }
            }

            // Add this to your BangKeCongNoManager class

            // Load order list
            async loadDonHangList() {
                try {
                    this.showLoading('Đang tải danh sách đơn hàng...');

                    const response = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${this.appId}/tables/Đơn hàng/Action`,
                        headers: {
                            'ApplicationAccessKey': this.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Find",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh",
                                "Selector": "Filter(Đơn hàng, true)"
                            }
                        }
                    });

                    if (response.data && response.data.Rows) {
                        this.donHangList = response.data.Rows;
                    } else if (Array.isArray(response.data)) {
                        this.donHangList = response.data;
                    } else {
                        console.error('Cấu trúc dữ liệu đơn hàng không đúng:', response.data);
                        this.donHangList = [];
                    }

                    // Setup the order dropdown in the modal
                    this.setupOrderDropdown();

                    this.hideLoading();
                } catch (error) {
                    console.error('Lỗi khi tải danh sách đơn hàng:', error);
                    this.hideLoading();
                    this.showAlert('error', 'Lỗi kết nối', 'Không thể tải danh sách đơn hàng. Vui lòng thử lại sau.');
                }
            }

            // Setup order dropdown with search functionality
            setupOrderDropdown() {
                const modalIdDonHang = document.getElementById('modalIdDonHang');

                // Replace the input with a div container for our custom dropdown
                const inputParent = modalIdDonHang.parentElement;
                const inputPosition = Array.from(inputParent.children).indexOf(modalIdDonHang);

                // Create the container
                const dropdownContainer = document.createElement('div');
                dropdownContainer.className = 'relative';

                // Create the input with button
                dropdownContainer.innerHTML = `
        <div class="flex">
            <input type="text" id="modalIdDonHang" class="w-full p-2 border border-gray-300 rounded-l-lg" 
                placeholder="Nhập hoặc chọn ID đơn hàng" autocomplete="off">
            <button type="button" id="orderDropdownBtn" 
                class="h-full px-3 py-2 bg-gray-100 text-gray-700 border border-l-0 border-gray-300 rounded-r-lg hover:bg-gray-200 transition duration-200 flex items-center">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div id="orderDropdown" class="hidden absolute left-0 right-0 mt-1 max-h-60 overflow-y-auto bg-white border border-gray-300 rounded-lg shadow-lg z-50">
            <input type="text" id="orderSearch" class="w-full p-2 border-b border-gray-300 rounded-t-lg" placeholder="Tìm kiếm đơn hàng...">
            <ul id="orderList" class="py-1">
                <!-- Order items will be added here -->
            </ul>
        </div>
    `;

                // Replace the input with our dropdown
                modalIdDonHang.remove();
                if (inputPosition >= 0) {
                    if (inputPosition === inputParent.children.length) {
                        inputParent.appendChild(dropdownContainer);
                    } else {
                        inputParent.insertBefore(dropdownContainer, inputParent.children[inputPosition]);
                    }
                } else {
                    inputParent.appendChild(dropdownContainer);
                }

                // Populate the dropdown list
                const orderList = document.getElementById('orderList');
                orderList.innerHTML = '';

                if (this.donHangList && this.donHangList.length > 0) {
                    this.donHangList.forEach(donHang => {
                        const id = donHang['ID đơn hàng'] || donHang.ID;
                        const maDonHang = donHang['Mã đơn hàng'] || '';
                        const tenDonHang = donHang['Tên đơn hàng'] || '';

                        const li = document.createElement('li');
                        li.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                        li.dataset.id = id;

                        // Display format: ID - Mã đơn hàng - Tên đơn hàng
                        let displayText = maDonHang;
                        // if (tenDonHang) displayText += ` || ${tenDonHang}`;

                        li.textContent = displayText;
                        orderList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.className = 'px-4 py-2 text-gray-500 italic';
                    li.textContent = 'Không có đơn hàng nào';
                    orderList.appendChild(li);
                }

                // Setup event listeners
                const dropdownBtn = document.getElementById('orderDropdownBtn');
                const dropdown = document.getElementById('orderDropdown');
                const searchInput = document.getElementById('orderSearch');
                const idDonHangInput = document.getElementById('modalIdDonHang');

                // Show/hide dropdown
                dropdownBtn.addEventListener('click', () => {
                    dropdown.classList.toggle('hidden');
                    if (!dropdown.classList.contains('hidden')) {
                        searchInput.focus();
                    }
                });

                // Hide dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!dropdownBtn.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });

                // Filter list on search
                searchInput.addEventListener('input', () => {
                    const searchValue = searchInput.value.toLowerCase();
                    const items = orderList.querySelectorAll('li');

                    items.forEach(item => {
                        if (item.classList.contains('text-gray-500')) return;

                        const text = item.textContent.toLowerCase();
                        if (text.includes(searchValue)) {
                            item.classList.remove('hidden');
                        } else {
                            item.classList.add('hidden');
                        }
                    });
                });

                // Change in the setupOrderDropdown() event handler
                orderList.addEventListener('click', (e) => {
                    if (e.target.tagName === 'LI' && !e.target.classList.contains('text-gray-500')) {
                        const id = e.target.dataset.id;          // This is the reference ID
                        const displayText = e.target.textContent; // This is the display text

                        // Show the display text to the user
                        idDonHangInput.value = displayText;

                        // Store the actual ID in a data attribute
                        idDonHangInput.dataset.orderId = id;

                        // Hide the dropdown
                        dropdown.classList.add('hidden');

                        // Use the reference ID when loading products
                        this.loadHangHoaForDonHang(id);

                        console.log("Selected order: ", displayText, "with ID:", id);
                    }
                });
            }

            // Load products for selected order
            async loadHangHoaForDonHang(donHangId) {
                try {
                    // Only proceed if we have a valid order ID
                    if (!donHangId) {
                        console.log("No order ID provided");
                        return;
                    }

                    this.showLoading('Đang lọc danh sách Hàng hoá...');

                    // Instead of making an API call, filter from the already loaded data
                    if (this.allHangHoaList && this.allHangHoaList.length > 0) {
                        // Filter products that belong to the selected order
                        const hangHoaList = this.allHangHoaList.filter(hangHoa =>
                            (hangHoa['ID đơn hàng'] || hangHoa.IDDonHang) === donHangId
                        );

                        console.log(`Đã lọc được ${hangHoaList.length} hàng hóa cho đơn hàng ${donHangId}`);

                        // Setup product dropdown with the filtered data
                        this.setupHangHoaDropdown(hangHoaList);

                        this.hideLoading();
                    } else {
                        // If for some reason allHangHoaList is not loaded, fall back to API call
                        console.log("Falling back to API call as allHangHoaList is not available");

                        const response = await axios({
                            method: 'POST',
                            url: `https://www.appsheet.com/api/v2/apps/${this.appId}/tables/Hàng hoá/Action`,
                            headers: {
                                'ApplicationAccessKey': this.accessKey,
                                'Content-Type': 'application/json'
                            },
                            data: {
                                "Action": "Find",
                                "Properties": {
                                    "Locale": "vi-VN",
                                    "Timezone": "Asia/Ho_Chi_Minh",
                                    "Selector": `Filter(Hàng hoá, [ID đơn hàng] = "${donHangId}")`
                                }
                            }
                        });

                        let hangHoaList = [];
                        if (response.data && response.data.Rows) {
                            hangHoaList = response.data.Rows;
                        } else if (Array.isArray(response.data)) {
                            hangHoaList = response.data;
                        }

                        // Setup product dropdown
                        this.setupHangHoaDropdown(hangHoaList);

                        this.hideLoading();
                    }
                } catch (error) {
                    console.error('Lỗi khi tải danh sách Hàng hoá:', error);
                    if (error.response) {
                        console.error('Error response:', error.response.status, error.response.data);
                    }
                    this.hideLoading();
                    this.showAlert('error', 'Lỗi', 'Không thể tải danh sách Hàng hoá, vui lòng thử lại');
                }
            }

            // Setup product dropdown
            setupHangHoaDropdown(hangHoaList) {
                // First, let's find the parent container that holds the entire field
                const fieldContainer = document.querySelector('.form-group:has(#modalIdHangHoa)');
                if (!fieldContainer) {
                    console.error('Could not find the parent container for modalIdHangHoa');
                    return;
                }

                // Keep the label but replace everything else
                const label = fieldContainer.querySelector('label');
                const labelText = label ? label.outerHTML : '<label class="block text-sm font-medium text-gray-700 mb-1">ID hàng hoá</label>';

                // Completely rebuild the field container
                fieldContainer.innerHTML = labelText;

                // Create the dropdown container structure from scratch
                const dropdownContainer = document.createElement('div');
                dropdownContainer.className = 'relative';

                // Create the input with button
                dropdownContainer.innerHTML = `
        <div class="flex">
            <input type="text" id="modalIdHangHoa" class="w-full p-2 border border-gray-300 rounded-l-lg" 
                placeholder="Nhập hoặc chọn ID Hàng hoá" autocomplete="off">
            <button type="button" id="productDropdownBtn" 
                class="h-full px-3 py-2 bg-gray-100 text-gray-700 border border-l-0 border-gray-300 rounded-r-lg hover:bg-gray-200 transition duration-200 flex items-center">
                <i class="fas fa-chevron-down"></i>
            </button>
        </div>
        <div id="productDropdown" class="hidden absolute left-0 right-0 mt-1 max-h-60 overflow-y-auto bg-white border border-gray-300 rounded-lg shadow-lg z-50">
            <input type="text" id="productSearch" class="w-full p-2 border-b border-gray-300 rounded-t-lg" placeholder="Tìm kiếm Hàng hoá...">
            <ul id="productList" class="py-1">
                <!-- Product items will be added here -->
            </ul>
        </div>
    `;

                // Add the dropdown container to the field container
                fieldContainer.appendChild(dropdownContainer);

                // Populate the dropdown list
                const productList = document.getElementById('productList');
                productList.innerHTML = '';

                if (hangHoaList && hangHoaList.length > 0) {
                    hangHoaList.forEach(hangHoa => {
                        const id = hangHoa['ID hàng hoá'] || hangHoa.ID;
                        const tenHangHoa = hangHoa['Tên hàng hoá'] || '';

                        const li = document.createElement('li');
                        li.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                        li.dataset.id = id;
                        li.dataset.displayName = tenHangHoa || id; // Store the display name

                        let displayText = tenHangHoa || id;
                        // You can adjust the display format as needed
                        if (tenHangHoa) {
                            displayText = `${tenHangHoa} (${id})`;
                        }

                        li.textContent = displayText;
                        productList.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.className = 'px-4 py-2 text-gray-500 italic';
                    li.textContent = 'Không có Hàng hoá nào hoặc chưa chọn đơn hàng';
                    productList.appendChild(li);
                }

                // Set up event listeners
                const dropdownBtn = document.getElementById('productDropdownBtn');
                const dropdown = document.getElementById('productDropdown');
                const searchInput = document.getElementById('productSearch');
                const idHangHoaInput = document.getElementById('modalIdHangHoa');

                // Show/hide dropdown
                dropdownBtn.addEventListener('click', () => {
                    dropdown.classList.toggle('hidden');
                    if (!dropdown.classList.contains('hidden')) {
                        searchInput.focus();
                    }
                });

                // Hide dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!dropdownBtn.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });

                // Filter list on search
                searchInput.addEventListener('input', () => {
                    const searchValue = searchInput.value.toLowerCase();
                    const items = productList.querySelectorAll('li');

                    items.forEach(item => {
                        if (item.classList.contains('text-gray-500')) return;

                        const text = item.textContent.toLowerCase();
                        if (text.includes(searchValue)) {
                            item.classList.remove('hidden');
                        } else {
                            item.classList.add('hidden');
                        }
                    });
                });

                // Handle selection - UPDATED to show display name but store ID
                productList.addEventListener('click', (e) => {
                    if (e.target.tagName === 'LI' && !e.target.classList.contains('text-gray-500')) {
                        const id = e.target.dataset.id;
                        const displayName = e.target.textContent; // Use the formatted display text

                        // Show the display name to the user
                        idHangHoaInput.value = displayName;

                        // Store the actual ID in a data attribute for submission
                        idHangHoaInput.dataset.productId = id;

                        dropdown.classList.add('hidden');
                    }
                });
            }

            // Phương thức thêm hàng chi phí hiện có
            // Phương thức thêm hàng chi phí hiện có
            addExistingChiPhiRow(chiPhi) {
                const tableBody = document.getElementById('chiTietTableBody');
                const newRow = document.createElement('tr');
                newRow.classList.add('animate-fade-in');

                // Thiết lập data attributes
                newRow.dataset.loaiChiPhi = chiPhi['Loại chi phí'] || '';
                newRow.dataset.hinhThucChi = chiPhi['Hình thức chi'] || '';
                newRow.dataset.phuongThucTT = chiPhi['Phương thức thanh toán'] || '';
                newRow.dataset.soTienChi = chiPhi['Số tiền chi'] || 0;
                newRow.dataset.ngayChi = chiPhi['Ngày chi'] ? this.formatDateForInput(chiPhi['Ngày chi']) : '';
                newRow.dataset.ghiChu = chiPhi['Ghi chú'] || '';
                newRow.dataset.idDonHang = chiPhi['ID đơn hàng'] || '';
                newRow.dataset.idHangHoa = chiPhi['ID hàng hoá'] || '';
                newRow.dataset.nguoiDeXuat = chiPhi['Người đề xuất chi'] || '';
                newRow.dataset.lichSuCapNhat = chiPhi['Lịch sử cập nhật'] || '';
                newRow.dataset.idChiPhi = chiPhi['ID chi phí'] || '';

                // Lấy tên hiển thị cho ID đơn hàng từ danh sách đơn hàng
                let displayIdDonHang = newRow.dataset.idDonHang;
                if (this.donHangList && newRow.dataset.idDonHang) {
                    const donHang = this.donHangList.find(dh =>
                        (dh['ID đơn hàng'] || dh.ID) === newRow.dataset.idDonHang);
                    if (donHang && donHang['Mã đơn hàng']) {
                        displayIdDonHang = donHang['Mã đơn hàng'];
                        if (donHang['Tên đơn hàng']) {
                            displayIdDonHang += ` || ${donHang['Tên đơn hàng']}`;
                        }
                    }
                }

                // Lấy tên hiển thị cho ID hàng hóa
                let displayIdHangHoa = newRow.dataset.idHangHoa;

                // Tạo nội dung HTML cho hàng
                newRow.innerHTML = `
    <td class="py-3 px-4 border-b border-gray-200">
      <button type="button" class="text-blue-600 hover:text-blue-800" onclick="openChiPhiDetail(this)">
        <i class="fas fa-edit"></i>
      </button>
    </td>
    <td class="py-3 px-4 border-b border-gray-200">${displayIdDonHang}</td>
    <td class="py-3 px-4 border-b border-gray-200">${displayIdHangHoa}</td>
    <td class="py-3 px-4 border-b border-gray-200">
      <select class="w-full p-2 border border-gray-300 rounded-lg hinh-thuc-chi">
        <option value="">-- Chọn --</option>
        <option value="Chi trực tiếp" ${chiPhi['Hình thức chi'] === 'Chi trực tiếp' ? 'selected' : ''}>Chi trực tiếp</option>
        <option value="Chi theo bảng kê" ${chiPhi['Hình thức chi'] === 'Chi theo bảng kê' ? 'selected' : ''}>Chi theo bảng kê</option>
      </select>
    </td>
    <td class="py-3 px-4 border-b border-gray-200">
      <select class="w-full p-2 border border-gray-300 rounded-lg loai-chi-phi">
        <option value="">-- Chọn --</option>
        <option value="Vật tư" ${chiPhi['Loại chi phí'] === 'Vật tư' ? 'selected' : ''}>Vật tư</option>
        <option value="Gia công" ${chiPhi['Loại chi phí'] === 'Gia công' ? 'selected' : ''}>Gia công</option>
        <option value="Vận chuyển" ${chiPhi['Loại chi phí'] === 'Vận chuyển' ? 'selected' : ''}>Vận chuyển</option>
        <option value="In ấn" ${chiPhi['Loại chi phí'] === 'In ấn' ? 'selected' : ''}>In ấn</option>
        <option value="Làm khuôn" ${chiPhi['Loại chi phí'] === 'Làm khuôn' ? 'selected' : ''}>Làm khuôn</option>
        <option value="In nhanh" ${chiPhi['Loại chi phí'] === 'In nhanh' ? 'selected' : ''}>In nhanh</option>
        <option value="Thiết kế" ${chiPhi['Loại chi phí'] === 'Thiết kế' ? 'selected' : ''}>Thiết kế</option>
        <option value="Khác" ${chiPhi['Loại chi phí'] === 'Khác' ? 'selected' : ''}>Khác</option>
        ${!['Vật tư', 'Gia công', 'Vận chuyển', 'In ấn', 'Làm khuôn', 'In nhanh', 'Thiết kế', 'Khác', ''].includes(chiPhi['Loại chi phí']) ?
                        `<option value="${chiPhi['Loại chi phí']}" selected>${chiPhi['Loại chi phí']}</option>` : ''}
      </select>
    </td>
    <td class="py-3 px-4 border-b border-gray-200">
      <select class="w-full p-2 border border-gray-300 rounded-lg phuong-thuc-tt">
        <option value="">-- Chọn --</option>
        <option value="MB" ${chiPhi['Phương thức thanh toán'] === 'MB' ? 'selected' : ''}>MB Ngân hàng Quân Đội (MB Bank)</option>
        <option value="VP" ${chiPhi['Phương thức thanh toán'] === 'VP' ? 'selected' : ''}>VP Ngân hàng VPBank</option>
        <option value="Grab" ${chiPhi['Phương thức thanh toán'] === 'Grab' ? 'selected' : ''}>Grab</option>
      </select>
    </td>
    <td class="py-3 px-4 border-b border-gray-200">
      <select class="w-full p-2 border border-gray-300 rounded-lg nguoi-de-xuat">
        <option value="">-- Chọn --</option>
        <!-- Sẽ được điền bởi JavaScript -->
      </select>
    </td>
    <td class="py-3 px-4 border-b border-gray-200">
      <input type="date" class="w-full p-2 border border-gray-300 rounded-lg ngay-chi" 
        value="${newRow.dataset.ngayChi}">
    </td>
    <td class="py-3 px-4 border-b border-gray-200">
      <input type="number" class="w-full p-2 border border-gray-300 rounded-lg so-tien-chi" 
          min="0" step="1000" value="${chiPhi['Số tiền chi'] || 0}">
    </td>
    <td class="py-3 px-4 border-b border-gray-200">
      <div class="flex space-x-2">
        <button type="button" class="text-green-500 hover:text-green-700" onclick="copyRow(this)">
          <i class="fas fa-copy"></i>
        </button>
        <button type="button" class="text-red-500 hover:text-red-700" onclick="deleteRow(this)">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </td>
    `;

                tableBody.appendChild(newRow);

                // Điền danh sách nhân viên vào dropdown người đề xuất
                const nguoiDeXuatSelect = newRow.querySelector('.nguoi-de-xuat');
                if (nguoiDeXuatSelect && this.nhanVienList) {
                    this.nhanVienList.forEach(nhanVien => {
                        if (nhanVien['Tên nhân viên']) {
                            const option = document.createElement('option');
                            option.value = nhanVien['ID nhân viên'] || nhanVien.ID;
                            let displayName = nhanVien['Tên nhân viên'];
                            if (nhanVien['Mã nhân viên']) {
                                displayName = `${nhanVien['Mã nhân viên']} - ${displayName}`;
                            }
                            option.textContent = displayName;
                            nguoiDeXuatSelect.appendChild(option);
                        }
                    });

                    // Chọn người đề xuất chi từ dữ liệu
                    if (chiPhi['Người đề xuất chi']) {
                        nguoiDeXuatSelect.value = chiPhi['Người đề xuất chi'];
                    }
                }

                // Thêm sự kiện cho input số tiền để tính toán
                const soTienChiInput = newRow.querySelector('.so-tien-chi');
                if (soTienChiInput) {
                    soTienChiInput.addEventListener('input', () => this.calculateRowValues(newRow));
                    soTienChiInput.addEventListener('input', () => this.updateOrderTotals());
                }

                // Thêm sự kiện cho trường ngày
                const ngayChiInput = newRow.querySelector('.ngay-chi');
                if (ngayChiInput) {
                    ngayChiInput.addEventListener('change', (e) => {
                        newRow.dataset.ngayChi = e.target.value;
                    });
                }

                // Thêm sự kiện cho các trường select
                newRow.querySelector('.hinh-thuc-chi').addEventListener('change', (e) => {
                    newRow.dataset.hinhThucChi = e.target.value;
                });

                newRow.querySelector('.loai-chi-phi').addEventListener('change', (e) => {
                    newRow.dataset.loaiChiPhi = e.target.value;
                });

                newRow.querySelector('.phuong-thuc-tt').addEventListener('change', (e) => {
                    newRow.dataset.phuongThucTT = e.target.value;
                });

                newRow.querySelector('.nguoi-de-xuat').addEventListener('change', (e) => {
                    newRow.dataset.nguoiDeXuat = e.target.value;
                });

                this.calculateRowValues(newRow);
            }


            // Cập nhật phương thức loadExistingBangKeList để điền vào dropdown tùy chỉnh
            async loadExistingBangKeList() {
                try {
                    this.showLoading('Đang tải danh sách bảng kê...');

                    const response = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${this.appId}/tables/Bảng kê công nợ phải trả/Action`,
                        headers: {
                            'ApplicationAccessKey': this.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Find",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh",
                                "Selector": "Filter(Bảng kê công nợ phải trả, true)"
                            }
                        }
                    });

                    if (response.data && response.data.Rows) {
                        this.bangKeList = response.data.Rows;
                    } else if (Array.isArray(response.data)) {
                        this.bangKeList = response.data;
                    } else {
                        console.error('Cấu trúc dữ liệu bảng kê không đúng:', response.data);
                        this.bangKeList = [];
                    }

                    // Cập nhật dropdown tùy chỉnh
                    const bangKeList = document.getElementById('bangKeList');
                    bangKeList.innerHTML = '';

                    this.bangKeList.forEach(bangKe => {
                        // Lấy mã bảng kê từ ID hoặc từ trường mã nếu có
                        const id = bangKe['ID bảng kê công nợ phải trả'] || bangKe.ID;
                        const maBangKe = bangKe['Mã bảng kê công nợ phải trả'] || id; // Ưu tiên lấy mã nếu có

                        // Tạo mục danh sách
                        const li = document.createElement('li');
                        li.className = 'px-4 py-2 hover:bg-gray-100 cursor-pointer';
                        li.dataset.id = id; // Lưu ID để xử lý dữ liệu

                        // Hiển thị mã bảng kê + thông tin nhà cung cấp
                        let displayText = maBangKe; // Hiển thị mã thay vì ID
                        const nhaCungCapId = bangKe['ID nhà cung cấp'];
                        if (nhaCungCapId && this.nhaCungCapList) {
                            const nhaCungCap = this.nhaCungCapList.find(ncc =>
                                (ncc['ID nhà cung cấp'] || ncc.ID) === nhaCungCapId);
                            if (nhaCungCap) {
                                displayText += ` - ${nhaCungCap['Tên nhà cung cấp'] || nhaCungCap.Ten}`;
                            }
                        }

                        li.textContent = displayText;
                        bangKeList.appendChild(li);
                    });


                    this.hideLoading();
                } catch (error) {
                    console.error('Lỗi khi tải danh sách bảng kê:', error);
                    this.hideLoading();
                    this.showAlert('error', 'Lỗi kết nối', 'Không thể tải danh sách bảng kê. Vui lòng thử lại sau.');
                }
            }

            // This function fetches and displays all info when a bangKe is selected
            async handleBangKeSelection(selectedId) {
                if (!selectedId) {
                    // Nếu không có ID được chọn, không làm gì
                    return;
                }

                try {
                    this.showLoading('Đang tải thông tin bảng kê...');

                    // Tìm thông tin bảng kê từ danh sách đã tải
                    const selectedBangKe = this.bangKeList.find(bangKe =>
                        (bangKe['ID bảng kê công nợ phải trả'] || bangKe.ID) === selectedId);

                    if (selectedBangKe) {
                        // Sử dụng Mã bảng kê thay vì ID để hiển thị
                        const maBangKe = selectedBangKe['Mã bảng kê công nợ phải trả'] || selectedId;
                        document.getElementById('maBangKe').value = maBangKe;

                        // Chọn nhà cung cấp
                        if (selectedBangKe['ID nhà cung cấp'] && this.nhaCungCapChoices) {
                            this.nhaCungCapChoices.setChoiceByValue(selectedBangKe['ID nhà cung cấp']);
                        }

                        // Trạng thái duyệt
                        document.getElementById('trangThaiDuyet').value = selectedBangKe['Trạng thái duyệt'] || 'Chưa duyệt';

                        // Người duyệt
                        if (selectedBangKe['Người duyệt'] && this.nguoiDuyetChoices) {
                            this.nguoiDuyetChoices.setChoiceByValue(selectedBangKe['Người duyệt']);
                        }

                        // Ngày chi - Chuyển đổi định dạng ngày từ MM/DD/YYYY sang YYYY-MM-DD
                        if (selectedBangKe['Ngày chi']) {
                            const ngayChi = this.formatDateForInput(selectedBangKe['Ngày chi']);
                            document.getElementById('ngayChi').value = ngayChi;
                        }

                        // Người chi
                        if (selectedBangKe['Người chi'] && this.nguoiChiChoices) {
                            this.nguoiChiChoices.setChoiceByValue(selectedBangKe['Người chi']);
                        }

                        // Ngày tạo - Chuyển đổi định dạng ngày từ MM/DD/YYYY sang YYYY-MM-DD
                        if (selectedBangKe['Ngày tạo']) {
                            const ngayTao = this.formatDateForInput(selectedBangKe['Ngày tạo']);
                            document.getElementById('ngayTao').value = ngayTao;
                        }

                        // Tính tổng chi phí
                        document.getElementById('tongChiPhi').value = this.formatCurrency(selectedBangKe['Tổng chi phí'] || 0);

                        // Lưu ID bảng kê đã chọn để dùng khi xem dữ liệu chi tiết
                        this.selectedBangKeId = selectedId;

                        // Cập nhật trạng thái tiến trình
                        this.updateProgressSteps(2);
                    }

                    this.hideLoading();
                } catch (error) {
                    console.error('Lỗi khi tải thông tin bảng kê:', error);
                    this.hideLoading();
                    this.showAlert('error', 'Lỗi kết nối', 'Không thể tải thông tin bảng kê. Vui lòng thử lại sau.');
                }
            }

            // Định dạng ngày cho input HTML (từ MM/DD/YYYY hoặc các định dạng khác sang YYYY-MM-DD)
            formatDateForInput(dateString) {
                if (!dateString) return '';

                // Kiểm tra nếu dateString đã đúng định dạng YYYY-MM-DD
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateString)) {
                    return dateString;
                }

                // Parse dateString thành một đối tượng Date
                let date;

                // Thử với các định dạng khác nhau
                if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString)) {
                    // Định dạng MM/DD/YYYY
                    const parts = dateString.split('/');
                    date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                } else if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(dateString)) {
                    // Định dạng MM-DD-YYYY
                    const parts = dateString.split('-');
                    date = new Date(parseInt(parts[2]), parseInt(parts[0]) - 1, parseInt(parts[1]));
                } else {
                    // Thử chuyển đổi trực tiếp
                    date = new Date(dateString);
                }

                // Kiểm tra nếu date hợp lệ
                if (isNaN(date.getTime())) {
                    console.error('Không thể chuyển đổi ngày:', dateString);
                    return ''; // Trả về chuỗi rỗng nếu không thể chuyển đổi
                }

                // Format sang YYYY-MM-DD
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');

                return `${year}-${month}-${day}`;
            }

            // Thêm code xử lý dropdown bảng kê tùy chỉnh
            setupBangKeDropdown() {
                const dropdownBtn = document.getElementById('bangKeDropdownBtn');
                const dropdown = document.getElementById('bangKeDropdown');
                const searchInput = document.getElementById('bangKeSearch');
                const bangKeList = document.getElementById('bangKeList');
                const maBangKeInput = document.getElementById('maBangKe');

                // Hiển thị/ẩn dropdown khi click vào nút
                dropdownBtn.addEventListener('click', () => {
                    dropdown.classList.toggle('hidden');
                    if (!dropdown.classList.contains('hidden')) {
                        searchInput.focus();
                    }
                });

                // Ẩn dropdown khi click ra ngoài
                document.addEventListener('click', (e) => {
                    if (!dropdownBtn.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });

                // Lọc danh sách khi tìm kiếm
                searchInput.addEventListener('input', () => {
                    const searchValue = searchInput.value.toLowerCase();
                    const items = bangKeList.querySelectorAll('li');

                    items.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        if (text.includes(searchValue)) {
                            item.classList.remove('hidden');
                        } else {
                            item.classList.add('hidden');
                        }
                    });
                });

                // Khi chọn một mã từ danh sách
                bangKeList.addEventListener('click', (e) => {
                    if (e.target.tagName === 'LI') {
                        const id = e.target.dataset.id;
                        maBangKeInput.value = id;
                        dropdown.classList.add('hidden');

                        // Kích hoạt xử lý chọn bảng kê
                        this.handleBangKeSelection(id);
                    }
                });

                // Khi nhập mã bảng kê trực tiếp
                maBangKeInput.addEventListener('input', (e) => {
                    const newValue = e.target.value;
                    if (newValue) {
                        // Kiểm tra xem mã này đã tồn tại chưa
                        const existingOption = this.bangKeList.find(bangKe =>
                            (bangKe['ID bảng kê công nợ phải trả'] || bangKe.ID) === newValue);

                        if (existingOption) {
                            // Nếu đã tồn tại, xử lý
                            this.handleBangKeSelection(newValue);
                        }
                    }
                });
            }

            // Thiết lập sự kiện
            setupEventListeners() {
                // Khởi tạo quản lý dropdown tùy chỉnh
                this.loaiChiPhiManager = new CustomDropdownManager('modalLoaiChiPhi', 'savedLoaiChiPhi');

                // Sự kiện cho dropdowns trong modal
                document.getElementById('modalLoaiChiPhi').addEventListener('change', function () {
                    const customInput = document.getElementById('modalLoaiChiPhiCustom');
                    if (this.value === 'custom') {
                        customInput.classList.remove('hidden');
                        customInput.focus();
                    } else {
                        customInput.classList.add('hidden');
                        customInput.value = '';
                    }
                });

                // Nút thêm nhà cung cấp
                document.getElementById('btnThemNhaCungCap').addEventListener('click', () => this.openNhaCungCapModal());

                // Form nhà cung cấp
                document.getElementById('nhaCungCapForm').addEventListener('submit', (e) => this.handleThemNhaCungCap(e));

                // Các nút chức năng
                document.getElementById('btnTaoChiTiet').addEventListener('click', () => this.addNewRow());
                document.getElementById('resetFormBtn').addEventListener('click', () => this.confirmResetForm());
                document.getElementById('cancelBtn').addEventListener('click', () => this.confirmCancelChiPhi());
                document.getElementById('saveAll').addEventListener('click', () => this.saveDataToAppSheet());

                // Import/Export - Thêm dòng này
                document.getElementById('importBtn').addEventListener('click', () => this.openImportModal());

                document.getElementById('btnChonFile').addEventListener('click', () => document.getElementById('fileInput').click());
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileSelect(e));
                document.getElementById('btnTaiMauNhap').addEventListener('click', () => this.downloadImportTemplate());
                document.getElementById('btnNhapDuLieu').addEventListener('click', () => this.importDataFromExcel());

                // Form chi tiết chi phí
                document.getElementById('chiPhiDetailForm').addEventListener('submit', (e) => this.handleUpdateChiPhi(e));

                // Sự kiện tính toán trong modal
                ['modalSoTienChi'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => this.calculateModalValues());
                });

                // Expose window methods for HTML event handlers
                window.deleteRow = (btn) => this.deleteRow(btn);
                window.openChiPhiDetail = (btn) => this.openChiPhiDetail(btn);
                window.closeChiPhiDetailModal = () => this.closeChiPhiDetailModal();
                window.openNhaCungCapModal = () => this.openNhaCungCapModal();
                window.closeNhaCungCapModal = () => this.closeNhaCungCapModal();
                window.copyRow = (btn) => this.copyRow(btn);
                window.closeImportModal = () => this.closeImportModal(); // Thêm dòng này

                // Thêm hàm này vào window object để có thể gọi từ HTML
                window.showRowError = function (button) {
                    const row = button.closest('tr');
                    const errorMessages = JSON.parse(row.dataset.errorMessages || '[]');

                    if (errorMessages.length > 0) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Chi tiết lỗi',
                            html: `
                <div class="text-left">
                    <ul class="list-disc list-inside">
                        ${errorMessages.map(msg => `<li class="text-red-600">${msg}</li>`).join('')}
                    </ul>
                </div>
            `,
                            confirmButtonText: 'Đóng',
                            confirmButtonColor: '#0ea5e9'
                        });
                    }
                };
            }

            // Trong phương thức setupEventListeners() của class BangKeCongNoManager
            // Thêm code xử lý dropdown bảng kê tùy chỉnh
            setupBangKeDropdown() {
                const dropdownBtn = document.getElementById('bangKeDropdownBtn');
                const dropdown = document.getElementById('bangKeDropdown');
                const searchInput = document.getElementById('bangKeSearch');
                const bangKeList = document.getElementById('bangKeList');
                const maBangKeInput = document.getElementById('maBangKe');

                // Hiển thị/ẩn dropdown khi click vào nút
                dropdownBtn.addEventListener('click', () => {
                    dropdown.classList.toggle('hidden');
                    if (!dropdown.classList.contains('hidden')) {
                        searchInput.focus();
                    }
                });

                // Ẩn dropdown khi click ra ngoài
                document.addEventListener('click', (e) => {
                    if (!dropdownBtn.contains(e.target) && !dropdown.contains(e.target)) {
                        dropdown.classList.add('hidden');
                    }
                });

                // Lọc danh sách khi tìm kiếm
                searchInput.addEventListener('input', () => {
                    const searchValue = searchInput.value.toLowerCase();
                    const items = bangKeList.querySelectorAll('li');

                    items.forEach(item => {
                        const text = item.textContent.toLowerCase();
                        if (text.includes(searchValue)) {
                            item.classList.remove('hidden');
                        } else {
                            item.classList.add('hidden');
                        }
                    });
                });

                // Khi chọn một mã từ danh sách
                bangKeList.addEventListener('click', (e) => {
                    if (e.target.tagName === 'LI') {
                        const id = e.target.dataset.id;
                        maBangKeInput.value = id;
                        dropdown.classList.add('hidden');

                        // Kích hoạt xử lý chọn bảng kê
                        this.handleBangKeSelection(id);
                    }
                });

                // Khi nhập mã bảng kê trực tiếp
                maBangKeInput.addEventListener('input', (e) => {
                    const newValue = e.target.value;
                    if (newValue) {
                        // Kiểm tra xem mã này đã tồn tại chưa
                        const existingOption = this.bangKeList.find(bangKe =>
                            (bangKe['ID bảng kê công nợ phải trả'] || bangKe.ID) === newValue);

                        if (existingOption) {
                            // Nếu đã tồn tại, xử lý
                            this.handleBangKeSelection(newValue);
                        }
                    }
                });
            }

            // Tạo mã bảng kê mới
            generateNewBangKeCode() {
                document.getElementById('maBangKe').value = this.generateMaBangKe();
            }

            // Thiết lập ngày mặc định
            setDefaultDate() {
                const today = new Date();
                document.getElementById('ngayTao').value = this.formatDate(today);
                document.getElementById('ngayChi').value = this.formatDate(today);
            }

            // Tạo mã bảng kê
            generateMaBangKe() {
                const today = new Date();
                const year = today.getFullYear().toString().slice(-2); // Lấy 2 số cuối của năm
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                return `BK${year}${month}${day}`;
            }

            // Định dạng ngày
            formatDate(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            // Định dạng tiền tệ
            formatCurrency(number) {
                if (number === null || number === undefined || isNaN(number)) return "0";
                return new Intl.NumberFormat('vi-VN', {
                    style: 'decimal',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(number);
            }

            // Chuyển đổi từ chuỗi tiền về số
            parseCurrency(currencyString) {
                if (!currencyString) return 0;
                return parseFloat(String(currencyString).replace(/\./g, '').replace(/,/g, '.'));
            }

            // Tạo ID cho chi phí
            generateChiPhiID(maBangKe, index) {
                return `${maBangKe}-CP${String(index).padStart(3, '0')}`;
            }

            // Hiển thị loading
            showLoading(message = 'Đang xử lý...') {
                const loadingText = document.getElementById('loadingText');
                const loadingOverlay = document.getElementById('loadingOverlay');

                if (loadingText) loadingText.textContent = message;
                if (loadingOverlay) {
                    loadingOverlay.classList.remove('hidden');
                } else {
                    console.error('Loading overlay element not found');
                }
            }

            // Ẩn loading
            hideLoading() {
                document.getElementById('loadingOverlay').classList.add('hidden');
            }

            // Hiển thị thông báo
            showAlert(icon, title, text = '') {
                return Swal.fire({
                    icon,
                    title,
                    text,
                    confirmButtonColor: icon === 'error' ? '#d33' : '#0ea5e9'
                });
            }

            // Cập nhật tiến trình
            updateProgressSteps(step) {
                if (step >= 1) {
                    document.getElementById('progress1').style.width = '100%';
                } else {
                    document.getElementById('progress1').style.width = '0%';
                }

                if (step >= 2) {
                    document.getElementById('step2').classList.remove('bg-gray-300', 'text-gray-600');
                    document.getElementById('step2').classList.add('bg-primary-600', 'text-white');
                    document.getElementById('progress2').style.width = '100%';
                } else {
                    document.getElementById('step2').classList.add('bg-gray-300', 'text-gray-600');
                    document.getElementById('step2').classList.remove('bg-primary-600', 'text-white');
                    document.getElementById('progress2').style.width = '0%';
                }

                if (step >= 3) {
                    document.getElementById('step3').classList.remove('bg-gray-300', 'text-gray-600');
                    document.getElementById('step3').classList.add('bg-primary-600', 'text-white');
                } else {
                    document.getElementById('step3').classList.add('bg-gray-300', 'text-gray-600');
                    document.getElementById('step3').classList.remove('bg-primary-600', 'text-white');
                }
            }

            // Tải danh sách nhà cung cấp
            async loadNhaCungCapList() {
                try {
                    const response = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${this.appId}/tables/Nhà cung cấp/Action`,
                        headers: {
                            'ApplicationAccessKey': this.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Find",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh",
                                "Selector": "Filter(Nhà cung cấp, true)"
                            }
                        }
                    });

                    if (response.data && response.data.Rows) {
                        this.nhaCungCapList = response.data.Rows;
                    } else if (Array.isArray(response.data)) {
                        this.nhaCungCapList = response.data;
                    } else {
                        console.error('Cấu trúc dữ liệu nhà cung cấp không đúng:', response.data);
                        this.nhaCungCapList = [];
                    }

                    // Khởi tạo Choices.js cho select nhà cung cấp
                    const nhaCungCapSelect = document.getElementById('nhaCungCap');
                    nhaCungCapSelect.innerHTML = '<option value="">-- Chọn nhà cung cấp --</option>';

                    this.nhaCungCapList.forEach(ncc => {
                        const option = document.createElement('option');
                        option.value = ncc['ID nhà cung cấp'] || ncc.ID;
                        option.textContent = ncc['Tên nhà cung cấp'] || ncc.Ten;
                        nhaCungCapSelect.appendChild(option);
                    });

                    // Khởi tạo Choices
                    if (this.nhaCungCapChoices) {
                        this.nhaCungCapChoices.destroy();
                    }

                    this.nhaCungCapChoices = new Choices('#nhaCungCap', {
                        searchEnabled: true,
                        searchPlaceholderValue: 'Nhập tên để tìm...',
                        noResultsText: 'Không tìm thấy nhà cung cấp',
                        itemSelectText: 'Chọn',
                        removeItemButton: true,
                        searchFields: ['label'],
                        position: 'bottom'
                    });

                    this.hideLoading();
                } catch (error) {
                    console.error('Lỗi khi tải danh sách nhà cung cấp:', error);
                    this.hideLoading();
                    this.showAlert('error', 'Lỗi kết nối', 'Không thể tải danh sách nhà cung cấp. Vui lòng thử lại sau.');
                }
            }

            // Tải danh sách nhân viên
            async loadNhanVienList() {
                try {
                    const response = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${this.appId}/tables/Nhân viên/Action`,
                        headers: {
                            'ApplicationAccessKey': this.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Find",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh",
                                "Selector": "Filter(Nhân viên, true)"
                            }
                        }
                    });

                    if (response.data && response.data.Rows) {
                        this.nhanVienList = response.data.Rows;
                    } else if (Array.isArray(response.data)) {
                        this.nhanVienList = response.data;
                    } else {
                        console.error('Cấu trúc dữ liệu nhân viên không đúng:', response.data);
                        this.nhanVienList = [];
                    }

                    // Khởi tạo các select nhân viên
                    const selectors = ['nguoiDuyet', 'nguoiChi', 'modalNguoiDeXuatChi', 'modalNguoiDuyetChi'];

                    selectors.forEach(selector => {
                        const select = document.getElementById(selector);
                        if (select) {
                            select.innerHTML = '<option value="">-- Chọn nhân viên --</option>';

                            this.nhanVienList.forEach(nhanVien => {
                                const option = document.createElement('option');
                                option.value = nhanVien['ID nhân viên'] || nhanVien.ID;
                                option.textContent = nhanVien['Tên nhân viên'] || nhanVien.Ten;
                                if (option.textContent) {
                                    // Thêm mã nhân viên nếu có
                                    if (nhanVien['Mã nhân viên']) {
                                        option.textContent = `${nhanVien['Mã nhân viên']} - ${option.textContent}`;
                                    }
                                    select.appendChild(option);
                                }
                            });
                        }
                    });

                    // Khởi tạo Choices cho nguoiDuyet và nguoiChi
                    ['nguoiDuyet', 'nguoiChi'].forEach(id => {
                        if (this[`${id}Choices`]) {
                            this[`${id}Choices`].destroy();
                        }

                        this[`${id}Choices`] = new Choices(`#${id}`, {
                            searchEnabled: true,
                            searchPlaceholderValue: 'Nhập tên để tìm...',
                            noResultsText: 'Không tìm thấy nhân viên',
                            itemSelectText: 'Chọn',
                            removeItemButton: true,
                            searchFields: ['label'],
                            position: 'bottom'
                        });
                    });

                } catch (error) {
                    console.error('Lỗi khi tải danh sách nhân viên:', error);
                    this.showAlert('error', 'Lỗi kết nối', 'Không thể tải danh sách nhân viên. Vui lòng thử lại sau.');
                }
            }

            // Xác nhận reset form
            confirmResetForm() {
                Swal.fire({
                    title: 'Xác nhận làm mới',
                    text: 'Bạn có chắc muốn làm mới toàn bộ form không?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#0ea5e9',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Đồng ý',
                    cancelButtonText: 'Hủy'
                }).then((result) => {
                    if (result.isConfirmed) {
                        this.resetForm();
                    }
                });
            }

            // Xác nhận hủy chi phí
            confirmCancelChiPhi() {
                Swal.fire({
                    title: 'Xác nhận hủy',
                    text: 'Bạn có chắc muốn hủy danh sách chi phí hiện tại?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#0ea5e9',
                    cancelButtonColor: '#6b7280',
                    confirmButtonText: 'Đồng ý',
                    cancelButtonText: 'Không'
                }).then((result) => {
                    if (result.isConfirmed) {
                        document.getElementById('chiTietTableBody').innerHTML = '';
                        document.getElementById('chiTietSection').classList.add('hidden');
                        this.updateProgressSteps(1);
                    }
                });
            }

            // Làm mới form
            resetForm() {
                // Làm mới form công nợ
                document.getElementById('bangKeForm').reset();

                // Tạo mã mới
                this.generateNewBangKeCode();

                // Thiết lập ngày mặc định
                this.setDefaultDate();

                // Xóa tất cả chi phí
                document.getElementById('chiTietTableBody').innerHTML = '';

                // Ẩn phần chi tiết
                document.getElementById('chiTietSection').classList.add('hidden');

                // Đặt lại trạng thái xem dữ liệu
                document.getElementById('dataStatusText').textContent = '';
                this.selectedBangKeId = null;

                // Cập nhật trạng thái tiến trình
                this.updateProgressSteps(1);
            }

            // Thêm hàng mới
            addNewRow() {
                document.getElementById('chiTietSection').classList.remove('hidden');
                const tableBody = document.getElementById('chiTietTableBody');
                const newRow = document.createElement('tr');
                newRow.classList.add('animate-fade-in');

                // Khởi tạo các giá trị mặc định cho data attributes
                newRow.dataset.loaiChiPhi = '';
                newRow.dataset.idDonHang = '';
                newRow.dataset.idHangHoa = '';
                newRow.dataset.soTienChi = '0';
                newRow.dataset.ngayChi = this.formatDate(new Date());
                newRow.dataset.ghiChu = '';

                // Nội dung hàng chi phí
                newRow.innerHTML = `
    <td class="py-3 px-4 border-b border-gray-200">
      <button type="button" class="text-blue-600 hover:text-blue-800" onclick="openChiPhiDetail(this)">
        <i class="fas fa-edit"></i>
      </button>
    </td>
    <td class="py-3 px-4 border-b border-gray-200">${newRow.dataset.idDonHang}</td>
    <td class="py-3 px-4 border-b border-gray-200">${newRow.dataset.idHangHoa}</td>
    <td class="py-3 px-4 border-b border-gray-200">
      <select class="w-full p-2 border border-gray-300 rounded-lg hinh-thuc-chi">
        <option value="">-- Chọn --</option>
        <option value="Chi trực tiếp">Chi trực tiếp</option>
        <option value="Chi theo bảng kê">Chi theo bảng kê</option>
      </select>
    </td>
    <td class="py-3 px-4 border-b border-gray-200">
      <select class="w-full p-2 border border-gray-300 rounded-lg loai-chi-phi">
        <option value="">-- Chọn --</option>
        <option value="Vật tư">Vật tư</option>
        <option value="Gia công">Gia công</option>
        <option value="Vận chuyển">Vận chuyển</option>
        <option value="In ấn">In ấn</option>
        <option value="Làm khuôn">Làm khuôn</option>
        <option value="In nhanh">In nhanh</option>
        <option value="Thiết kế">Thiết kế</option>
        <option value="Khác">Khác</option>
      </select>
    </td>
    <td class="py-3 px-4 border-b border-gray-200">
      <select class="w-full p-2 border border-gray-300 rounded-lg phuong-thuc-tt">
        <option value="">-- Chọn --</option>
        <option value="MB">MB Ngân hàng Quân Đội (MB Bank)</option>
        <option value="VP">VP Ngân hàng VPBank</option>
        <option value="Grab">Grab</option>
      </select>
    </td>
    <td class="py-3 px-4 border-b border-gray-200">
      <select class="w-full p-2 border border-gray-300 rounded-lg nguoi-de-xuat">
        <option value="">-- Chọn --</option>
        <!-- Sẽ được điền bởi JavaScript -->
      </select>
    </td>
    <td class="py-3 px-4 border-b border-gray-200">
      <input type="date" class="w-full p-2 border border-gray-300 rounded-lg ngay-chi" 
        value="${newRow.dataset.ngayChi}">
    </td>
    <td class="py-3 px-4 border-b border-gray-200">
      <input type="number" class="w-full p-2 border border-gray-300 rounded-lg so-tien-chi" 
          min="0" step="1000" value="0">
    </td>
    <td class="py-3 px-4 border-b border-gray-200">
      <div class="flex space-x-2">
        <button type="button" class="text-green-500 hover:text-green-700" onclick="copyRow(this)">
          <i class="fas fa-copy"></i>
        </button>
        <button type="button" class="text-red-500 hover:text-red-700" onclick="deleteRow(this)">
          <i class="fas fa-trash"></i>
        </button>
      </div>
    </td>
    `;
                tableBody.appendChild(newRow);

                // Điền danh sách nhân viên vào dropdown người đề xuất
                const nguoiDeXuatSelect = newRow.querySelector('.nguoi-de-xuat');
                if (nguoiDeXuatSelect && this.nhanVienList) {
                    this.nhanVienList.forEach(nhanVien => {
                        if (nhanVien['Tên nhân viên']) {
                            const option = document.createElement('option');
                            option.value = nhanVien['ID nhân viên'] || nhanVien.ID;
                            let displayName = nhanVien['Tên nhân viên'];
                            if (nhanVien['Mã nhân viên']) {
                                displayName = `${nhanVien['Mã nhân viên']} - ${displayName}`;
                            }
                            option.textContent = displayName;
                            nguoiDeXuatSelect.appendChild(option);
                        }
                    });

                    // Nếu có employeeName, chọn nhân viên hiện tại
                    if (this.employeeName) {
                        const foundEmployee = this.nhanVienList.find(nv =>
                            nv['Tên nhân viên'] === this.employeeName ||
                            (nv['Mã nhân viên'] && nv['Mã nhân viên'] + ' - ' + nv['Tên nhân viên'] === this.employeeName)
                        );

                        if (foundEmployee) {
                            nguoiDeXuatSelect.value = foundEmployee['ID nhân viên'] || foundEmployee.ID;
                        }
                    }
                }

                // Thêm sự kiện cho input số tiền để tính toán
                const soTienChiInput = newRow.querySelector('.so-tien-chi');
                if (soTienChiInput) {
                    soTienChiInput.addEventListener('input', () => this.calculateRowValues(newRow));
                    soTienChiInput.addEventListener('input', () => this.updateOrderTotals());
                }

                // Thêm sự kiện cho trường ngày
                const ngayChiInput = newRow.querySelector('.ngay-chi');
                if (ngayChiInput) {
                    ngayChiInput.addEventListener('change', (e) => {
                        newRow.dataset.ngayChi = e.target.value;
                    });
                }

                // Thêm sự kiện cho các trường select
                newRow.querySelector('.hinh-thuc-chi').addEventListener('change', (e) => {
                    newRow.dataset.hinhThucChi = e.target.value;
                });

                newRow.querySelector('.loai-chi-phi').addEventListener('change', (e) => {
                    newRow.dataset.loaiChiPhi = e.target.value;
                });

                newRow.querySelector('.phuong-thuc-tt').addEventListener('change', (e) => {
                    newRow.dataset.phuongThucTT = e.target.value;
                });

                newRow.querySelector('.nguoi-de-xuat').addEventListener('change', (e) => {
                    newRow.dataset.nguoiDeXuat = e.target.value;
                });

                this.calculateRowValues(newRow);
                newRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
                this.updateProgressSteps(2);
            }

            // Xóa hàng
            deleteRow(button) {
                const row = button.closest('tr');
                row.classList.add('animate-fade-out');

                setTimeout(() => {
                    row.remove();

                    // Cập nhật tổng số sau khi xóa
                    this.updateOrderTotals();

                    // Ẩn phần chi tiết nếu không còn hàng nào
                    if (document.getElementById('chiTietTableBody').children.length === 0) {
                        document.getElementById('chiTietSection').classList.add('hidden');
                        // Cập nhật trạng thái tiến trình
                        this.updateProgressSteps(1);
                    }
                }, 300);
            }

            // Cập nhật hàm tính toán giá trị hàng
            calculateRowValues(row) {
                if (!row) return;

                const soTienChiInput = row.querySelector('.so-tien-chi');
                if (!soTienChiInput) return;

                // Lấy giá trị số tiền chi
                const soTienChi = parseFloat(soTienChiInput.value) || 0;

                // Lưu vào data attribute để tính toán
                row.dataset.soTienChi = soTienChi;

                // Cập nhật tổng giá trị
                this.updateOrderTotals();
            }

            // Cập nhật tổng giá trị
            updateOrderTotals() {
                const rows = document.querySelectorAll('#chiTietTableBody tr');
                let tongChiPhi = 0;

                rows.forEach(row => {
                    // Sử dụng giá trị từ data attribute
                    tongChiPhi += parseFloat(row.dataset.soTienChi) || 0;
                });

                // Cập nhật trường với giá trị định dạng
                document.getElementById('tongChiPhi').value = this.formatCurrency(tongChiPhi);
            }

            // Tạo ID duy nhất cho chi phí
            generateUniqueID() {
                // Tạo UUID v4
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    const r = Math.random() * 16 | 0;
                    const v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            }

            // Thu thập dữ liệu từ bảng chi tiết chi phí (tiếp tục)
            collectChiPhiData() {
                const maBangKe = document.getElementById('maBangKe').value;
                const chiPhiRows = document.querySelectorAll('#chiTietTableBody tr');
                const chiPhiItems = [];

                chiPhiRows.forEach((row, index) => {
                    // Lấy các giá trị từ hàng hiện tại
                    const hinhThucChi = row.querySelector('.hinh-thuc-chi').value;
                    const loaiChiPhi = row.querySelector('.loai-chi-phi').value;
                    const phuongThucTT = row.querySelector('.phuong-thuc-tt').value;
                    const nguoiDeXuat = row.querySelector('.nguoi-de-xuat').value;
                    const ngayChi = row.querySelector('.ngay-chi').value;
                    const soTienChi = parseFloat(row.querySelector('.so-tien-chi').value) || 0;

                    // Lấy ID đơn hàng và hàng hóa từ data attributes
                    const idDonHang = row.dataset.idDonHang || '';
                    const idHangHoa = row.dataset.idHangHoa || '';
                    const ghiChu = row.dataset.ghiChu || '';
                    const idChiPhi = row.dataset.idChiPhi || this.generateUniqueID();

                    // ID nhà cung cấp từ form chính
                    const idNhaCungCap = document.getElementById('nhaCungCap').value;

                    // Tạo đối tượng chi phí
                    const chiPhiItem = {
                        'ID chi phí': idChiPhi,
                        'ID đơn hàng': idDonHang,
                        'ID hàng hoá': idHangHoa,
                        'Mã đơn hàng': maBangKe,
                        'ID bảng kê công nợ phải trả': maBangKe,
                        'Hình thức chi': hinhThucChi,
                        'Loại chi phí': loaiChiPhi,
                        'ID nhà cung cấp': idNhaCungCap,
                        'Phương thức thanh toán': phuongThucTT,
                        'Ngày chi': ngayChi,
                        'Người đề xuất chi': nguoiDeXuat,
                        'Số tiền chi': soTienChi,
                        'Ghi chú': ghiChu,
                        'Lịch sử cập nhật': row.dataset.lichSuCapNhat || (this.formatDate(new Date()) + ' - Tạo mới'),
                        'Người tạo': this.employeeName
                    };

                    chiPhiItems.push(chiPhiItem);
                });

                return chiPhiItems;
            }

            // Lưu dữ liệu vào AppSheet
            async saveDataToAppSheet() {
                try {
                    // Kiểm tra các trường bắt buộc
                    const maBangKe = document.getElementById('maBangKe').value;
                    const ngayTao = document.getElementById('ngayTao').value;

                    if (!maBangKe || !ngayTao) {
                        throw new Error('Vui lòng điền đầy đủ thông tin bắt buộc: Mã bảng kê, Nhà cung cấp, Ngày tạo');
                    }

                    // Kiểm tra danh sách chi phí
                    const chiPhiRows = document.querySelectorAll('#chiTietTableBody tr');
                    if (chiPhiRows.length === 0) {
                        throw new Error('Vui lòng thêm ít nhất một chi phí vào bảng kê');
                    }

                    // Tạo promise toast thay vì loading overlay
                    const savePromise = new Promise(async (resolve, reject) => {
                        try {
                            // Thu thập dữ liệu bảng kê
                            const bangKeData = {
                                'ID bảng kê công nợ phải trả': maBangKe,
                                'Mã bảng kê công nợ phải trả': maBangKe,
                                'ID nhà cung cấp': document.getElementById('nhaCungCap').value,
                                'Trạng thái duyệt': document.getElementById('trangThaiDuyet').value,
                                'Người duyệt': document.getElementById('nguoiDuyet').value,
                                'Ngày chi': document.getElementById('ngayChi').value,
                                'Người chi': document.getElementById('nguoiChi').value,
                                'Ngày tạo': ngayTao,
                                'Người tạo': this.employeeName
                            };

                            // Tạo payload cho bảng kê
                            const bangKePayload = {
                                "Action": "Add",
                                "Properties": {},
                                "Rows": [bangKeData]
                            };

                            // Thu thập dữ liệu chi phí
                            this.chiPhiList = this.collectChiPhiData();

                            // Kiểm tra chi phí
                            for (const item of this.chiPhiList) {
                                if (!item['Hình thức chi']) {
                                    throw new Error('Vui lòng chọn hình thức chi cho tất cả các chi phí');
                                }
                                if (!item['Loại chi phí']) {
                                    throw new Error('Vui lòng chọn loại chi phí cho tất cả các chi phí');
                                }
                                if (!item['Số tiền chi'] || item['Số tiền chi'] <= 0) {
                                    throw new Error('Vui lòng nhập số tiền chi hợp lệ cho tất cả các chi phí');
                                }
                            }

                            // Tạo payload chi phí
                            const chiPhiPayload = {
                                "Action": "Add",
                                "Properties": {},
                                "Rows": this.chiPhiList
                            };

                            // Use Promise.all to send both requests at the same time
                            const [responseBangKe, responseChiPhi] = await Promise.all([
                                axios({
                                    method: 'POST',
                                    url: `https://www.appsheet.com/api/v2/apps/${this.appId}/tables/Bảng kê công nợ phải trả/Action`,
                                    headers: {
                                        'ApplicationAccessKey': this.accessKey,
                                        'Content-Type': 'application/json',
                                        'Accept': 'application/json'
                                    },
                                    data: bangKePayload
                                }),
                                axios({
                                    method: 'POST',
                                    url: `https://www.appsheet.com/api/v2/apps/${this.appId}/tables/Chi phí sản xuất/Action`,
                                    headers: {
                                        'ApplicationAccessKey': this.accessKey,
                                        'Content-Type': 'application/json'
                                    },
                                    data: chiPhiPayload
                                })
                            ]);

                            // Log API responses for debugging
                            console.log('Bảng kê response:', responseBangKe.status, responseBangKe.data);
                            console.log('Chi phí response:', responseChiPhi.status, responseChiPhi.data);

                            // Check results
                            if (responseBangKe.status !== 200) {
                                throw new Error(`API Error: ${responseBangKe.status} - ${JSON.stringify(responseBangKe.data)}`);
                            }

                            if (responseChiPhi.status !== 200) {
                                throw new Error(`API Error: ${responseChiPhi.status} - ${JSON.stringify(responseChiPhi.data)}`);
                            }

                            // Update progress steps
                            this.updateProgressSteps(3);
                            resolve("Lưu thành công!");

                            // Reset form after successful save
                            setTimeout(() => this.resetForm(), 1500);
                        } catch (error) {
                            reject(error);
                        }
                    });

                    // Use FuiToast.promise
                    FuiToast.promise(
                        savePromise,
                        {
                            loading: 'Đang lưu dữ liệu...',
                            success: () => 'Đã lưu bảng kê công nợ và chi phí thành công!',
                            error: (error) => `Lỗi: ${error.message || 'Có lỗi xảy ra khi lưu thông tin!'}`
                        },
                        {
                            isClose: true
                        }
                    );
                } catch (error) {
                    console.error('Lỗi khi lưu dữ liệu:', error);
                    FuiToast.error(error.message || 'Có lỗi xảy ra khi lưu thông tin! Vui lòng thử lại.');
                }
            }

            // Mở modal chi tiết chi phí
            openChiPhiDetail(button) {
                this.currentEditingRow = button.closest('tr');

                // Lấy giá trị từ data attributes trong hàng
                const hinhThucChi = this.currentEditingRow.querySelector('.hinh-thuc-chi').value;
                const loaiChiPhi = this.currentEditingRow.querySelector('.loai-chi-phi').value;
                const phuongThucTT = this.currentEditingRow.querySelector('.phuong-thuc-tt').value;
                const nguoiDeXuat = this.currentEditingRow.querySelector('.nguoi-de-xuat').value;
                const ngayChi = this.currentEditingRow.querySelector('.ngay-chi').value;
                const soTienChi = this.currentEditingRow.querySelector('.so-tien-chi').value;

                // Cập nhật giá trị trong modal
                document.getElementById('modalHinhThucChi').value = hinhThucChi;
                document.getElementById('modalLoaiChiPhi').value = loaiChiPhi;
                document.getElementById('modalPhuongThucThanhToan').value = phuongThucTT;
                document.getElementById('modalNguoiDeXuatChi').value = nguoiDeXuat;
                document.getElementById('modalNgayChi').value = ngayChi;
                document.getElementById('modalSoTienChi').value = soTienChi;

                // Lấy dữ liệu từ data attributes nếu có
                document.getElementById('modalGhiChu').value = this.currentEditingRow.dataset.ghiChu || '';

                // Set the order and product IDs
                const idDonHang = this.currentEditingRow.dataset.idDonHang || '';
                const idHangHoa = this.currentEditingRow.dataset.idHangHoa || '';
                const displayIdDonHang = this.currentEditingRow.cells[1].textContent;
                const displayIdHangHoa = this.currentEditingRow.cells[2].textContent;

                // Ensure modalIdDonHang and modalIdHangHoa exist
                const modalIdDonHangInput = document.getElementById('modalIdDonHang');
                const modalIdHangHoaInput = document.getElementById('modalIdHangHoa');

                if (modalIdDonHangInput) {
                    modalIdDonHangInput.value = displayIdDonHang;
                    modalIdDonHangInput.dataset.orderId = idDonHang;
                }

                if (modalIdHangHoaInput) {
                    modalIdHangHoaInput.value = displayIdHangHoa;
                    modalIdHangHoaInput.dataset.productId = idHangHoa;
                }

                // Xử lý loại chi phí tùy chỉnh
                const modalLoaiChiPhi = document.getElementById('modalLoaiChiPhi');
                const modalLoaiChiPhiCustom = document.getElementById('modalLoaiChiPhiCustom');

                if (loaiChiPhi && !modalLoaiChiPhi.querySelector(`option[value="${loaiChiPhi}"]`)) {
                    modalLoaiChiPhi.value = 'custom';
                    modalLoaiChiPhiCustom.value = loaiChiPhi;
                    modalLoaiChiPhiCustom.classList.remove('hidden');
                } else {
                    modalLoaiChiPhiCustom.classList.add('hidden');
                }

                // Hiển thị modal
                document.getElementById('chiPhiDetailModal').classList.remove('hidden');
            }

            // Đóng modal chi tiết chi phí
            closeChiPhiDetailModal() {
                document.getElementById('chiPhiDetailModal').classList.add('hidden');
                this.currentEditingRow = null;
            }

            // Tính toán giá trị trong modal
            calculateModalValues() {
                // Đơn giản chỉ có số tiền chi, không cần tính toán phức tạp
                // Có thể mở rộng trong tương lai nếu cần
            }

            // Xử lý cập nhật chi tiết chi phí từ modal
            handleUpdateChiPhi(event) {
                event.preventDefault();

                if (!this.currentEditingRow) return;

                try {
                    // Lấy giá trị từ form modal
                    const hinhThucChi = document.getElementById('modalHinhThucChi').value;
                    const loaiChiPhiControl = document.getElementById('modalLoaiChiPhi');
                    const loaiChiPhiCustom = document.getElementById('modalLoaiChiPhiCustom');
                    const phuongThucTT = document.getElementById('modalPhuongThucThanhToan').value;
                    const nguoiDeXuat = document.getElementById('modalNguoiDeXuatChi').value;
                    const ngayChi = document.getElementById('modalNgayChi').value;
                    const soTienChi = document.getElementById('modalSoTienChi').value;
                    const ghiChu = document.getElementById('modalGhiChu').value;

                    // Get selected order information
                    const modalIdDonHangInput = document.getElementById('modalIdDonHang');
                    const idDonHang = modalIdDonHangInput.dataset.orderId || modalIdDonHangInput.value;
                    const displayIdDonHang = modalIdDonHangInput.value;

                    // Get selected product information
                    const modalIdHangHoaInput = document.getElementById('modalIdHangHoa');
                    const idHangHoa = modalIdHangHoaInput.dataset.productId || modalIdHangHoaInput.value;
                    const displayIdHangHoa = modalIdHangHoaInput.value;

                    // Xác định loại chi phí (từ select hoặc custom input)
                    let loaiChiPhi = loaiChiPhiControl.value;
                    if (loaiChiPhi === 'custom') {
                        loaiChiPhi = loaiChiPhiCustom.value;
                    }

                    // Cập nhật dữ liệu trong các ô tương ứng
                    this.currentEditingRow.querySelector('.hinh-thuc-chi').value = hinhThucChi;
                    this.currentEditingRow.querySelector('.loai-chi-phi').value = loaiChiPhi;
                    this.currentEditingRow.querySelector('.phuong-thuc-tt').value = phuongThucTT;
                    this.currentEditingRow.querySelector('.nguoi-de-xuat').value = nguoiDeXuat;
                    this.currentEditingRow.querySelector('.ngay-chi').value = ngayChi;
                    this.currentEditingRow.querySelector('.so-tien-chi').value = soTienChi;

                    // Cập nhật hiển thị ID đơn hàng và ID hàng hóa
                    const idDonHangCell = this.currentEditingRow.cells[1];
                    const idHangHoaCell = this.currentEditingRow.cells[2];
                    idDonHangCell.textContent = displayIdDonHang;
                    idHangHoaCell.textContent = displayIdHangHoa;

                    // Lưu các giá trị bổ sung vào data attributes
                    this.currentEditingRow.dataset.ngayChi = ngayChi;
                    this.currentEditingRow.dataset.ghiChu = ghiChu;
                    this.currentEditingRow.dataset.soTienChi = soTienChi;
                    this.currentEditingRow.dataset.idDonHang = idDonHang;
                    this.currentEditingRow.dataset.idHangHoa = idHangHoa;
                    this.currentEditingRow.dataset.hinhThucChi = hinhThucChi;
                    this.currentEditingRow.dataset.loaiChiPhi = loaiChiPhi;
                    this.currentEditingRow.dataset.phuongThucTT = phuongThucTT;
                    this.currentEditingRow.dataset.nguoiDeXuat = nguoiDeXuat;

                    // Cập nhật lịch sử cập nhật
                    const currentDate = this.formatDate(new Date());
                    const currentHistory = this.currentEditingRow.dataset.lichSuCapNhat || '';
                    this.currentEditingRow.dataset.lichSuCapNhat = currentHistory
                        ? `${currentHistory}, ${currentDate} - Cập nhật`
                        : `${currentDate} - Cập nhật`;

                    // Cập nhật tính toán
                    this.calculateRowValues(this.currentEditingRow);
                    this.updateOrderTotals();

                    // Đóng modal
                    this.closeChiPhiDetailModal();

                    // Hiển thị thông báo thành công
                    Swal.fire({
                        icon: 'success',
                        title: 'Cập nhật thành công!',
                        text: 'Đã cập nhật thông tin chi phí.',
                        showConfirmButton: false,
                        timer: 1500
                    });
                } catch (error) {
                    console.error('Lỗi cập nhật chi phí:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi!',
                        text: 'Có lỗi xảy ra khi cập nhật thông tin.',
                        showConfirmButton: true
                    });
                }
            }

            // Mở modal thêm nhà cung cấp
            openNhaCungCapModal() {
                document.getElementById('nhaCungCapModal').classList.remove('hidden');
            }

            // Đóng modal thêm nhà cung cấp
            closeNhaCungCapModal() {
                document.getElementById('nhaCungCapModal').classList.add('hidden');
                document.getElementById('nhaCungCapForm').reset();
            }

            // Xử lý thêm nhà cung cấp mới
            async handleThemNhaCungCap(event) {
                event.preventDefault();

                try {
                    this.showLoading('Đang lưu thông tin nhà cung cấp...');

                    const nhaCungCapData = {
                        'ID nhà cung cấp': document.getElementById('maNhaCungCap').value,
                        'Tên nhà cung cấp': document.getElementById('tenNhaCungCapDayDu').value,
                        'Loại dịch vụ': document.getElementById('loaiNhaCungCap').value,
                        'Địa chỉ': document.getElementById('diaChi').value,
                        'Người liên hệ': document.getElementById('nguoiLienhe').value,
                        'Điện thoại': document.getElementById('soDienThoai').value,
                        'Email': document.getElementById('email').value
                    };

                    const response = await axios({
                        method: 'POST',
                        url: `https://www.appsheet.com/api/v2/apps/${this.appId}/tables/Nhà cung cấp/Action`,
                        headers: {
                            'ApplicationAccessKey': this.accessKey,
                            'Content-Type': 'application/json'
                        },
                        data: {
                            "Action": "Add",
                            "Properties": {
                                "Locale": "vi-VN",
                                "Timezone": "Asia/Ho_Chi_Minh"
                            },
                            "Rows": [nhaCungCapData]
                        }
                    });

                    if (response.status === 200) {
                        // Tạo ID tạm thời cho nhà cung cấp mới
                        const newSupplierId = nhaCungCapData['Mã nhà cung cấp'] ||
                            'NEW_' + Date.now();

                        // Thêm nhà cung cấp mới vào danh sách
                        const newSupplier = {
                            'ID nhà cung cấp': newSupplierId,
                            'Tên nhà cung cấp': nhaCungCapData['Tên nhà cung cấp']
                        };
                        this.nhaCungCapList.push(newSupplier);

                        // Tạo lại Choices.js cho nhà cung cấp
                        if (this.nhaCungCapChoices) {
                            this.nhaCungCapChoices.destroy();
                        }

                        // Tạo lại select 
                        const nhaCungCapSelect = document.getElementById('nhaCungCap');
                        nhaCungCapSelect.innerHTML = '<option value="">-- Chọn nhà cung cấp --</option>';

                        this.nhaCungCapList.forEach(ncc => {
                            const option = document.createElement('option');
                            option.value = ncc['ID nhà cung cấp'] || ncc.ID;
                            option.textContent = ncc['Tên nhà cung cấp'] || ncc.Ten;
                            nhaCungCapSelect.appendChild(option);
                        });

                        // Khởi tạo lại Choices.js
                        this.nhaCungCapChoices = new Choices('#nhaCungCap', {
                            searchEnabled: true,
                            searchPlaceholderValue: 'Nhập tên để tìm...',
                            noResultsText: 'Không tìm thấy nhà cung cấp',
                            itemSelectText: 'Chọn',
                            removeItemButton: true,
                            searchFields: ['label'],
                            position: 'bottom'
                        });

                        // Chọn nhà cung cấp mới tạo
                        this.nhaCungCapChoices.setChoiceByValue(newSupplierId);

                        // Đóng modal và hiện thông báo
                        this.closeNhaCungCapModal();
                        this.showAlert('success', 'Thành công!', 'Đã thêm nhà cung cấp mới thành công!');
                    }

                } catch (error) {
                    console.error('Lỗi khi thêm nhà cung cấp:', error);
                    this.showAlert('error', 'Lỗi!', 'Không thể thêm nhà cung cấp. Vui lòng thử lại!');
                } finally {
                    this.hideLoading();
                }
            }
        }

        // Class quản lý dropdown tùy chỉnh
        class CustomDropdownManager {
            constructor(selectId, storageKey) {
                this.selectId = selectId;           // ID của phần tử select
                this.storageKey = storageKey;       // Khóa để lưu vào localStorage
                this.selectElement = document.getElementById(selectId);  // Phần tử select
                this.customInput = document.getElementById(`${selectId}Custom`); // Input để nhập giá trị tùy chỉnh
                this.init();
            }

            init() {
                // Tải các tùy chọn đã lưu trước đó
                this.loadSavedOptions();

                // Thiết lập sự kiện listener cho việc thêm tùy chọn mới
                if (this.customInput) {
                    // Xử lý khi người dùng rời khỏi ô input
                    this.customInput.addEventListener('blur', (e) => {
                        if (e.target.value && this.selectElement.value === 'custom') {
                            this.addCustomOption(e.target.value);
                        }
                    });

                    // Xử lý khi người dùng nhấn phím Enter
                    this.customInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && e.target.value && this.selectElement.value === 'custom') {
                            e.preventDefault();
                            this.addCustomOption(e.target.value);
                            this.selectElement.value = e.target.value;
                            this.customInput.classList.add('hidden');
                        }
                    });
                }
            }

            // Tải các tùy chọn đã lưu từ localStorage
            loadSavedOptions() {
                try {
                    const savedOptions = JSON.parse(localStorage.getItem(this.storageKey)) || [];
                    const customOptionPosition = this.getCustomOptionPosition();

                    // Xóa các tùy chọn do người dùng thêm trước đó (trừ tùy chọn "custom")
                    const options = Array.from(this.selectElement.options);
                    for (let i = options.length - 1; i >= 0; i--) {
                        if (options[i].classList.contains('user-added') && options[i].value !== 'custom') {
                            this.selectElement.remove(i);
                        }
                    }

                    // Thêm các tùy chọn đã lưu vào trước tùy chọn "custom"
                    savedOptions.forEach(option => {
                        if (!this.optionExists(option)) {
                            const optElement = document.createElement('option');
                            optElement.value = option;
                            optElement.textContent = option;
                            optElement.classList.add('user-added');

                            this.selectElement.insertBefore(optElement, this.selectElement.options[customOptionPosition]);
                        }
                    });
                } catch (error) {
                    console.error(`Lỗi khi tải tùy chọn đã lưu cho ${this.selectId}:`, error);
                }
            }

            // Tìm vị trí của tùy chọn "custom"
            getCustomOptionPosition() {
                for (let i = 0; i < this.selectElement.options.length; i++) {
                    if (this.selectElement.options[i].value === 'custom') {
                        return i;
                    }
                }
                return this.selectElement.options.length; // Mặc định là cuối danh sách
            }

            // Kiểm tra xem tùy chọn đã tồn tại chưa
            optionExists(value) {
                return Array.from(this.selectElement.options)
                    .some(opt => opt.value === value && opt.textContent === value);
            }

            // Thêm tùy chọn mới
            addCustomOption(value) {
                if (!value.trim() || this.optionExists(value)) return;

                try {
                    // Thêm vào dropdown
                    const customOptionPosition = this.getCustomOptionPosition();
                    const optElement = document.createElement('option');
                    optElement.value = value;
                    optElement.textContent = value;
                    optElement.classList.add('user-added');

                    this.selectElement.insertBefore(optElement, this.selectElement.options[customOptionPosition]);

                    // Chọn tùy chọn mới
                    this.selectElement.value = value;

                    // Lưu vào localStorage
                    const savedOptions = JSON.parse(localStorage.getItem(this.storageKey)) || [];
                    if (!savedOptions.includes(value)) {
                        savedOptions.push(value);
                        localStorage.setItem(this.storageKey, JSON.stringify(savedOptions));
                    }

                    // Ẩn ô input tùy chỉnh
                    this.customInput.classList.add('hidden');
                } catch (error) {
                    console.error(`Lỗi khi thêm tùy chọn mới cho ${this.selectId}:`, error);
                }
            }
        }

        // Khởi tạo quản lý bảng kê công nợ khi DOM đã được tải
        document.addEventListener('DOMContentLoaded', function () {
            const bangKeCongNoManager = new BangKeCongNoManager(appId, accessKey);
        });
    </script>
</body>

</html>