<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đề Nghị Tạm Ứng - Đức Thành</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Times+New+Roman:wght@400;700&display=swap');

        body {
            font-family: 'Times New Roman', Times, serif;
            line-height: 1.3;
            margin: 0;
            color: #000;
            font-size: 12pt;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 5px;
        }

        .header-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .header-table td {
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }

        .header-left {
            width: 40%;
            font-weight: bold;
        }

        .header-right {
            width: 60%;
            font-weight: bold;
        }

        .title {
            text-align: center;
            font-weight: bold;
            font-size: 16pt;
            margin: 20px 0;
        }

        .recipient {
            margin-bottom: 20px;
        }

        .content-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .content-table th,
        .content-table td {
            border: 1px solid black;
            padding: 8px;
        }

        .content-table th {
            background-color: #f2f2f2;
            text-align: center;
        }

        .payment-info {
            margin-bottom: 20px;
        }

        .signature {
            text-align: right;
            margin-top: 40px;
        }

        .company-info {
            margin-left: 40px;
        }

        .print-button-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        #printButton {
            background-color: #f0a500;
            border: none;
            color: #000;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Times New Roman', Times, serif;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #printButton:hover {
            background-color: #d89400;
        }

        #exportButton {
            background-color: #2b579a;
            border: none;
            color: #fff;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Times New Roman', Times, serif;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #exportButton:hover {
            background-color: #1e3f6f;
        }

        #excelButton {
            background-color: #217346;
            border: none;
            color: #fff;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Times New Roman', Times, serif;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #excelButton:hover {
            background-color: #1e5e3a;
        }

        #loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            z-index: 1000;
            text-align: center;
            padding-top: 200px;
        }

        #error-message {
            display: none;
            color: red;
            text-align: center;
            margin: 20px 0;
        }

        @media print {
            .print-button-container {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div id="loading">Đang tải dữ liệu...</div>
    <div id="error-message"></div>

    <div class="print-button-container">
        <button id="printButton" onclick="window.print()">
            <i class="fas fa-print"></i> In đề nghị
        </button>
        <button id="excelButton" onclick="exportToExcelTemplate()">
            <i class="fas fa-file-excel"></i> Xuất Excel
        </button>
        <button id="exportButton" onclick="exportToWordTemplate()">
            <i class="fas fa-file-word"></i> Xuất Word
        </button>
    </div>

    <div class="container">
        <table class="header-table">
            <tr>
                <td class="header-left">
                    <div>CÔNG TY TNHH SẢN XUẤT</div>
                    <div>VÀ DỊCH VỤ ĐỨC THÀNH</div>
                </td>
                <td class="header-right">
                    <div>CỘNG HOÀ XÃ HỘI CHỦ NGHĨA VIỆT NAM</div>
                    <div>Độc lập - Tự do - Hạnh phúc</div>
                </td>
            </tr>
        </table>

        <div class="title">ĐỀ NGHỊ TẠM ỨNG</div>

        <div class="recipient">
            <strong>Kính gửi: </strong><span id="customer-name">Quý khách hàng</span>
        </div>

        <div>Xin vui lòng thanh toán vào thông tin tài khoản bên dưới theo nội dung sau:</div>

        <table class="content-table">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Nội dung thanh toán</th>
                    <th>Số tiền (VNĐ)</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="text-align: center;">1</td>
                    <td>Tạm ứng 50% tiền in ấn sản phẩm</td>
                    <td style="text-align: right;" id="amount">0</td>
                </tr>
            </tbody>
        </table>

        <div class="payment-info">
            <div>CÔNG TY TNHH SẢN XUẤT VÀ DỊCH VỤ ĐỨC THÀNH đề nghị Quý Công ty thanh toán số tiền theo bản thanh toán.
            </div>
            <div><strong>Tổng giá trị: <span id="total-amount">0</span> vnđ</strong></div>
            <div>(Bằng chữ: <span id="amount-in-words">Không đồng</span>)</div>
            <br>
            <div>Tài khoản nhận tiền:</div>
            <div class="company-info">
                <div>- Tên thụ hưởng: Công Ty TNHH Sản Xuất Và Dịch Vụ Đức Thành</div>
                <div>- Số tài khoản: 156939258 tại ngân hàng VP Bank - Chi nhánh Thăng Long.</div>
            </div>
            <br>
            <div>Trân trọng cảm ơn!</div>
        </div>

        <div class="signature">
            <div>Hà Nội, Ngày <span id="current-day">...</span> tháng <span id="current-month">...</span> năm <span
                    id="current-year">...</span></div>
            <div><strong>ĐẠI DIỆN CÔNG TY</strong></div>
        </div>
    </div>

    <script src="https://hoangmv.github.io/ducthanh/key.js"></script>
    <script>
        
        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Function to format number as currency
        function formatCurrency(number) {
            return number.toLocaleString('vi-VN');
        }

        // Function to format date to Vietnamese format
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '/');
        }

        // Function to convert number to Vietnamese words
        function numberToWords(num) {
            const units = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
            const tens = ['', 'mười', 'hai mươi', 'ba mươi', 'bốn mươi', 'năm mươi', 'sáu mươi', 'bảy mươi', 'tám mươi', 'chín mươi'];
            const scales = ['', 'nghìn', 'triệu', 'tỷ', 'nghìn tỷ', 'triệu tỷ'];

            if (num === 0) return 'không';

            let words = '';
            let scaleIndex = 0;

            while (num > 0) {
                const hundreds = Math.floor(num % 1000 / 100);
                const ten = Math.floor(num % 100 / 10);
                const unit = num % 10;

                let scaleWords = '';

                if (hundreds > 0) {
                    scaleWords += units[hundreds] + ' trăm ';
                }

                if (ten > 1) {
                    scaleWords += tens[ten] + ' ';
                    if (unit > 0) {
                        scaleWords += (unit === 1 && ten > 1) ? 'mốt' : units[unit];
                    }
                } else if (ten === 1) {
                    scaleWords += 'mười ';
                    if (unit > 0) {
                        scaleWords += (unit === 5) ? 'lăm' : units[unit];
                    }
                } else if (unit > 0) {
                    scaleWords += units[unit];
                }

                if (scaleWords) {
                    words = scaleWords + (scaleIndex > 0 ? ' ' + scales[scaleIndex] + ' ' : '') + words;
                }

                num = Math.floor(num / 1000);
                scaleIndex++;
            }

            // Viết hoa chữ cái đầu tiên
            words = words.trim();
            return words.charAt(0).toUpperCase() + words.slice(1) + ' đồng';
        }

        // Function to fetch specific order by ID from AppSheet
        async function fetchOrderById(orderId) {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error-message');

            loadingElement.style.display = 'block';
            errorElement.style.display = 'none';

            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Đơn hàng/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: `Filter([Đơn hàng], [ID đơn hàng] = "${orderId}")`
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                loadingElement.style.display = 'none';

                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format received');
                }

                // Tìm đơn hàng có ID chính xác
                const exactOrder = data.find(order => order['ID đơn hàng'] === orderId);

                if (!exactOrder) {
                    throw new Error(`Không tìm thấy đơn hàng với mã: ${orderId}`);
                }

                return exactOrder; // Trả về đơn hàng chính xác
            } catch (error) {
                console.error('Failed to fetch order data:', error);
                loadingElement.style.display = 'none';
                errorElement.textContent = error.message || 'Có lỗi xảy ra khi tải dữ liệu đơn hàng.';
                errorElement.style.display = 'block';
                throw error;
            }
        }

        // Thêm hàm mới để lấy thông tin khách hàng theo ID
        async function fetchCustomerById(customerId) {
            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Khách hàng/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: `Filter([Khách hàng], [ID khách hàng] = "${customerId}")`
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format received');
                }

                // Tìm khách hàng có ID chính xác
                const exactCustomer = data.find(customer => customer['ID khách hàng'] === customerId);

                if (!exactCustomer) {
                    throw new Error(`Không tìm thấy khách hàng với ID: ${customerId}`);
                }

                return exactCustomer; // Trả về khách hàng chính xác
            } catch (error) {
                console.error('Failed to fetch customer data:', error);
                throw error;
            }
        }

        // Hàm tính tạm ứng 50% từ đơn hàng
        async function calculateAdvancePayment(orderId) {
            try {
                // Lấy thông tin đơn hàng
                const order = await fetchOrderById(orderId);

                // Tính tổng giá trị đơn hàng (giả sử có trường tổng tiền)
                const totalValue = parseFloat(order['Tổng giá trị đơn'] || 0);

                // Tính 50% tạm ứng
                const advanceAmount = totalValue * 0.5;

                return {
                    customerId: order['ID khách hàng'],
                    orderNumber: order['Mã đơn hàng'] || '',
                    totalValue: totalValue,
                    advanceAmount: advanceAmount
                };
            } catch (error) {
                console.error('Error calculating advance payment:', error);
                throw error;
            }
        }

        // Hàm hiển thị thông tin đề nghị tạm ứng
        async function displayAdvanceRequestData(orderId) {
            try {
                // Tính số tiền tạm ứng từ đơn hàng
                const paymentData = await calculateAdvancePayment(orderId);

                // Lấy thông tin khách hàng
                const customer = await fetchCustomerById(paymentData.customerId);

                // Cập nhật tên khách hàng
                document.getElementById('customer-name').textContent = customer['Tên khách hàng đầy đủ'] || 'Quý khách hàng';

                // Cập nhật số tiền
                const formattedAmount = formatCurrency(paymentData.advanceAmount);
                document.getElementById('amount').textContent = formattedAmount;
                document.getElementById('total-amount').textContent = formattedAmount;

                // Cập nhật số tiền bằng chữ
                document.getElementById('amount-in-words').textContent = numberToWords(Math.round(paymentData.advanceAmount));

                // Cập nhật ngày tháng hiện tại
                const currentDate = new Date();
                document.getElementById('current-day').textContent = currentDate.getDate();
                document.getElementById('current-month').textContent = currentDate.getMonth() + 1;
                document.getElementById('current-year').textContent = currentDate.getFullYear();

            } catch (error) {
                console.error('Error displaying advance request data:', error);
                document.getElementById('error-message').textContent = 'Lỗi hiển thị dữ liệu đề nghị tạm ứng: ' + error.message;
                document.getElementById('error-message').style.display = 'block';
            }
        }

        // Hàm xuất file Word
        async function exportToWordTemplate() {
            try {
                // Lấy dữ liệu hiện tại trên form
                const customerName = document.getElementById('customer-name').textContent;
                const amount = document.getElementById('amount').textContent;
                const totalAmount = document.getElementById('total-amount').textContent;
                const amountInWords = document.getElementById('amount-in-words').textContent;

                const currentDate = new Date();
                const day = currentDate.getDate();
                const month = currentDate.getMonth() + 1;
                const year = currentDate.getFullYear();

                // Tạo dữ liệu để điền vào template
                const data = {
                    customer_name: customerName,
                    amount: amount,
                    total_amount: totalAmount,
                    amount_in_words: amountInWords,
                    day: day,
                    month: month,
                    year: year
                };

                // Load template từ server (sử dụng một file template mẫu, cần phải tạo trước)
                const response = await fetch('https://example.com/templates/advance_request_template.docx');
                if (!response.ok) {
                    throw new Error('Không thể tải template Word');
                }
                const templateContent = await response.arrayBuffer();

                // Tạo document từ template
                const zip = new PizZip(templateContent);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true
                });

                // Render template với dữ liệu
                doc.setData(data);
                doc.render();

                // Tạo và tải file
                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                });

                const fileName = `De_nghi_tam_ung_${day}${month}${year}.docx`;
                saveAs(blob, fileName);

            } catch (error) {
                console.error('Error exporting to Word:', error);
                alert('Có lỗi khi xuất file Word. Vui lòng thử lại sau.');
            }
        }

        // Hàm xuất file Excel
        async function exportToExcelTemplate() {
            try {
                document.getElementById('loading').style.display = 'block';

                // Lấy dữ liệu hiện tại trên form
                const customerName = document.getElementById('customer-name').textContent;
                const amount = document.getElementById('amount').textContent.replace(/[,.]/g, '');
                const amountInWords = document.getElementById('amount-in-words').textContent;

                const currentDate = new Date();
                const day = currentDate.getDate();
                const month = currentDate.getMonth() + 1;
                const year = currentDate.getFullYear();

                // Tạo workbook mới
                const workbook = XLSX.utils.book_new();

                // Tạo worksheet
                const wsData = [
                    ['CÔNG TY TNHH SẢN XUẤT VÀ DỊCH VỤ ĐỨC THÀNH', '', 'CỘNG HOÀ XÃ HỘI CHỦ NGHĨA VIỆT NAM'],
                    ['', '', 'Độc lập - Tự do - Hạnh phúc'],
                    ['', '', ''],
                    ['ĐỀ NGHỊ TẠM ỨNG', '', ''],
                    ['', '', ''],
                    ['Kính gửi:', customerName, ''],
                    ['', '', ''],
                    ['Xin vui lòng thanh toán vào thông tin tài khoản bên dưới theo nội dung sau:', '', ''],
                    ['', '', ''],
                    ['STT', 'Nội dung thanh toán', 'Số tiền (VNĐ)'],
                    ['1', 'Tạm ứng 50% tiền in ấn sản phẩm', amount],
                    ['', '', ''],
                    ['CÔNG TY TNHH SẢN XUẤT VÀ DỊCH VỤ ĐỨC THÀNH đề nghị Quý Công ty thanh toán số tiền theo bản thanh toán.', '', ''],
                    ['Tổng giá trị:', amount, 'vnđ'],
                    ['(Bằng chữ:', amountInWords + ')', ''],
                    ['', '', ''],
                    ['Tài khoản nhận tiền:', '', ''],
                    ['- Tên thụ hưởng: Công Ty TNHH Sản Xuất Và Dịch Vụ Đức Thành', '', ''],
                    ['- Số tài khoản: 156939258 tại ngân hàng VP Bank - Chi nhánh Thăng Long.', '', ''],
                    ['', '', ''],
                    ['Trân trọng cảm ơn!', '', ''],
                    ['', '', ''],
                    ['', '', `Hà Nội, Ngày ${day} tháng ${month} năm ${year}`],
                    ['', '', 'ĐẠI DIỆN CÔNG TY']
                ];

                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // Thêm worksheet vào workbook
                XLSX.utils.book_append_sheet(workbook, ws, "Đề nghị tạm ứng");

                // Xuất file Excel
                const excelOutput = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([excelOutput], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const fileName = `De_nghi_tam_ung_${day}${month}${year}.xlsx`;
                saveAs(blob, fileName);

            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Có lỗi khi xuất file Excel. Vui lòng thử lại sau.');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Khởi tạo trang
        async function initializePage() {
            // Lấy order ID từ tham số URL
            const orderId = getUrlParameter('id');

            if (!orderId) {
                document.getElementById('error-message').textContent = 'Không tìm thấy mã đơn hàng trong URL. Vui lòng kiểm tra lại đường dẫn.';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                return;
            }

            try {
                // Hiển thị dữ liệu đề nghị tạm ứng
                await displayAdvanceRequestData(orderId);
            } catch (error) {
                console.error('Failed to initialize page:', error);
                document.getElementById('error-message').textContent = 'Không thể tải dữ liệu đơn hàng. Vui lòng thử lại sau.';
                document.getElementById('error-message').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Chạy khi tài liệu đã tải xong
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>

</html>