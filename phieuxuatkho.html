<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu xuất kho - Đức Thành</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Thêm các thư viện cần thiết -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Times+New+Roman:wght@400;700&display=swap');

        body {
            font-family: 'Times New Roman', Times, serif;
            line-height: 1.3;
            margin: 0;
            color: #000;
            font-size: 12pt;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 5px;
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .logo-container {
            width: 25%;
        }

        .logo {
            max-width: 150px;
        }

        .company-info {
            width: 75%;
            text-align: right;
            font-size: 11pt;
            line-height: 1.4;
        }

        .company-name {
            font-weight: bold;
            font-size: 12pt;
        }

        .title {
            text-align: center;
            font-size: 16pt;
            font-weight: bold;
            margin: 25px 0 5px 0;
        }

        .order-info {
            text-align: center;
            margin-bottom: 25px;
        }

        .client-info {
            background-color: #f2f9f2;
            /* Màu xanh lá rất nhạt */
            padding: 5px 10px;
            line-height: 1.1;
            border-bottom: #000 1px solid !important;
        }

        .delivery-info {
            background-color: #f2f9f2;
            /* Màu xanh lá rất nhạt */
            padding: 5px 10px;
            line-height: 1.1;
        }


        .delivery-info .delivery-row {
            display: flex;
            gap: 20px;
        }

        .delivery-info .delivery-item {
            flex: 1;
        }

        .intro-text {
            font-style: italic;
            margin: 5px 0;
            line-height: 1.3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        table,
        th,
        td {
            border: 1px solid #000;
        }

        th {
            background-color: #a7d2a7;
            /* Màu xanh lá nhạt */
            color: #000;
            text-align: center;
            padding: 8px 4px;
            font-weight: bold;
        }

        td {
            padding: 6px 4px;
            text-align: center;
        }

        .payment-info {
            margin-bottom: 15px;
            line-height: 1.1;
        }

        .signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .signature {
            text-align: center;
            width: 45%;
        }

        .total-in-words {
            font-weight: bold;
        }

        .product-name {
            text-align: left;
            padding-left: 10px;
        }

        p {
            margin: 5px 0;
        }

        #loading {
            text-align: center;
            display: none;
            margin: 20px 0;
        }

        #error-message {
            color: red;
            text-align: center;
            display: none;
            margin: 20px 0;
        }

        .total-row td {
            font-weight: bold;
        }

        .product-info {
            text-align: left;
            padding-left: 10px;
        }

        .product-info strong {
            display: block;
        }

        .product-description {
            display: block;
            margin-top: 5px;
            color: #666;
            white-space: pre-line;
        }

        .print-button-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        #printButton {
            background-color: #f0a500;
            border: none;
            color: #000;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Times New Roman', Times, serif;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #printButton:hover {
            background-color: #d89400;
        }

        .print-button-container {
            display: flex;
            gap: 10px;
        }

        #exportButton {
            background-color: #2b579a;
            border: none;
            color: #fff;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Times New Roman', Times, serif;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #exportButton:hover {
            background-color: #1e3f6f;
        }

        #excelButton {
            background-color: #217346;
            border: none;
            color: #fff;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Times New Roman', Times, serif;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #excelButton:hover {
            background-color: #1e5e3a;
        }

        @media print {
            .print-button-container {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="print-button-container">
        <button id="printButton" onclick="window.print()">
            <i class="fas fa-print"></i> In xác nhận
        </button>
    
        <button id="excelButton" onclick="exportToExcelWithExcelJS()">
            <i class="fas fa-file-excel"></i> Xuất Excel
        </button>
        <button id="exportButton" onclick="exportToWordTemplate()">
            <i class="fas fa-file-word"></i> Xuất Word
        </button>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://hoangmv.github.io/ducthanh/ducthanhlogo.png" alt="DUC THANH" class="logo">
            </div>
            <div class="company-info">
                <div class="company-name">CÔNG TY TNHH SẢN XUẤT VÀ DỊCH VỤ ĐỨC THÀNH</div>
                VPGD: Số 11/49/64 Nguyễn Lương Bằng, Ô Chợ Dừa, Đống Đa, Hà Nội<br>
                Số ĐKKD: 0108325268. Điện thoại: 024 6682 6686 | Email: <span
                    class="underline">info@inducthanh.vn</span><br>
                Website: <span class="underline">www.inducthanh.com</span> | <span
                    class="underline">www.inlayngay.vn</span>
            </div>
        </div>

        <div class="title">PHIẾU XUẤT KHO BÁN HÀNG</div>
        <div class="order-info"><strong>Số đơn hàng:</strong> <span id="order-number">Đang tải...</span> - <strong>Ngày
                đặt hàng</strong> <span id="order-date">Đang tải...</span></div>

        <div class="client-info">
            <p><strong>Khách hàng:</strong> <span id="customer-name">Đang tải...</span></p>
            <p><strong>Mã số thuế:</strong> <span id="tax-code">Đang tải...</span></p>
            <p><strong>Địa chỉ hoá đơn:</strong> <span id="invoice-address">Đang tải...</span></p>
        </div>

        <div class="delivery-info">
            <div class="delivery-row">
                <div class="delivery-item">
                    <p><strong>Người nhận hàng:</strong> <span id="recipient-name">Đang tải...</span></p>
                </div>
                <div class="delivery-item">
                    <p><strong>SĐT người nhận:</strong> <span id="recipient-phone">Đang tải...</span></p>
                </div>
            </div>
            <p><strong>Địa chỉ giao hàng:</strong> <span id="delivery-address">Đang tải...</span></p>
        </div>

        <div class="intro-text">
            <i>Chi tiết hàng hoá:</i>
        </div>

        <div id="loading">Đang tải dữ liệu...</div>
        <div id="error-message">Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại sau.</div>

        <table>
            <thead>
                <tr>
                    <th width="10%">STT</th>
                    <th width="37%">HÀNG HÓA</th>
                    <th width="10%">ĐVT</th>
                    <th width="10%">SL</th>
                    <th width="17%">ĐƠN GIÁ</th>
                    <th width="17%">THÀNH TIỀN</th>
                </tr>
            </thead>
            <tbody id="product-table-body">
                <!-- Dữ liệu sản phẩm sẽ được điền vào đây -->
            </tbody>
            <tfoot id="table-footer">
                <!-- Dữ liệu tổng cộng sẽ được điền vào đây -->
            </tfoot>
        </table>

        <div class="total-in-words">Số tiền viết bằng chữ: <span id="total-in-words">Đang tải...</span></div>

        <div class="signatures">
            <div class="signature">
                <p><strong>BÊN MUA</strong></p>
                <p><i>(Ký, họ tên)</i></p>
            </div>
            <div class="signature">
                <p><strong>BÊN BÁN</strong></p>
                <p><i>(Ký, họ tên)</i></p>
            </div>
        </div>
    </div>



    <!-- Thêm vào phần head, sau các script hiện có -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script>
        // Constants for AppSheet connection
        const appId = 'd4e7fd95-42b6-4a41-ab3e-eac72731fe07';
        const accessKey = 'V2-3dYqz-xwhyz-B41Kw-E9nvf-hATE7-YNdCe-9JYUY-6A7q3';
        const region = 'www';

        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Function to format number as currency
        function formatCurrency(number) {
            // Round the number to remove decimal places
            const roundedNumber = Math.round(number);
            return roundedNumber.toLocaleString('vi-VN');
        }

        // Function to format date to Vietnamese format
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '/');
        }

        // Function to convert number to Vietnamese words
        function numberToWords(num) {
            const units = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
            const tens = ['', 'mười', 'hai mươi', 'ba mươi', 'bốn mươi', 'năm mươi', 'sáu mươi', 'bảy mươi', 'tám mươi', 'chín mươi'];
            const scales = ['', 'nghìn', 'triệu', 'tỷ', 'nghìn tỷ', 'triệu tỷ'];

            if (num === 0) return 'không';

            let words = '';
            let scaleIndex = 0;

            while (num > 0) {
                const hundreds = Math.floor(num % 1000 / 100);
                const ten = Math.floor(num % 100 / 10);
                const unit = num % 10;

                let scaleWords = '';

                if (hundreds > 0) {
                    scaleWords += units[hundreds] + ' trăm ';
                }

                if (ten > 1) {
                    scaleWords += tens[ten] + ' ';
                    if (unit > 0) {
                        scaleWords += (unit === 1 && ten > 1) ? 'mốt' : units[unit];
                    }
                } else if (ten === 1) {
                    scaleWords += 'mười ';
                    if (unit > 0) {
                        scaleWords += (unit === 5) ? 'lăm' : units[unit];
                    }
                } else if (unit > 0) {
                    scaleWords += units[unit];
                }

                if (scaleWords) {
                    words = scaleWords + (scaleIndex > 0 ? ' ' + scales[scaleIndex] + ' ' : '') + words;
                }

                num = Math.floor(num / 1000);
                scaleIndex++;
            }

            // Viết hoa chữ cái đầu tiên
            words = words.trim();
            return words.charAt(0).toUpperCase() + words.slice(1) + ' đồng';

        }

        // Function to fetch specific order by ID from AppSheet
        async function fetchOrderById(orderId) {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error-message');

            loadingElement.style.display = 'block';
            errorElement.style.display = 'none';

            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Đơn hàng/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: `Filter([Đơn hàng], [ID đơn hàng] = "${orderId}")`
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                loadingElement.style.display = 'none';

                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format received');
                }

                // Tìm đơn hàng có ID chính xác
                const exactOrder = data.find(order => order['ID đơn hàng'] === orderId);

                if (!exactOrder) {
                    throw new Error(`Không tìm thấy đơn hàng với mã: ${orderId}`);
                }

                return exactOrder; // Trả về đơn hàng chính xác
            } catch (error) {
                console.error('Failed to fetch order data:', error);
                loadingElement.style.display = 'none';
                errorElement.textContent = error.message || 'Có lỗi xảy ra khi tải dữ liệu đơn hàng.';
                errorElement.style.display = 'block';
                throw error;
            }
        }

        // Thêm hàm mới để lấy thông tin khách hàng theo ID
        async function fetchCustomerById(customerId) {
            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Khách hàng/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: `Filter([Khách hàng], [ID khách hàng] = "${customerId}")`
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format received');
                }

                // Tìm khách hàng có ID chính xác
                const exactCustomer = data.find(customer => customer['ID khách hàng'] === customerId);

                if (!exactCustomer) {
                    throw new Error(`Không tìm thấy khách hàng với ID: ${customerId}`);
                }

                return exactCustomer; // Trả về khách hàng chính xác
            } catch (error) {
                console.error('Failed to fetch customer data:', error);
                throw error;
            }
        }

        // Thêm hàm mới để lấy hàng hóa theo ID đơn hàng
        async function fetchProductsByOrderId(orderId) {
            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Hàng hoá/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: `Filter([Hàng hoá], [ID đơn hàng] = "${orderId}")`
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format received');
                }

                // Lọc lại để đảm bảo chỉ lấy hàng hóa thuộc đơn hàng này
                const orderProducts = data.filter(product => product['ID đơn hàng'] === orderId);

                return orderProducts;
            } catch (error) {
                console.error('Failed to fetch product data:', error);
                throw error;
            }
        }

        // Cập nhật hàm hiển thị sản phẩm để sử dụng dữ liệu từ bảng Hàng hoá
        function displayProducts(products, tableBody, tableFooter, order) {
            tableBody.innerHTML = '';
            let subtotal = 0;

            if (!products || products.length === 0) {
                tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center;">Không có dữ liệu sản phẩm</td>
            </tr>
        `;
                if (tableFooter) {
                    tableFooter.innerHTML = '';
                }
                return 0;
            }

            products.forEach((item, index) => {
                const quantity = parseFloat(item['Số lượng']) || 0;
                const unitPrice = parseFloat(item['Đơn giá']) || 0;
                const total = parseFloat(item['Thành tiền hàng']) || (quantity * unitPrice);
                subtotal += total;

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${index + 1}</td>
            <td class="product-name">
                <div class="product-info">
                    <strong>${item['Tên hàng hoá'] || ''}</strong>
                    <span class="product-description">${item['Mô tả'] || ''}</span>
                </div>
            </td>
            <td>${item['Đơn vị tính'] || 'Cái'}</td>
            <td>${quantity}</td>
            <td>${formatCurrency(unitPrice)}</td>
            <td>${formatCurrency(total)}</td>
        `;

                tableBody.appendChild(row);
            });

            // Tính thuế GTGT 8%
            const tax = Math.round(subtotal * 0.08);
            const grandTotal = subtotal + tax;

            // Thêm dòng tổng cộng với thuế GTGT
            if (tableFooter) {
                tableFooter.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; font-weight: bold;">Cộng tiền hàng</td>
                        <td>${formatCurrency(subtotal)}</td>
                    </tr>
                    <tr>
                        <td colspan="5" style="text-align: center; font-weight: bold;">Thuế GTGT (8%)</td>
                        <td>${formatCurrency(tax)}</td>
                    </tr>
                    <tr>
                        <td colspan="5" style="text-align: center; font-weight: bold;">Tổng tiền thanh toán</td>
                        <td>${formatCurrency(grandTotal)}</td>
                    </tr>
                    <tr>
                        <td colspan="5" style="text-align: center; font-weight: bold;">Tạm ứng</td>
                        <td>${formatCurrency(order['Số tiền đã thu'] || 0)}</td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="5" style="text-align: center; font-weight: bold;">Còn lại</td>
                        <td>${formatCurrency(order['Số tiền còn phải thu'] || 0)}</td>
                    </tr>
                    
                `;
            }

            // Update to use remaining amount for total in words
            const remainingAmount = order['Số tiền còn phải thu'] || 0;
            document.getElementById('total-in-words').textContent = `${numberToWords(Math.round(remainingAmount))}.`;

            return grandTotal;
        }

        // Cập nhật hàm displayOrderData để hiển thị xác nhận đặt hàng
        async function displayOrderData(order) {
            try {
                // Lấy ID khách hàng từ đơn hàng
                const customerId = order['ID khách hàng'];
                const orderId = order['ID đơn hàng'];

                if (!customerId) {
                    throw new Error('Không tìm thấy ID khách hàng trong đơn hàng');
                }

                // Truy vấn thông tin khách hàng từ bảng Khách hàng
                const customer = await fetchCustomerById(customerId);

                // Truy vấn hàng hóa từ bảng Hàng hoá theo ID đơn hàng
                const products = await fetchProductsByOrderId(orderId);

                // Cập nhật thông tin đơn hàng
                document.getElementById('order-number').textContent = order['Mã đơn hàng'] || '';
                document.getElementById('order-date').textContent = formatDate(order['Ngày đặt hàng'] || new Date());

                // Cập nhật thông tin khách hàng
                document.getElementById('customer-name').textContent = customer['Tên khách hàng đầy đủ'] || 'Quý khách hàng';
                document.getElementById('tax-code').textContent = customer['MST'] || '';
                document.getElementById('invoice-address').textContent = customer['Địa chỉ Hoá đơn'] || '';

                // Cập nhật thông tin người nhận
                document.getElementById('recipient-name').textContent = customer['Tên khách hàng đầy đủ'] || '';
                document.getElementById('recipient-phone').textContent = customer['SĐT'] || '';
                document.getElementById('delivery-address').textContent = customer['Địa chỉ trả hàng'] || '';

                // Hiển thị danh sách sản phẩm từ bảng Hàng hoá
                const tableBody = document.getElementById('product-table-body');
                const tableFooter = document.getElementById('table-footer');

                displayProducts(products, tableBody, tableFooter, order);

            } catch (error) {
                console.error('Error displaying order data:', error);
                document.getElementById('error-message').textContent = 'Lỗi hiển thị dữ liệu đơn hàng: ' + error.message;
                document.getElementById('error-message').style.display = 'block';
            }
        }

        async function exportToWordTemplate() {
            try {
                // Verify order data exists
                if (!order) {
                    throw new Error('Không tìm thấy thông tin đơn hàng');
                }

                // Lấy thông tin cơ bản
                const orderNumber = document.getElementById('order-number').textContent;
                const orderDate = document.getElementById('order-date').textContent;
                const customerName = document.getElementById('customer-name').textContent;
                const taxCode = document.getElementById('tax-code').textContent;
                const invoiceAddress = document.getElementById('invoice-address').textContent;
                const recipientName = document.getElementById('recipient-name').textContent;
                const recipientPhone = document.getElementById('recipient-phone').textContent;
                const deliveryAddress = document.getElementById('delivery-address').textContent;
                const totalInWords = document.getElementById('total-in-words').textContent;

                // Lấy thông tin thanh toán và đảm bảo có giá trị mặc định là 0
                const tienDaThu = parseFloat(order['Số tiền đã thu']) || 0;
                const tienConPhaiThu = parseFloat(order['Số tiền còn phải thu']) || 0;

                // Calculate subtotal from products
                let subtotal = 0;
                const products = [];
                const rows = document.querySelectorAll('#product-table-body tr');

                rows.forEach((row, index) => {
                    const cells = row.cells;
                    if (cells.length === 6) {
                        const cellContent = cells[1].innerHTML;
                        const productDiv = document.createElement('div');
                        productDiv.innerHTML = cellContent;

                        const strongElement = productDiv.querySelector('strong');
                        const descElement = productDiv.querySelector('.product-description');

                        const tenHangHoa = strongElement ? strongElement.textContent.trim() : '';
                        const moTa = descElement ? descElement.textContent.trim() : '';

                        const quantity = parseFloat(cells[3].textContent.trim().replace(/[,.]/g, '')) || 0;
                        const unitPrice = parseFloat(cells[4].textContent.trim().replace(/[,.]/g, '')) || 0;
                        const total = parseFloat(cells[5].textContent.trim().replace(/[,.]/g, '')) || 0;
                        subtotal += total;

                        products.push({
                            stt: (index + 1).toString(),
                            ten_hang_hoa: tenHangHoa,
                            mo_ta: moTa,
                            dvt: cells[2].textContent.trim(),
                            so_luong: formatCurrency(quantity),
                            don_gia: formatCurrency(unitPrice),
                            thanh_tien: formatCurrency(total)
                        });
                    }
                });

                // Calculate tax and total
                const tax = Math.round(subtotal * 0.08);
                const grandTotal = subtotal + tax;

                // Load template
                const response = await fetch('https://hoangmv.github.io/templates/phieuxuatkho_template.docx');
                if (!response.ok) {
                    throw new Error('Không thể tải template Word');
                }
                const templateContent = await response.arrayBuffer();

                // Create new PizZip and docxtemplater instance
                const zip = new PizZip(templateContent);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true
                });

                // Set template data
                const data = {
                    order_number: orderNumber,
                    order_date: orderDate,
                    customer_name: customerName,
                    tax_code: taxCode,
                    invoice_address: invoiceAddress,
                    recipient_name: recipientName,
                    recipient_phone: recipientPhone,
                    delivery_address: deliveryAddress,
                    products: products,
                    subtotal: formatCurrency(subtotal),
                    tax_amount: formatCurrency(tax),
                    grand_total: formatCurrency(grandTotal),
                    total_in_words: totalInWords,
                    prepaid_amoun: formatCurrency(tienDaThu),
                    remaining_amount: formatCurrency(tienConPhaiThu)
                };

                // Render template
                doc.setData(data);
                doc.render();

                // Generate and download file
                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                });

                const fileName = `Phieu_xuat_kho_${orderNumber}.docx`;
                saveAs(blob, fileName);

            } catch (error) {
                console.error('Error exporting to Word template:', error);
                if (error.properties && error.properties.errors) {
                    console.log('Template Error details:', error.properties.errors);
                }
                alert('Có lỗi khi xuất file Word: ' + error.message);
            }
        }

   
        // Thêm khai báo biến ở phạm vi toàn cục (bên ngoài các hàm)
        let order;

        // Sửa hàm initializePage để lưu order vào biến toàn cục
        async function initializePage() {
            // Lấy order ID từ tham số URL
            const orderId = getUrlParameter('id');

            if (!orderId) {
                document.getElementById('error-message').textContent = 'Không tìm thấy mã đơn hàng trong URL. Vui lòng kiểm tra lại đường dẫn.';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                return;
            }

            try {
                // Lấy đơn hàng theo ID và lưu vào biến toàn cục
                order = await fetchOrderById(orderId);

                console.log('Order data loaded:', order);
                await displayOrderData(order);
            } catch (error) {
                console.error('Failed to initialize page:', error);
                document.getElementById('error-message').textContent = 'Không thể tải dữ liệu đơn hàng. Vui lòng thử lại sau.';
                document.getElementById('error-message').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }


        async function exportToExcelWithExcelJS() {
            try {
                document.getElementById('loading').style.display = 'block';

                // Lấy thông tin cơ bản
                const orderNumber = document.getElementById('order-number').textContent;
                const orderDate = document.getElementById('order-date').textContent;
                const customerName = document.getElementById('customer-name').textContent;
                const taxCode = document.getElementById('tax-code').textContent;
                const invoiceAddress = document.getElementById('invoice-address').textContent;
                const recipientName = document.getElementById('recipient-name').textContent;
                const recipientPhone = document.getElementById('recipient-phone').textContent;
                const deliveryAddress = document.getElementById('delivery-address').textContent;
                const totalInWords = document.getElementById('total-in-words').textContent;

                // Tạo workbook và worksheet mới
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Phiếu xuất kho');

                // Tải logo từ URL
                const logoResponse = await fetch('https://hoangmv.github.io/ducthanh/ducthanhlogo.png');
                const logoArrayBuffer = await logoResponse.arrayBuffer();

                // Thêm logo vào worksheet
                const logoId = workbook.addImage({
                    buffer: logoArrayBuffer,
                    extension: 'png',
                });

                // Chèn logo vào ô A1 với kích thước phù hợp
                worksheet.addImage(logoId, {
                    tl: { col: 0, row: 0 },           // Top-left corner (ô A1)
                    br: { col: 1.5, row: 3 },         // Bottom-right corner
                    editAs: 'oneCell'                  // Giữ tỷ lệ khi điều chỉnh kích thước ô
                });

                // Thêm header công ty (đặt bên cạnh logo)
                worksheet.mergeCells('C1:I1');
                const headerCell = worksheet.getCell('C1');
                headerCell.value = 'CÔNG TY TNHH SẢN XUẤT VÀ DỊCH VỤ ĐỨC THÀNH';
                headerCell.font = { bold: true, size: 14 };
                headerCell.alignment = { horizontal: 'right' };

                worksheet.mergeCells('C2:I2');
                worksheet.getCell('C2').value = 'VPGD: Số 11/49/64 Nguyễn Lương Bằng, Ô Chợ Dừa, Đống Đa, Hà Nội';
                worksheet.getCell('C2').alignment = { horizontal: 'right' };

                worksheet.mergeCells('C3:I3');
                worksheet.getCell('C3').value = 'Số ĐKKD: 0108325268. Điện thoại: 024 6682 6686 | Email: info@inducthanh.vn';
                worksheet.getCell('C3').alignment = { horizontal: 'right' };

                // Tiêu đề phiếu xuất kho
                worksheet.mergeCells('A5:I5');
                const titleCell = worksheet.getCell('A5');
                titleCell.value = 'PHIẾU XUẤT KHO BÁN HÀNG';
                titleCell.font = { bold: true, size: 16 };
                titleCell.alignment = { horizontal: 'center' };

                // Thông tin đơn hàng
                worksheet.mergeCells('A6:I6');
                worksheet.getCell('A6').value = `Số đơn hàng: ${orderNumber} - Ngày đặt hàng: ${orderDate}`;
                worksheet.getCell('A6').alignment = { horizontal: 'center' };

                // Thông tin khách hàng
                worksheet.mergeCells('A8:I8');
                worksheet.getCell('A8').value = `Khách hàng: ${customerName}`;
                worksheet.getCell('A8').fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFF2F9F2' }
                };

                worksheet.mergeCells('A9:I9');
                worksheet.getCell('A9').value = `Mã số thuế: ${taxCode}`;
                worksheet.getCell('A9').fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFF2F9F2' }
                };

                worksheet.mergeCells('A10:I10');
                worksheet.getCell('A10').value = `Địa chỉ hoá đơn: ${invoiceAddress}`;
                worksheet.getCell('A10').fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFF2F9F2' }
                };

                // Thông tin giao hàng
                worksheet.mergeCells('A11:E11');
                worksheet.getCell('A11').value = `Người nhận hàng: ${recipientName}`;
                worksheet.getCell('A11').fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFF2F9F2' }
                };

                worksheet.mergeCells('F11:I11');
                worksheet.getCell('F11').value = `SĐT người nhận: ${recipientPhone}`;
                worksheet.getCell('F11').fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFF2F9F2' }
                };

                worksheet.mergeCells('A12:I12');
                worksheet.getCell('A12').value = `Địa chỉ giao hàng: ${deliveryAddress}`;
                worksheet.getCell('A12').fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFF2F9F2' }
                };

                // Thêm tiêu đề Chi tiết hàng hoá
                worksheet.mergeCells('A14:I14');
                worksheet.getCell('A14').value = 'Chi tiết hàng hoá:';
                worksheet.getCell('A14').font = { italic: true };

                // Thêm header bảng
                const headerRow = worksheet.addRow(['STT', 'HÀNG HÓA', '', '', '', 'ĐVT', 'SL', 'ĐƠN GIÁ', 'THÀNH TIỀN']);
                worksheet.mergeCells('B15:E15');
                // Style cho header
                headerRow.eachCell((cell) => {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFA7D2A7' }
                    };
                    cell.font = { bold: true };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });

                // Lấy dữ liệu sản phẩm từ bảng HTML
                let currentRow = 16;
                let subtotal = 0;
                const rows = document.querySelectorAll('#product-table-body tr');

                rows.forEach((row, index) => {
                    const cells = row.cells;
                    if (cells.length === 6) {
                        // Trích xuất thông tin sản phẩm
                        const cellContent = cells[1].innerHTML;
                        const productDiv = document.createElement('div');
                        productDiv.innerHTML = cellContent;

                        const strongElement = productDiv.querySelector('strong');
                        const descElement = productDiv.querySelector('.product-description');

                        const tenHangHoa = strongElement ? strongElement.textContent.trim() : '';
                        const moTa = descElement ? descElement.textContent.trim() : '';

                        // Phân tích các giá trị số
                        const quantity = parseFloat(cells[3].textContent.trim().replace(/[,.]/g, '')) || 0;
                        const unitPrice = parseFloat(cells[4].textContent.trim().replace(/[,.]/g, '')) || 0;
                        const total = parseFloat(cells[5].textContent.trim().replace(/[,.]/g, '')) || 0;
                        subtotal += total;

                        // Thêm dòng sản phẩm
                        const productRow = worksheet.addRow([index + 1, tenHangHoa, '', '', '', cells[2].textContent.trim(), quantity, unitPrice, total]);
                        worksheet.mergeCells(`B${currentRow}:E${currentRow}`);

                        // Style cho các ô
                        productRow.eachCell((cell) => {
                            cell.border = {
                                top: { style: 'thin' },
                                left: { style: 'thin' },
                                bottom: { style: 'thin' },
                                right: { style: 'thin' }
                            };
                        });

                        // Căn lề cho các loại dữ liệu
                        productRow.getCell(1).alignment = { horizontal: 'center' }; // STT
                        productRow.getCell(2).alignment = { horizontal: 'left' };   // Tên hàng
                        productRow.getCell(6).alignment = { horizontal: 'center' }; // ĐVT
                        productRow.getCell(7).alignment = { horizontal: 'center' }; // SL
                        productRow.getCell(8).alignment = { horizontal: 'right' };  // Đơn giá
                        productRow.getCell(9).alignment = { horizontal: 'right' };  // Thành tiền

                        // Format tiền tệ
                        productRow.getCell(8).numFmt = '#,##0';
                        productRow.getCell(9).numFmt = '#,##0';

                        currentRow++;

                        // Nếu có mô tả, thêm dòng mô tả
                        if (moTa) {
                            const descRow = worksheet.addRow(['', moTa, '', '', '', '', '', '', '']);
                            worksheet.mergeCells(`B${currentRow}:E${currentRow}`);

                            // Style cho dòng mô tả
                            descRow.eachCell((cell) => {
                                cell.border = {
                                    top: { style: 'thin' },
                                    left: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    right: { style: 'thin' }
                                };
                            });

                            descRow.getCell(2).alignment = { horizontal: 'left' };
                            descRow.getCell(2).font = { color: { argb: 'FF666666' } };

                            currentRow++;
                        }
                    }
                });

                // Tính thuế 8%
                const tax = Math.round(subtotal * 0.08);
                const grandTotal = subtotal + tax;

                // Thêm dòng tổng cộng
                const subtotalRow = worksheet.addRow(['Cộng tiền hàng', '', '', '', '', 'Cộng tiền hàng', '', '', subtotal]);
                worksheet.mergeCells(`A${currentRow}:H${currentRow}`);

                // Style cho dòng tổng
                subtotalRow.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                    if (cell.col === 9) {
                        cell.numFmt = '#,##0';
                    }
                });
                subtotalRow.getCell(6).alignment = { horizontal: 'center', vertical: 'middle' };
                subtotalRow.getCell(6).font = { bold: true };
                subtotalRow.getCell(9).alignment = { horizontal: 'right' };

                currentRow++;

                // Thêm dòng thuế
                const taxRow = worksheet.addRow(['Thuế GTGT (8%)', '', '', '', '', '', '', '', tax]);
                worksheet.mergeCells(`A${currentRow}:H${currentRow}`);

                // Style cho dòng thuế
                taxRow.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                    if (cell.col === 9) {
                        cell.numFmt = '#,##0';
                    }
                });
                taxRow.getCell(6).alignment = { horizontal: 'center', vertical: 'middle' };
                taxRow.getCell(6).font = { bold: true };
                taxRow.getCell(9).alignment = { horizontal: 'right' };

                currentRow++;

                // Thêm dòng tổng tiền thanh toán
                const grandTotalRow = worksheet.addRow(['Tổng tiền thanh toán', '', '', '', '', '', '', '', grandTotal]);
                worksheet.mergeCells(`A${currentRow}:H${currentRow}`);

                // Style cho dòng tổng tiền
                grandTotalRow.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                    if (cell.col === 9) {
                        cell.numFmt = '#,##0';
                    }
                });
                grandTotalRow.getCell(6).alignment = { horizontal: 'center', vertical: 'middle' };
                grandTotalRow.getCell(6).font = { bold: true };
                grandTotalRow.getCell(9).alignment = { horizontal: 'right' };

                currentRow++;

                // Thêm dòng tạm ứng
                const advanceRow = worksheet.addRow(['Tạm ứng', '', '', '', '', '', '', '', parseFloat(order['Số tiền đã thu'] || 0)]);
                worksheet.mergeCells(`A${currentRow}:H${currentRow}`);

                // Style cho dòng tạm ứng
                advanceRow.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                    if (cell.col === 9) {
                        cell.numFmt = '#,##0';
                    }
                });
                advanceRow.getCell(6).alignment = { horizontal: 'center', vertical: 'middle' };
                advanceRow.getCell(6).font = { bold: true };
                advanceRow.getCell(9).alignment = { horizontal: 'right' };

                currentRow++;

                // Thêm dòng còn lại
                const remainingRow = worksheet.addRow(['Còn lại', '', '', '', '', '', '', '', parseFloat(order['Số tiền còn phải thu'] || 0)]);
                worksheet.mergeCells(`A${currentRow}:H${currentRow}`);

                // Style cho dòng còn lại
                remainingRow.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                    if (cell.col === 9) {
                        cell.numFmt = '#,##0';
                    }
                });
                remainingRow.getCell(6).alignment = { horizontal: 'center', vertical: 'middle' };
                remainingRow.getCell(6).font = { bold: true };
                remainingRow.getCell(9).alignment = { horizontal: 'right' };

                currentRow += 2;

                // Thêm số tiền bằng chữ
                worksheet.mergeCells(`A${currentRow}:I${currentRow}`);
                const wordCell = worksheet.getCell(`A${currentRow}`);
                wordCell.value = 'Số tiền bằng chữ: '+ totalInWords;
                wordCell.font = { bold: true };

                currentRow += 3;

                // Thêm phần chữ ký
                const buyerCell = worksheet.getCell(`C${currentRow}`);
                buyerCell.value = 'BÊN MUA';
                buyerCell.font = { bold: true };
                buyerCell.alignment = { horizontal: 'center' };

                const sellerCell = worksheet.getCell(`G${currentRow}`);
                sellerCell.value = 'BÊN BÁN';
                sellerCell.font = { bold: true };
                sellerCell.alignment = { horizontal: 'center' };

                currentRow++;

                worksheet.getCell(`C${currentRow}`).value = '(Ký, họ tên)';
                worksheet.getCell(`C${currentRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`C${currentRow}`).font = { italic: true };

                worksheet.getCell(`G${currentRow}`).value = '(Ký, họ tên)';
                worksheet.getCell(`G${currentRow}`).alignment = { horizontal: 'center' };
                worksheet.getCell(`G${currentRow}`).font = { italic: true };

                // Tạo blob và tải xuống
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                saveAs(blob, `Phieu_xuat_kho_${orderNumber}.xlsx`);

            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Có lỗi khi xuất file Excel: ' + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Chạy khi tài liệu đã tải xong
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>

</html>