<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Báo Giá - Đức Thành</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- Thêm các thư viện cần thiết -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Times+New+Roman:wght@400;700&display=swap');

        body {
            font-family: 'Times New Roman', Times, serif;
            line-height: 1.3;
            margin: 0;
            color: #000;
            font-size: 12pt;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            padding: 5px;
        }

        .header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .logo-container {
            width: 25%;
        }

        .logo {
            max-width: 150px;
        }

        .company-info {
            width: 75%;
            text-align: right;
            font-size: 11pt;
            line-height: 1.4;
        }

        .company-name {
            font-weight: bold;
            font-size: 12pt;
        }

        .title {
            text-align: center;
            font-size: 16pt;
            font-weight: bold;
            margin: 25px 0 5px 0;
        }

        .order-info {
            text-align: center;
            margin-bottom: 25px;
        }

        .client-info {
            background-color: #e6f2ff;
            padding: 10px 15px;
            margin-bottom: 10px;
            line-height: 1.1;

        }

        .intro-text {
            font-style: italic;
            margin: 5px 0;
            line-height: 1.3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }

        table,
        th,
        td {
            border: 1px solid #000;
        }

        th {
            background-color: #f0a500;
            color: #000;
            text-align: center;
            padding: 8px 4px;
            font-weight: bold;
        }

        td {
            padding: 6px 4px;
            text-align: center;
        }

        .notes {
            margin-bottom: 15px;
            line-height: 1.1;

        }

        .payment-info {
            margin-bottom: 15px;
            line-height: 1.1;
        }

        .payment-info p {
            margin: 3px 0;
        }

        .signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .signature {
            text-align: center;
            width: 45%;
        }

        .director-signature {
            position: relative;
        }

        .stamp {
            position: absolute;
            width: 230px;
            height: 150px;
            left: 45%;
            transform: translateX(-50%);
            opacity: 0.9;
        }

        .underline {
            text-decoration: underline;
        }

        .section-title {
            font-weight: bold;
            text-decoration: underline;
        }

        .hang-hoa {
            text-align: left;
        }

        .product-name {
            text-align: left;
            padding-left: 10px;
        }

        p {
            margin: 5px 0;
        }

        #loading {
            text-align: center;
            display: none;
            margin: 20px 0;
        }

        #error-message {
            color: red;
            text-align: center;
            display: none;
            margin: 20px 0;
        }

        .total-row td {
            font-weight: bold;
        }

        .product-info {
            text-align: left;
            padding-left: 10px;
        }

        .product-info strong {
            display: block;
        }

        .product-description {
            display: block;
            margin-top: 5px;
            color: #666;
        }

        .print-button-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        #printButton {
            background-color: #f0a500;
            border: none;
            color: #000;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Times New Roman', Times, serif;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #printButton:hover {
            background-color: #d89400;
        }

        .print-button-container {
            display: flex;
            gap: 10px;
        }

        #exportButton {
            background-color: #2b579a;
            border: none;
            color: #fff;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Times New Roman', Times, serif;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #exportButton:hover {
            background-color: #1e3f6f;
        }

        #excelButton {
            background-color: #217346;
            border: none;
            color: #fff;
            padding: 8px 16px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Times New Roman', Times, serif;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #excelButton:hover {
            background-color: #1e5e3a;
        }

        @media print {
            .print-button-container {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="print-button-container">
        <button id="printButton" onclick="window.print()">
            <i class="fas fa-print"></i> In xác nhận
        </button>
        <button id="excelButton" onclick="exportToExcelTemplate()">
            <i class="fas fa-file-excel"></i> Xuất Excel
        </button>
        <button id="exportButton" onclick="exportToWordTemplate()">
            <i class="fas fa-file-word"></i> Xuất Word
        </button>
    </div>

    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="https://hoangmv.github.io/ducthanh/ducthanhlogo.png" alt="DUC THANH" class="logo">
            </div>
            <div class="company-info">
                <div class="company-name">CÔNG TY TNHH SẢN XUẤT VÀ DỊCH VỤ ĐỨC THÀNH</div>
                VPGD: Số 11/49/64 Nguyễn Lương Bằng, Ô Chợ Dừa, Đống Đa, Hà Nội<br>
                Số ĐKKD: 0108325268. Điện thoại: 024 6682 6686 | Email: <span
                    class="underline">info@inducthanh.vn</span><br>
                Website: <span class="underline">www.inducthanh.com</span> | <span
                    class="underline">www.inlayngay.vn</span>
            </div>
        </div>

        <div class="title">BẢNG BÁO GIÁ</div>
        <div class="order-info"><strong>Số báo giá:</strong> <span id="order-number">Đang tải...</span> - <strong>Ngày
                báo giá</strong> <span id="order-date">Đang tải...</span></div>

        <div class="client-info">
            <p><strong>Khách hàng:</strong> <span id="customer-name">Đang tải...</span></p>
            <p><strong>Mã số thuế:</strong> <span id="tax-code">Đang tải...</span></p>
            <p><strong>Địa chỉ:</strong> <span id="invoice-address">Đang tải...</span></p>
        </div>

        <div class="intro-text">
            <i>Lời đầu tiên, xin trân trọng cảm ơn quý khách hàng đã quan tâm đến sản phẩm của công ty chúng tôi.
                Đức Thành xin gửi đến quý khách hàng bảng báo giá như sau:</i>
        </div>

        <div id="loading">Đang tải dữ liệu...</div>
        <div id="error-message">Có lỗi xảy ra khi tải dữ liệu. Vui lòng thử lại sau.</div>

        <table>
            <thead>
                <tr>
                    <th width="10%">STT</th>
                    <th width="37%">HÀNG HÓA</th>
                    <th width="10%">ĐVT</th>
                    <th width="10%">SL</th>
                    <th width="17%">ĐƠN GIÁ</th>
                    <th width="17%">THÀNH TIỀN</th>
                </tr>
            </thead>
            <tbody id="product-table-body">
                <!-- Dữ liệu sản phẩm sẽ được điền vào đây -->
            </tbody>
            <tfoot id="table-footer">
                <!-- Dữ liệu tổng cộng sẽ được điền vào đây -->
            </tfoot>
        </table>


        <div class="notes">
            <p class="section-title">Ghi chú:</p>
            <p>- Giá chưa bao gồm thuế VAT (8%)</p>
            <p>- Miễn phí vận chuyển nội thành Hà Nội với những đơn hàng có giá trị từ 1,5 triệu đồng.</p>
            <p>- Báo giá này có hiệu lực trong 07 ngày kể từ ngày lập.</p>
        </div>

        <div class="payment-info">
            <p class="section-title">Thông tin thanh toán:</p>
            <p>· Ngân hàng Quân Đội (MB Bank) - CN Gia Lâm. STK: 6666.939.8888 - Đỗ Trọng Nghĩa</p>
            <p>· Ngân hàng VPBank - CN Thăng Long – STK: 156939258 - Công ty TNHH Sản xuất và Dịch vụ Đức Thành (DUC
                THANH SERPRO)</p>
        </div>

        <div class="signatures">
            <div class="signature">
                <p><strong>Người lập</strong></p>
                <p><i>(Ký, họ tên)</i></p>
                <div id="preparer-name"></div>
            </div>
            <div class="signature director-signature">
                <p><strong>Giám đốc</strong></p>
                <p><i>(Ký, họ tên, đóng dấu)</i></p>
                <img src="https://hoangmv.github.io/ducthanh/chukiducthanh.png" alt="Dấu công ty" class="stamp">
            </div>
        </div>
    </div>



    <!-- Thêm vào phần head, sau các script hiện có -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script>
        // Constants for AppSheet connection
        const appId = 'd4e7fd95-42b6-4a41-ab3e-eac72731fe07';
        const accessKey = 'V2-3dYqz-xwhyz-B41Kw-E9nvf-hATE7-YNdCe-9JYUY-6A7q3';
        const region = 'www';

        // Function to get URL parameters
        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            var results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }

        // Function to format number as currency
        function formatCurrency(number) {
            return number.toLocaleString('vi-VN');
        }

        // Function to format date to Vietnamese format
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '/');
        }

        // Function to fetch specific order by ID from AppSheet
        async function fetchOrderById(orderId) {
            const loadingElement = document.getElementById('loading');
            const errorElement = document.getElementById('error-message');

            loadingElement.style.display = 'block';
            errorElement.style.display = 'none';

            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Đơn hàng/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: `Filter([Đơn hàng], [ID đơn hàng] = "${orderId}")`
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                loadingElement.style.display = 'none';

                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format received');
                }

                // Tìm đơn hàng có ID chính xác
                const exactOrder = data.find(order => order['ID đơn hàng'] === orderId);

                if (!exactOrder) {
                    throw new Error(`Không tìm thấy đơn hàng với mã: ${orderId}`);
                }

                return exactOrder; // Trả về đơn hàng chính xác
            } catch (error) {
                console.error('Failed to fetch order data:', error);
                loadingElement.style.display = 'none';
                errorElement.textContent = error.message || 'Có lỗi xảy ra khi tải dữ liệu đơn hàng.';
                errorElement.style.display = 'block';
                throw error;
            }
        }

        // Thêm hàm mới để lấy thông tin khách hàng theo ID
        async function fetchCustomerById(customerId) {
            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Khách hàng/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: `Filter([Khách hàng], [ID khách hàng] = "${customerId}")`
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format received');
                }

                // Tìm khách hàng có ID chính xác
                const exactCustomer = data.find(customer => customer['ID khách hàng'] === customerId);

                if (!exactCustomer) {
                    throw new Error(`Không tìm thấy khách hàng với ID: ${customerId}`);
                }

                return exactCustomer; // Trả về khách hàng chính xác
            } catch (error) {
                console.error('Failed to fetch customer data:', error);
                throw error;
            }
        }

        // Thêm hàm mới để lấy hàng hóa theo ID đơn hàng
        async function fetchProductsByOrderId(orderId) {
            try {
                const response = await fetch(`https://${region}.appsheet.com/api/v2/apps/${appId}/tables/Hàng hoá/Action`, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: 'Find',
                        Properties: {},
                        Selector: `Filter([Hàng hoá], [ID đơn hàng] = "${orderId}")`
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format received');
                }

                // Lọc lại để đảm bảo chỉ lấy hàng hóa thuộc đơn hàng này
                const orderProducts = data.filter(product => product['ID đơn hàng'] === orderId);

                return orderProducts;
            } catch (error) {
                console.error('Failed to fetch product data:', error);
                throw error;
            }
        }

        // Cập nhật hàm hiển thị sản phẩm để sử dụng dữ liệu từ bảng Hàng hoá
        function displayProducts(products, tableBody, tableFooter) {
            tableBody.innerHTML = '';
            let subtotal = 0;

            if (!products || products.length === 0) {
                tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center;">Không có dữ liệu sản phẩm</td>
            </tr>
        `;
                if (tableFooter) {
                    tableFooter.innerHTML = '';
                }
                return 0;
            }

            products.forEach((item, index) => {
                const quantity = parseFloat(item['Số lượng']) || 0;
                const unitPrice = parseFloat(item['Đơn giá']) || 0;
                const total = parseFloat(item['Thành tiền hàng']) || (quantity * unitPrice);
                subtotal += total;

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${index + 1}</td>
            <td class="product-name">
                <div class="product-info">
                    <strong>${item['Tên hàng hoá'] || ''}</strong>
                    <span class="product-description">${item['Mô tả'] || ''}</span>
                </div>
            </td>
            <td>${item['Đơn vị tính'] || 'Cái'}</td>
            <td>${quantity}</td>
            <td>${formatCurrency(unitPrice)}</td>
            <td>${formatCurrency(total)}</td>
        `;

                tableBody.appendChild(row);
            });

            // Thêm dòng tổng cộng
            if (tableFooter) {
                tableFooter.innerHTML = `
            <tr class="total-row">
                <td colspan="5" style="text-align: right;">Tổng cộng:</td>
                <td>${formatCurrency(subtotal)}</td>
            </tr>
        `;
            }
        }

        // Cập nhật hàm displayOrderData để hiển thị xác nhận đặt hàng
        async function displayOrderData(order) {
            try {
                // Lấy ID khách hàng từ đơn hàng
                const customerId = order['ID khách hàng'];
                const orderId = order['ID đơn hàng'];

                if (!customerId) {
                    throw new Error('Không tìm thấy ID khách hàng trong đơn hàng');
                }

                // Truy vấn thông tin khách hàng từ bảng Khách hàng
                const customer = await fetchCustomerById(customerId);

                // Truy vấn hàng hóa từ bảng Hàng hoá theo ID đơn hàng
                const products = await fetchProductsByOrderId(orderId);

                // Cập nhật thông tin đơn hàng
                document.getElementById('order-number').textContent = order['Mã đơn hàng'] || '';
                document.getElementById('order-date').textContent = formatDate(order['Ngày đặt hàng'] || new Date());

                // Cập nhật thông tin khách hàng
                document.getElementById('customer-name').textContent = customer['Tên khách hàng đầy đủ'] || 'Quý khách hàng';
                document.getElementById('tax-code').textContent = customer['MST'] || '';
                document.getElementById('invoice-address').textContent = customer['Địa chỉ Hoá đơn'] || '';

                // Hiển thị danh sách sản phẩm từ bảng Hàng hoá
                const tableBody = document.getElementById('product-table-body');
                const tableFooter = document.getElementById('table-footer');

                displayProducts(products, tableBody, tableFooter);

            } catch (error) {
                console.error('Error displaying order data:', error);
                document.getElementById('error-message').textContent = 'Lỗi hiển thị dữ liệu đơn hàng: ' + error.message;
                document.getElementById('error-message').style.display = 'block';
            }
        }

        async function exportToWordTemplate() {
            try {
                // Lấy thông tin cơ bản
                const orderNumber = document.getElementById('order-number').textContent;
                const orderDate = document.getElementById('order-date').textContent;
                const customerName = document.getElementById('customer-name').textContent;
                const taxCode = document.getElementById('tax-code').textContent;
                const invoiceAddress = document.getElementById('invoice-address').textContent;

                // Tính tổng tiền và thuế
                let subtotal = 0;
                // Trong hàm exportToWordTemplate, sửa phần lấy dữ liệu sản phẩm:

                const rows = document.querySelectorAll('#product-table-body tr');
                const products = [];

                rows.forEach((row, index) => {
                    const cells = row.cells;
                    if (cells.length === 6) {
                        // Lấy nội dung của cột hàng hóa một cách chính xác hơn
                        const cellContent = cells[1].innerHTML;
                        const productDiv = document.createElement('div');
                        productDiv.innerHTML = cellContent;

                        // Tách riêng tên hàng hóa và mô tả
                        const strongElement = productDiv.querySelector('strong');
                        const descElement = productDiv.querySelector('.product-description');

                        const tenHangHoa = strongElement ? strongElement.textContent.trim() : '';
                        const moTa = descElement ? descElement.textContent.trim() : '';
                        // Parse các giá trị số
                        const quantity = parseFloat(cells[3].textContent.trim().replace(/[,.]/g, '')) || 0;
                        const unitPrice = parseFloat(cells[4].textContent.trim().replace(/[,.]/g, '')) || 0;
                        const total = parseFloat(cells[5].textContent.trim().replace(/[,.]/g, '')) || 0;
                        subtotal += total;

                        // Thêm vào mảng sản phẩm với dữ liệu đã tách riêng
                        products.push({
                            stt: (index + 1).toString(),
                            ten_hang_hoa: tenHangHoa,
                            mo_ta: moTa,
                            dvt: cells[2].textContent.trim(),
                            so_luong: formatCurrency(quantity),
                            don_gia: formatCurrency(unitPrice),
                            thanh_tien: formatCurrency(total)
                        });
                    }
                });

                // Lấy template từ server
                const response = await fetch('https://hoangmv.github.io/templates/baogia_template.docx');
                if (!response.ok) {
                    throw new Error('Không thể tải template Word');
                }
                const templateContent = await response.arrayBuffer();

                // Tạo instance mới của PizZip và docxtemplater
                const zip = new PizZip(templateContent);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true
                });

                // Đặt dữ liệu vào template
                const data = {
                    order_number: orderNumber,
                    order_date: orderDate,
                    customer_name: customerName,
                    tax_code: taxCode,
                    invoice_address: invoiceAddress,
                    products: products,
                    subtotal: formatCurrency(subtotal)
                };

                // Render template với dữ liệu
                doc.setData(data);
                doc.render();

                // Tạo và tải file
                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
                });

                const fileName = `Bang_bao_gia_${orderNumber}.docx`;
                saveAs(blob, fileName);

            } catch (error) {
                console.error('Error exporting to Word template:', error);
                if (error.properties && error.properties.errors) {
                    console.log('Template Error details:', error.properties.errors);
                }
                alert('Có lỗi khi xuất file Word. Vui lòng thử lại sau.');
            }
        }


        // Add this function after the exportToWordTemplate function
        async function exportToExcelTemplate() {
            try {
                // Show loading indicator
                document.getElementById('loading').style.display = 'block';

                // Get basic order information
                const orderNumber = document.getElementById('order-number').textContent;
                const orderDate = document.getElementById('order-date').textContent;
                const customerName = document.getElementById('customer-name').textContent;
                const taxCode = document.getElementById('tax-code').textContent;
                const invoiceAddress = document.getElementById('invoice-address').textContent;

                // Calculate totals
                let subtotal = 0;
                const rows = document.querySelectorAll('#product-table-body tr');
                const products = [];

                rows.forEach((row, index) => {
                    const cells = row.cells;
                    if (cells.length === 6) {
                        // Extract product name and description
                        const cellContent = cells[1].innerHTML;
                        const productDiv = document.createElement('div');
                        productDiv.innerHTML = cellContent;

                        const strongElement = productDiv.querySelector('strong');
                        const descElement = productDiv.querySelector('.product-description');

                        const tenHangHoa = strongElement ? strongElement.textContent.trim() : '';
                        const moTa = descElement ? descElement.textContent.trim() : '';

                        // Parse numeric values
                        const quantity = parseFloat(cells[3].textContent.trim().replace(/[,.]/g, '')) || 0;
                        const unitPrice = parseFloat(cells[4].textContent.trim().replace(/[,.]/g, '')) || 0;
                        const total = parseFloat(cells[5].textContent.trim().replace(/[,.]/g, '')) || 0;
                        subtotal += total;

                        products.push({
                            stt: index + 1,
                            tenHangHoa: tenHangHoa,
                            moTa: moTa,
                            dvt: cells[2].textContent.trim(),
                            soLuong: quantity,
                            donGia: unitPrice,
                            thanhTien: total
                        });
                    }
                });

                // Calculate tax and total
                const tax = subtotal * 0.08;
                const grandTotal = subtotal + tax;

                // Load Excel template from server
                const response = await fetch('https://hoangmv.github.io/templates/baogia_template.xlsx');
                if (!response.ok) {
                    throw new Error('Không thể tải template Excel');
                }
                const templateArrayBuffer = await response.arrayBuffer();

                // Load the template workbook
                const workbook = XLSX.read(templateArrayBuffer, { type: 'array' });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];


                // --- Điền thông tin theo đúng vị trí trong mẫu Excel ---

                // Thông tin đơn hàng ở hàng 8
                XLSX.utils.sheet_add_aoa(worksheet, [[`${orderNumber}`]], { origin: 'D8' }); // Số báo giá
                XLSX.utils.sheet_add_aoa(worksheet, [[orderDate]], { origin: 'H8' }); // Ngày báo giá

                // Thông tin khách hàng ở các hàng 10, 11, 12
                XLSX.utils.sheet_add_aoa(worksheet, [[customerName]], { origin: 'C10' }); // Khách hàng
                XLSX.utils.sheet_add_aoa(worksheet, [[taxCode]], { origin: 'C11' }); // Mã số thuế
                XLSX.utils.sheet_add_aoa(worksheet, [[invoiceAddress]], { origin: 'C12' }); // Địa chỉ hóa đơn

                // --- Điền sản phẩm ---
                let currentRow = 18;

                // Kiểm tra nếu không có sản phẩm nào từ dữ liệu HTML, tạo sản phẩm mẫu
                if (products.length === 0) {
                    // Thêm sản phẩm mẫu giống như trong hình mẫu
                    XLSX.utils.sheet_add_aoa(worksheet, [[
                        1,
                        "Thép xây dựng CT2",
                        "",
                        "",
                        "",
                        "Thanh",
                        20,
                        200000,
                        4000000
                    ]], { origin: `A18` });

                    // Gộp ô cho tên sản phẩm
                    if (!worksheet['!merges']) worksheet['!merges'] = [];
                    worksheet['!merges'].push({ s: { r: 17, c: 1 }, e: { r: 17, c: 4 } });

                    // Thêm mô tả
                    XLSX.utils.sheet_add_aoa(worksheet, [[
                        "",
                        "Thép chịu lực",
                        "",
                        "",
                        "",
                        "",
                        "",
                        "",
                        ""
                    ]], { origin: `A19` });

                    // Gộp ô cho mô tả
                    worksheet['!merges'].push({ s: { r: 18, c: 1 }, e: { r: 18, c: 4 } });

                    // Thêm sản phẩm thứ 2
                    XLSX.utils.sheet_add_aoa(worksheet, [[
                        2,
                        "Gạch lát nền 60x60",
                        "",
                        "",
                        "",
                        "Thùng",
                        5,
                        450000,
                        2250000
                    ]], { origin: `A20` });

                    // Gộp ô cho tên sản phẩm thứ 2
                    worksheet['!merges'].push({ s: { r: 19, c: 1 }, e: { r: 19, c: 4 } });

                    // Thêm mô tả sản phẩm thứ 2
                    XLSX.utils.sheet_add_aoa(worksheet, [[
                        "",
                        "Gạch Eurotile",
                        "",
                        "",
                        "",
                        "",
                        "",
                        "",
                        ""
                    ]], { origin: `A21` });

                    // Gộp ô cho mô tả sản phẩm thứ 2
                    worksheet['!merges'].push({ s: { r: 20, c: 1 }, e: { r: 20, c: 4 } });

                    currentRow = 22;

                    // Set giá trị tổng
                    subtotal = 6250000;
                } else {
                    // Sử dụng dữ liệu sản phẩm từ HTML
                    products.forEach((product, index) => {
                        // Điền thông tin sản phẩm với tên hàng hóa chiếm từ cột B đến E
                        XLSX.utils.sheet_add_aoa(worksheet, [[
                            product.stt,           // Cột A - STT
                            product.tenHangHoa,    // Cột B - Tên hàng hóa
                            "",                    // Cột C - Để trống
                            "",                    // Cột D - Để trống
                            "",                    // Cột E - Để trống
                            product.dvt,           // Cột F - ĐVT
                            product.soLuong,       // Cột G - SL
                            product.donGia,        // Cột H - Đơn giá
                            product.thanhTien      // Cột I - Thành tiền
                        ]], { origin: `A${currentRow}` });

                        // Gộp ô cho tên hàng hóa (B-E)
                        if (!worksheet['!merges']) worksheet['!merges'] = [];
                        worksheet['!merges'].push({ s: { r: currentRow - 1, c: 1 }, e: { r: currentRow - 1, c: 4 } });

                        currentRow++;

                        // Nếu có mô tả, thêm hàng mô tả
                        if (product.moTa) {
                            XLSX.utils.sheet_add_aoa(worksheet, [[
                                "",                // Cột A - Để trống
                                product.moTa,      // Cột B - Mô tả
                                "",                // Cột C - Để trống
                                "",                // Cột D - Để trống
                                "",                // Cột E - Để trống
                                "",                // Cột F - Để trống
                                "",                // Cột G - Để trống
                                "",                // Cột H - Để trống
                                ""                 // Cột I - Để trống
                            ]], { origin: `A${currentRow}` });

                            // Gộp ô cho mô tả (B-E)
                            worksheet['!merges'].push({ s: { r: currentRow - 1, c: 1 }, e: { r: currentRow - 1, c: 4 } });

                            currentRow++;
                        }
                    });
                }

                // --- Thêm phần tổng cộng ---
                XLSX.utils.sheet_add_aoa(worksheet, [["Cộng tiền hàng"]], { origin: `F${currentRow}` });
                XLSX.utils.sheet_add_aoa(worksheet, [[subtotal]], { origin: `I${currentRow}` });
                currentRow++;

                XLSX.utils.sheet_add_aoa(worksheet, [["Thuế GTGT (8%)"]], { origin: `F${currentRow}` });
                XLSX.utils.sheet_add_aoa(worksheet, [[tax]], { origin: `I${currentRow}` });
                currentRow++;

                XLSX.utils.sheet_add_aoa(worksheet, [["Tổng tiền thanh toán"]], { origin: `F${currentRow}` });
                XLSX.utils.sheet_add_aoa(worksheet, [[grandTotal]], { origin: `I${currentRow}` });
                currentRow += 2;

                // Replace the existing signature section with this code:
                // --- Thêm ghi chú và thông tin thanh toán ---

                XLSX.utils.sheet_add_aoa(worksheet, [["Ghi chú:"]], { origin: `A${currentRow}` });
                currentRow++;

                XLSX.utils.sheet_add_aoa(worksheet, [["- Giá chưa bao gồm thuế VAT (8%)"]], { origin: `A${currentRow}` });
                currentRow++;

                XLSX.utils.sheet_add_aoa(worksheet, [["- Miễn phí vận chuyển nội thành Hà Nội với những đơn hàng có giá trị từ 1,5 triệu đồng."]], { origin: `A${currentRow}` });
                currentRow++;

                XLSX.utils.sheet_add_aoa(worksheet, [["- Báo giá này có hiệu lực trong 07 ngày kể từ ngày lập."]], { origin: `A${currentRow}` });
                currentRow += 2;

                XLSX.utils.sheet_add_aoa(worksheet, [["Thông tin thanh toán:"]], { origin: `A${currentRow}` });
                currentRow++;

                XLSX.utils.sheet_add_aoa(worksheet, [["· Ngân hàng Quân Đội (MB Bank) - CN Gia Lâm. STK: 6666.939.8888 - Đỗ Trọng Nghĩa"]], { origin: `A${currentRow}` });
                currentRow++;

                XLSX.utils.sheet_add_aoa(worksheet, [["· Ngân hàng VPBank - CN Thăng Long – STK: 156939258 - Công ty TNHH Sản xuất và Dịch vụ Đức Thành (DUC THANH SERPRO)"]], { origin: `A${currentRow}` });
                currentRow += 2;

                // --- Thêm phần chữ ký ---
                XLSX.utils.sheet_add_aoa(worksheet, [["Người lập"]], { origin: `C${currentRow}` });
                XLSX.utils.sheet_add_aoa(worksheet, [["Giám đốc"]], { origin: `G${currentRow}` });
                currentRow++;

                XLSX.utils.sheet_add_aoa(worksheet, [["(Ký, họ tên)"]], { origin: `C${currentRow}` });
                XLSX.utils.sheet_add_aoa(worksheet, [["(Ký, họ tên, đóng dấu)"]], { origin: `G${currentRow}` });
                currentRow += 4;

                // Generate the Excel file
                const excelOutput = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([excelOutput], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const fileName = `Bang_bao_gia_${orderNumber}.xlsx`;
                saveAs(blob, fileName);
            } catch (error) {
                console.error('Error exporting to Excel template:', error);
                alert('Có lỗi khi xuất file Excel. Vui lòng thử lại sau.');
            } finally {
                // Hide loading indicator
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Khởi tạo trang
        async function initializePage() {
            // Lấy order ID từ tham số URL
            const orderId = getUrlParameter('id');

            if (!orderId) {
                document.getElementById('error-message').textContent = 'Không tìm thấy mã đơn hàng trong URL. Vui lòng kiểm tra lại đường dẫn.';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('loading').style.display = 'none';
                return;
            }

            try {
                // Lấy đơn hàng theo ID
                const order = await fetchOrderById(orderId);
                await displayOrderData(order); // Chờ đợi hiển thị dữ liệu kèm truy vấn khách hàng
            } catch (error) {
                console.error('Failed to initialize page:', error);
                document.getElementById('error-message').textContent = 'Không thể tải dữ liệu đơn hàng. Vui lòng thử lại sau.';
                document.getElementById('error-message').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Chạy khi tài liệu đã tải xong
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>

</html>
